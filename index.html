<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙÙ€Ù€Ù€ÙˆÙÙ€Ù€Ù€</title>
    <style>


@font-face {
    font-family: 'Byt';
    src: url('byt-Regular.otf') format('opentype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}

@font-face {
    font-family: 'Larken';
    src: url('Larken-Regular.otf') format('opentype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}
        :root {
            --primary-color: #44556A;
            --secondary-color: #44556A;
            --success-color: #96BCB7;
            --warning-color: #D97E5C;
            --danger-color: #D97E5C;
            --dark-color: #1f2937;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --border-color: #e5e7eb;
            --text-color: #374151;
            --sidebar-bg: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
    font-family: 'Byt', 'Larken', 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.5;
        padding-bottom: 60px; /* Space for footer */
        }


.card-title, .stat-number, .btn, .menu-item, .form-label, .form-input {
    font-family: 'Byt', 'Larken', 'Segoe UI', Tahoma, Arial, sans-serif;
}
        /* Footer Styles */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #44556A;
            color: white;
            padding: 0.5rem;
            text-align: center;
            z-index: 100;
            border-top: 2px solid #91B9B4;
        }

        .footer a {
            color: #91B9B4;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }


        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;  
            max-width: 400px;
            text-align: center;
        }

        .login-form h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .login-form input, .login-form select {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .login-form button {
            width: 100%;
            padding: 0.75rem;
            background: #96BCB7;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        .login-form button:hover {
            background: #8EB4AF;
        }

        .login-error {
            color: var(--danger-color);
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* Header */
        .header {
            background: #44556A;
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
            margin: 0 auto;
        }

        .logo {
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: '';
            width: 210px;
            height: 80px;
            background-image: url('r.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: right;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-right: auto;
        }

        /* Responsive Header */
        @media (max-width: 768px) {
            .header { padding: 0.5rem 1rem; }
            .logo { right: 1rem; }
            .logo::before { width: 80px; height: 30px; }
            .user-info { flex-direction: column; gap: 0.5rem; font-size: 0.8rem; }
            .user-info .btn { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
        }

        @media (max-width: 480px) {
            .logo::before { width: 60px; height: 25px; }
            .user-info { font-size: 0.7rem; }
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 80px;
            right: 0;
            width: 280px;
            height: calc(100vh - 80px);
            background: #44556A;
            color: white;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .sidebar-menu { padding: 1rem 0; }

        .menu-item {
            display: block;
            padding: 1rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: right;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 1px solid #55687E;
        }

        .menu-item:hover, .menu-item.active {
            background: #91B9B4;
            color: white;
            padding-right: 2rem;
        }

        .menu-item i { margin-left: 0.5rem; width: 20px; }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            margin-right: 280px;
            padding: 2rem;
            min-height: calc(100vh - 80px);
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease;
            flex-direction: column;
        }

        .page-section.active { display: flex; }

        #settings, #import {
            width: 1420px;
            max-width: none;
            overflow-x: auto;
        }

        #settings .card, #import .card {
            width: 100%;
            min-width: 1250px;
            height: auto;
            margin-bottom: 2rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(45deg, #f8fafc, #f1f5f9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .card-body { padding: 1.5rem; }

        /* Consistent Filters Container */
        .filters-container {

            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        /* Consistent Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

       .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.form-label {
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-input {
    padding: 0.75rem;
    border-radius: 8px;
    border: 2px solid #ccc;
    font-size: 1rem;
}

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-input[readonly] {
            background-color: #f1f5f9;
            border-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-input[readonly]:focus {
            border-color: #d1d5db;
            box-shadow: none;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 1rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-left: 3rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-secondary {
            background: #91B9B4;
            color: white;
        }

        .btn-primary:hover, .btn-success:hover, .btn-warning:hover, .btn-danger:hover, .btn-secondary:hover {
            background: #7da8a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(145, 185, 180, 0.3);
        }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            font-size: 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background: var(--white);
        }

        .search-btn {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: #91B9B4;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 800px;
        }

        .table th {
            background: #44556A;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
.table thead th:first-child {
    border-top-right-radius: 8px;
}

        .table th:last-child {
            border-top-left-radius: 8px;

        }

        .table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .table tbody tr:hover { background: #f8fafc; }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover { transform: translateY(-5px); }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .stat-sublabel {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-primary { background: #dbeafe; color: #1e40af; }
        .badge-secondary { background: #f3f4f6; color: #374151; }

        /* Sources with Notes Status Badges */
        .status-bib-mismatch { background: #fecaca; color: #991b1b; }
        .status-no-chip { background: #fed7d7; color: #9b2c2c; }
        .status-inappropriate { background: #fbb6ce; color: #97266d; }
        .status-incorrect-classification { background: #fde68a; color: #92400e; }
        .status-not-for-loan { background: #c7d2fe; color: #3730a3; }
        .status-old-edition { background: #d1d5db; color: #374151; }
        .status-duplicate { background: #fbcfe8; color: #be185d; }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid;
        }

        .alert-success { background: #ecfdf5; border-color: #44556A; color: #065f46; }
        .alert-warning { background: #fffbeb; border-color: #f59e0b; color: #92400e; }
        .alert-danger { background: #fef2f2; border-color: #ef4444; color: #991b1b; }
        .alert-info { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }

        /* File Upload */
        .file-upload {
            border: 2px dashed #91B9B4;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #91B9B4;
            background: #f1f5f9;
        }

        .file-upload input { display: none; }

        /* Barcode Scanner */
        .scanner-container {
            text-align: center;
            padding: 2rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .scanner-input {
            font-size: 1.5rem;
            padding: 1rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .scanner-input[readonly] {
            background-color: #f1f5f9;
            border-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }

        .scanner-input[readonly]:focus {
            border-color: #d1d5db;
            box-shadow: none;
        }

        /* Library Type Indicators */
        .library-type {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .library-main { background: #dbeafe; color: #1e40af; }
        .library-youth { background: #fef3c7; color: #92400e; }
        .library-child { background: #fce7f3; color: #be185d; }

        /* Subject Classification Display */
        .subject-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #0c4a6e;
        }

        /* Thematic Classification Display */
        .thematic-classification {
            background: #f0fdf4;
            border: 1px solid #16a34a;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #15803d;
            font-weight: 500;
        }

        /* Date Range Selector */
        .date-range-selector {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(100%);
                width: 100%;
            }

            .sidebar.mobile-open { transform: translateX(0); }

            .main-content {
                margin-right: 0;
                padding: 1rem;
            }

            .header-content { padding: 0 1rem; }
            .form-grid, .stats-grid, .filters-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; align-items: stretch; }
            .stat-number { font-size: 2rem; }
            .table { font-size: 0.8rem; min-width: 600px; }
            .table th, .table td { padding: 0.5rem; }
            .scanner-input { font-size: 1.2rem; }
        }

        @media (max-width: 480px) {
            .main-content { padding: 0.5rem; }
            .card { margin-bottom: 1rem; }
            .card-header, .card-body { padding: 1rem; }
            .stat-number { font-size: 1.8rem; }
            .form-input, .search-input { font-size: 16px; }

        }

        /* Print Styles */
        @media print {
            .sidebar, .header, .btn, .footer { display: none !important; }
            .main-content { margin: 0; padding: 0; }
        }


        /* Role-based visibility */
        .admin-only, .supervisor-only, .manager-only { display: none; }
        .admin-mode .admin-only { display: inline-flex; }
        .supervisor-mode .supervisor-only { display: inline-flex; }
        .manager-mode .manager-only, .admin-mode .manager-only { display: inline-flex; }

        /* Hide sections */
        #members { display: none !important; }
        .admin-mode #members.active, .supervisor-mode #members.active, .manager-mode #members.active { display: flex !important; }
        #settings:not(.active) { display: none !important; }
        .admin-mode #settings.active .admin-only, .supervisor-mode #settings.active .supervisor-only { display: block; }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* BIB Input validation */
        .bib-input.invalid {
            border-color: var(--danger-color);
            background-color: #fee2e2;
        }

        .bib-error {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .bib-error.show { display: block; }

        .mobile-menu-btn { display: none; }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                margin-left: 1rem;
            }
        }

        /* User Stats Card */
        .user-stats-card {
            background: #44556A;
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .user-stats-card .stat-number {
            color: white;
            font-size: 2rem;
        }

        .user-stats-card .stat-label { color: rgba(255,255,255,0.9); }

        /* Membership number styling */
        .membership-number-display {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #374151;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        /* Branch selector */
        .branch-selector {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .branch-selector h4 {
            color: #0c4a6e;
            margin-bottom: 0.5rem;
        }

        /* Special Notes Highlighting */
        .notes-highlight {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            color: #92400e;
        }

        /* Enhanced Edit Modal Styles */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .edit-form h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Delete Confirmation Modal */
        .delete-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .delete-confirmation-modal.active {
            display: flex;
        }

        .delete-confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .delete-confirmation-content h3 {
            color: var(--danger-color);
            margin-bottom: 1rem;
        }

        .delete-confirmation-content p {
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .delete-reason-group {
            margin: 1rem 0;
            text-align: right;
        }

        .delete-reason-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .delete-reason-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        /* NOT BORROWABLE - Sources with Special Notes */
        .not-borrowable {
            background: #fee2e2 !important;
            border-left: 4px solid #ef4444;
        }

        .not-borrowable .notes-highlight {
            background: #dc2626;
            color: white;
            font-weight: bold;
        }

       /* Performance Panel - Match Recent Loans Styling */
.performance-panel {
    display: flex;
    flex-direction: column;
}


.performance-panel .card-header {
   padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(45deg, #f8fafc, #f1f5f9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;

.performance-panel .card-body {
    .card-body { padding: 1.5rem; }
}

 .performance-panel .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

.performance-panel .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
}

.performance-panel .table th {
    background-color: #44556A;
    color: white;
}

    </style>
</head>

<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-form">
            <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</h2>
            <form id="loginForm" onsubmit="authenticateUser(event)">
                <input type="text" id="membershipNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©" required>
                <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <button type="submit">Ø¯Ø®ÙˆÙ„</button>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: #666; text-align: right;">
                   
                </div>
            </form>
            <div id="loginError" class="login-error" style="display: none;"></div>
        </div>
    </div>

    <!-- Edit Source Modal -->
    <div id="editSourceModal" class="edit-modal">
        <div class="edit-form">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ¯Ø±</h3>
            <form id="editSourceForm" onsubmit="updateSource(event)">
                <input type="hidden" id="editSourceId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… BIB * (14 Ø±Ù‚Ù…)</label>
                        <input type="text" class="form-input bib-input" id="editSourceBib" required placeholder="Ù…Ø«Ø§Ù„: 01234567890123" maxlength="14" oninput="validateBibNumber(this)">
                        <div class="bib-error">Ø±Ù‚Ù… BIB ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¶Ø¨Ø·</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
                        <input type="text" class="form-input" id="editSourceTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…Ø¤Ù„Ù *</label>
                        <input type="text" class="form-input" id="editSourceAuthor" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù†Ø§Ø´Ø±</label>
                        <input type="text" class="form-input" id="editSourcePublisher">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</label>
                        <input type="number" class="form-input" id="editSourceYear" min="1900" max="2030">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù„ØºØ©</label>
                        <select class="form-input form-select" id="editSourceLanguage">
                            <option value="ara">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="eng">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                            <option value="fre">Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</option>
                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ (Dewey Classification)</label>
                        <input type="text" class="form-input" id="editSourceDewey" onchange="updateEditDeweyInfo(this)">
                        <div id="editDeweyInfo" class="subject-info" style="display: none;"></div>
                        <div id="editThematicClassification" class="thematic-classification" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®</label>
                        <input type="number" class="form-input" id="editSourceCopies" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                        <select class="form-input form-select" id="editSourceLibrary">
                            <option value="Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</option>
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</label>
                        <select class="form-input form-select" id="editSourceSupply">
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1</option>
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2</option>
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3</option>
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4</option>
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5</option>
                            <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6</option>
                            <option value="Ø§Ù„ÙˆØ²Ø§Ø±Ø©">Ø§Ù„ÙˆØ²Ø§Ø±Ø©</option>
                            <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                            <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±</label>
                        <select class="form-input form-select" id="editSourceStatus">
                            <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option>
                            <option value="Ù…Ø³ØªØ¹Ø§Ø±">Ù…Ø³ØªØ¹Ø§Ø±</option>
                            <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                            <option value="BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</option>
                            <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©</option>
                            <option value="Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù</option>
                            <option value="Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦">Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦</option>
                            <option value="ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©">ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©</option>
                            <option value="Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…">Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…</option>
                            <option value="Ù…ÙƒØ±Ø±">Ù…ÙƒØ±Ø±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                        <input type="text" class="form-input" id="editSourceLocation">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯</label>
                        <input type="date" class="form-input" id="editSourceSupplyDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø±Ù</label>
                        <input type="text" class="form-input" id="editSourceShelf">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-input" id="editSourceNotes" rows="3"></textarea>
                </div>
                <div style="text-align: center; margin-top: 2rem; gap: 1rem; display: flex; justify-content: center;">
                    <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditSourceModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="edit-modal">
        <div class="edit-form">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ</h3>
            <form id="editMemberForm" onsubmit="updateMember(event)">
                <input type="hidden" id="editMemberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© *</label>
                        <input type="text" class="form-input" id="editMembershipNumber" required readonly>
                        <small style="color: #666; font-size: 0.9rem;">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
                        <input type="password" class="form-input" id="editMemberPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                        <input type="text" class="form-input" id="editMemberName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© *</label>
                        <select class="form-input form-select" id="editMemberType" required>
                            <option value="Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                            <option value="Ù…Ø´Ø±Ù ÙØ±Ø¹">Ù…Ø´Ø±Ù ÙØ±Ø¹</option>
                            <option value="Ø£Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø©">Ø£Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„ÙØ±Ø¹ *</label>
                        <select class="form-input form-select" id="editMemberBranch" required>
                            <option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                            <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                            <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                            <option value="Ø­Ø§Ø¦Ù„">Ø­Ø§Ø¦Ù„</option>
                            <option value="Ù†Ø¬Ø±Ø§Ù†">Ù†Ø¬Ø±Ø§Ù†</option>
                            <option value="Ø¬Ø§Ø²Ø§Ù†">Ø¬Ø§Ø²Ø§Ù†</option>
                            <option value="Ø³ÙƒØ§ÙƒØ§">Ø³ÙƒØ§ÙƒØ§</option>
                            <option value="Ø¨Ø±ÙŠØ¯Ø©">Ø¨Ø±ÙŠØ¯Ø©</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 2rem; gap: 1rem; display: flex; justify-content: center;">
                    <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditMemberModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal with Reason -->
    <div id="deleteConfirmationModal" class="delete-confirmation-modal">
        <div class="delete-confirmation-content">
            <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p id="deleteConfirmationText">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ</p>
            <div class="delete-reason-group" id="deleteReasonGroup" style="display: none;">
                <label class="form-label">Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù *</label>
                <select class="form-input form-select" id="deleteReason" required>
                    <option value="">Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù</option>
                    <option value="BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</option>
                    <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©</option>
                    <option value="Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù</option>
                    <option value="Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦">Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦</option>
                    <option value="ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©">ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©</option>
                    <option value="Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù…Ù„Ù Ø§Ù„ØªÙˆØ±ÙŠØ¯">Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù…Ù„Ù Ø§Ù„ØªÙˆØ±ÙŠØ¯</option>
                    <option value="Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…">Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…</option>
                    <option value="Ù…ÙƒØ±Ø±">Ù…ÙƒØ±Ø±</option>
                    <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                    <option value="Ù…ÙÙ‚ÙˆØ¯">Ù…ÙÙ‚ÙˆØ¯</option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>
            <div style="margin-top: 1.5rem; gap: 1rem; display: flex; justify-content: center;">
                <button class="btn btn-danger" onclick="confirmDelete()">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
                <button class="btn btn-secondary" onclick="closeDeleteConfirmationModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo"></div>
            <div class="user-info">
                <span id="currentUser">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ù…Ø³ØªØ®Ø¯Ù…</span>
                <span id="currentBranch" style="font-size: 0.9rem; opacity: 0.8;"></span>
                <button class="btn btn-secondary" onclick="exportCurrentPageData()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="btn btn-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-menu">
            <button class="menu-item active" onclick="showSection('dashboard')">
                ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </button>
            <button class="menu-item" onclick="showSection('sources')">
                ğŸ“– Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø±
            </button>
            <button class="menu-item admin-only supervisor-only manager-only" onclick="showSection('members')">
                ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
            </button>
            <button class="menu-item" onclick="showSection('circulation')">
                ğŸ”„ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
            </button>
            <button class="menu-item" onclick="showSection('search')">
                ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
            </button>
            <button class="menu-item" onclick="showSection('reports')">
                ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            </button>
            <button class="menu-item" onclick="showSection('import')">
                ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="menu-item admin-only supervisor-only" onclick="showSection('settings')">
                âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="page-section active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                    <div class="filters-container">
                        <div class="filters-grid">
                            <div class="form-group">
                                <label class="form-label">ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø§Ø·</label>
                                <select class="form-input form-select" id="activityPeriod" onchange="updateDashboard()">
                                    <option value="daily">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ</option>
                                    <option value="weekly">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
                                    <option value="monthly">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                                <select class="form-input form-select" id="libraryTypeFilter" onchange="updateDashboard()">
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª</option>
                                    <option value="main">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                                    <option value="youth">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</option>
                                    <option value="child">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„</option>
                                </select>
                            </div>
                            <!-- Branch Selector for Admin/Manager -->
                            <div class="form-group admin-only manager-only" id="dashboardBranchFilterGroup">
                                <label class="form-label">Ø§Ù„ÙØ±Ø¹</label>
                                <select class="form-input form-select" id="dashboardBranchFilter" onchange="updateDashboard()">
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                                    <option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                                    <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                                    <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                                    <option value="Ø­Ø§Ø¦Ù„">Ø­Ø§Ø¦Ù„</option>
                                    <option value="Ù†Ø¬Ø±Ø§Ù†">Ù†Ø¬Ø±Ø§Ù†</option>
                                    <option value="Ø¬Ø§Ø²Ø§Ù†">Ø¬Ø§Ø²Ø§Ù†</option>
                                    <option value="Ø³ÙƒØ§ÙƒØ§">Ø³ÙƒØ§ÙƒØ§</option>
                                    <option value="Ø¨Ø±ÙŠØ¯Ø©">Ø¨Ø±ÙŠØ¯Ø©</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Personal Stats -->
            <div class="user-stats-card" id="userStatsCard">
                <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userTodayBorrowings">0</div>
                        <div class="stat-label">Ø¥Ø¹Ø§Ø±Ø§ØªÙŠ Ø§Ù„ÙŠÙˆÙ…</div>
                    </div>
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userWeekBorrowings">0</div>
                        <div class="stat-label">Ø¥Ø¹Ø§Ø±Ø§ØªÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                    </div>
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userMonthBorrowings">0</div>
                        <div class="stat-label">Ø¥Ø¹Ø§Ø±Ø§ØªÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
                    </div>
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userTotalBorrowings">0</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ø¹Ø§Ø±Ø§ØªÙŠ</div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSources">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø±</div>
                    <div class="stat-sublabel" id="sourcesByLibrary"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMembers">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
                    <div class="stat-sublabel" id="newMembersCount"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="borrowedSources">0</div>
                    <div class="stat-label">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
                    <div class="stat-sublabel" id="newBorrowingsCount"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mainLibrarySources">0</div>
                    <div class="stat-label">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                    <div class="stat-sublabel">Ù…ØµØ¯Ø± Ù…ØªØ§Ø­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="youthLibrarySources">0</div>
                    <div class="stat-label">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</div>
                    <div class="stat-sublabel">Ù…ØµØ¯Ø± Ù…ØªØ§Ø­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="childLibrarySources">0</div>
                    <div class="stat-label">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„</div>
                    <div class="stat-sublabel">Ù…ØµØ¯Ø± Ù…ØªØ§Ø­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sourcesWithSpecialNotes">0</div>
                    <div class="stat-label">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
                    <div class="stat-sublabel">ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
                </div>
            </div>

            <!-- Admin/Supervisor/Manager Only - Employee Performance -->
            <div class="card admin-only supervisor-only manager-only performance-panel">
                <div class="card-header">
                    <h3 class="card-title">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                    <th>Ø§Ù„ÙØ±Ø¹</th>
                                    <th>Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</th>
                                    <th>Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
                                    <th>Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="employeePerformance">
                                <tr>
                                    <td colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card recent-loans-panel">
                <div class="card-header">
                    <h3 class="card-title">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
                                    <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                    <th>Ø§Ù„ÙØ±Ø¹</th>
                                </tr>
                            </thead>
                            <tbody id="recentBorrowings">
                                <tr>
                                    <td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª Ø­Ø¯ÙŠØ«Ø©</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sources Management Section -->
        <section id="sources" class="page-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø±</h2>
                    <div>
                        <button class="btn btn-primary admin-only supervisor-only" onclick="showAddSourceForm()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ¯Ø± Ø¬Ø¯ÙŠØ¯</button>
                        <button class="btn btn-warning admin-only supervisor-only" onclick="showDeleteBySourceModal()">ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø³Ø¨ Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</button>
                        <button class="btn btn-danger admin-only" onclick="deleteAllSources()">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="filters-container">
                        <div class="filters-grid">
                            <div class="form-group">
                                <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±</label>
                                <select class="form-input form-select" id="sourceStatusFilter" onchange="filterSources()">
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±</option>
                                    <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option>
                                    <option value="Ù…Ø³ØªØ¹Ø§Ø±">Ù…Ø³ØªØ¹Ø§Ø±</option>
                                    <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                                    <option value="special_notes">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
                                    <option value="Ù…Ø­Ø°ÙˆÙ">Ù…Ø­Ø°ÙˆÙ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                                <select class="form-input form-select" id="sourceLibraryFilter" onchange="filterSources()">
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª</option>
                                    <option value="main">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                                    <option value="youth">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</option>
                                    <option value="child">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</label>
                                <select class="form-input form-select" id="sourceSupplyFilter" onchange="filterSources()">
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±</option>
                                    <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1</option>
                                    <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2</option>
                                    <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3</option>
                                    <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4</option>
                                    <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5</option>
                                    <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6</option>
                                    <option value="Ø§Ù„ÙˆØ²Ø§Ø±Ø©">Ø§Ù„ÙˆØ²Ø§Ø±Ø©</option>
                                    <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                                    <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                                </select>
                            </div>
                            <!-- Branch Selector for Admin/Manager -->
                            <div class="form-group admin-only manager-only" id="sourcesBranchFilterGroup">
                                <label class="form-label">Ø§Ù„ÙØ±Ø¹</label>
                                <select class="form-input form-select" id="sourcesBranchFilter" onchange="filterSources()">
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                                    <option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                                    <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                                    <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                                    <option value="Ø­Ø§Ø¦Ù„">Ø­Ø§Ø¦Ù„</option>
                                    <option value="Ù†Ø¬Ø±Ø§Ù†">Ù†Ø¬Ø±Ø§Ù†</option>
                                    <option value="Ø¬Ø§Ø²Ø§Ù†">Ø¬Ø§Ø²Ø§Ù†</option>
                                    <option value="Ø³ÙƒØ§ÙƒØ§">Ø³ÙƒØ§ÙƒØ§</option>
                                    <option value="Ø¨Ø±ÙŠØ¯Ø©">Ø¨Ø±ÙŠØ¯Ø©</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="resetSourceFilters()">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
                            </div>
                        </div>
                    </div>

                    <div class="search-container">
                        <input type="text" class="search-input" id="sourceSearch" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø±... (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ù…Ø¤Ù„ÙØŒ Ø±Ù‚Ù… BIBØŒ Ø§Ù„ØªØµÙ†ÙŠÙ)">
                        <button class="search-btn" onclick="searchSources()">ğŸ”</button>
                    </div>

                    <div id="addSourceForm" style="display: none;" class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ¯Ø± Ø¬Ø¯ÙŠØ¯</h3>
                        </div>
                        <div class="card-body">
                            <form id="sourceForm" onsubmit="addSource(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Ø±Ù‚Ù… BIB * (14 Ø±Ù‚Ù…)</label>
                                        <input type="text" class="form-input bib-input" name="bibNumber" required placeholder="Ù…Ø«Ø§Ù„: 01234567890123" maxlength="14" oninput="validateBibNumber(this)">
                                        <div class="bib-error">Ø±Ù‚Ù… BIB ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¶Ø¨Ø·</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
                                        <input type="text" class="form-input" name="title" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ø§Ù„Ù…Ø¤Ù„Ù *</label>
                                        <input type="text" class="form-input" name="author" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ø§Ù„Ù†Ø§Ø´Ø±</label>
                                        <input type="text" class="form-input" name="publisher">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</label>
                                        <input type="number" class="form-input" name="publishYear" min="1900" max="2030">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ø§Ù„Ù„ØºØ©</label>
                                        <select class="form-input form-select" name="language">
                                            <option value="ara">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                            <option value="eng">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                                            <option value="fre">Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</option>
                                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ (Dewey Classification)</label>
                                        <input type="text" class="form-input" name="deweyClassification" onchange="updateDeweyInfo(this)">
                                        <div id="deweyInfo" class="subject-info" style="display: none;"></div>
                                        <div id="thematicClassification" class="thematic-classification" style="display: none;"></div>
</div>
                                   <div class="form-group">
                                       <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®</label>
                                       <input type="number" class="form-input" name="copiesCount" min="1" value="1">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                                       <select class="form-input form-select" name="library" id="librarySelect" onchange="updateLibraryType()">
                                           <option value="Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</option>
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</label>
                                       <select class="form-input form-select" name="source">
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1</option>
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2</option>
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3</option>
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4</option>
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5</option>
                                           <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6</option>
                                           <option value="Ø§Ù„ÙˆØ²Ø§Ø±Ø©">Ø§Ù„ÙˆØ²Ø§Ø±Ø©</option>
                                           <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                                           <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±</label>
                                       <select class="form-input form-select" name="status">
                                           <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option>
                                           <option value="Ù…Ø³ØªØ¹Ø§Ø±">Ù…Ø³ØªØ¹Ø§Ø±</option>
                                           <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                                           <option value="BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</option>
                                           <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©</option>
                                           <option value="Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù</option>
                                           <option value="Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦">Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦</option>
                                           <option value="ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©">ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©</option>
                                           <option value="Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…">Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…</option>
                                           <option value="Ù…ÙƒØ±Ø±">Ù…ÙƒØ±Ø±</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                                       <input type="text" class="form-input" name="location">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯</label>
                                       <input type="date" class="form-input" name="supplyDate">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø±Ù</label>
                                       <input type="text" class="form-input" name="shelfNumber">
                                   </div>
                               </div>
                               <div class="form-group">
                                   <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                   <textarea class="form-input" name="notes" rows="3"></textarea>
                               </div>
                               <div style="text-align: center; margin-top: 2rem;">
                                   <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ¯Ø±</button>
                                   <button type="button" class="btn btn-secondary" onclick="hideAddSourceForm()">Ø¥Ù„ØºØ§Ø¡</button>
                               </div>
                           </form>
                       </div>
                   </div>

                   <!-- Delete by Source Modal -->
                   <div id="deleteBySourceModal" style="display: none;" class="card">
                       <div class="card-header">
                           <h3 class="card-title">Ø­Ø°Ù Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø­Ø³Ø¨ Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</h3>
                       </div>
                       <div class="card-body">
                           <div class="form-group">
                               <label class="form-label">Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù„Ù„Ø­Ø°Ù</label>
                               <select class="form-input form-select" id="deleteSourceSelect">
                                   <option value="">Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</option>
                                   <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1</option>
                                   <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 2</option>
                                   <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 3</option>
                                   <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 4</option>
                                   <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 5</option>
                                   <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 6</option>
                                   <option value="Ø§Ù„ÙˆØ²Ø§Ø±Ø©">Ø§Ù„ÙˆØ²Ø§Ø±Ø©</option>
                                   <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                                   <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label class="form-label">Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù *</label>
                               <select class="form-input form-select" id="deleteBulkReason" required>
                                   <option value="">Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù</option>
                                   <option value="BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</option>
                                   <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©</option>
                                   <option value="Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù</option>
                                   <option value="Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦">Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦</option>
                                   <option value="ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©">ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©</option>
                                   <option value="Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù…Ù„Ù Ø§Ù„ØªÙˆØ±ÙŠØ¯">Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù…Ù„Ù Ø§Ù„ØªÙˆØ±ÙŠØ¯</option>
                                   <option value="Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…">Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…</option>
                                   <option value="Ù…ÙƒØ±Ø±">Ù…ÙƒØ±Ø±</option>
                                   <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                                   <option value="Ù…ÙÙ‚ÙˆØ¯">Ù…ÙÙ‚ÙˆØ¯</option>
                                   <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                               </select>
                           </div>
                           <div style="text-align: center; margin-top: 1rem;">
                               <button class="btn btn-danger" onclick="deleteBySource()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
                               <button class="btn btn-secondary" onclick="hideDeleteBySourceModal()">Ø¥Ù„ØºØ§Ø¡</button>
                           </div>
                       </div>
                   </div>

                   <div class="table-container">
                       <table class="table">
                           <thead>
                               <tr>
                                   <th>Ø§Ù„Ø±Ù‚Ù…</th>
                                   <th>BIB</th>
                                   <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                   <th>Ø§Ù„Ù…Ø¤Ù„Ù</th>
                                   <th>Ø§Ù„Ù†Ø§Ø´Ø±</th>
                                   <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</th>
                                   <th>Ø§Ù„Ù„ØºØ©</th>
                                   <th>ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ</th>
                                   <th>Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠ</th>
                                   <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®</th>
                                   <th>Ø§Ù„Ù…ÙƒØªØ¨Ø©</th>
                                   <th>Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</th>
                                   <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯</th>
                                   <th>Ø±Ù‚Ù… Ø§Ù„Ø±Ù</th>
                                   <th>Ø§Ù„ÙØ±Ø¹</th>
                                   <th style="border-right: 1px solid rgba(255,255,255,0.1);">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±</th>
<th class="admin-only supervisor-only table-actions" style="border-right: none;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                               </tr>
                           </thead>
                           <tbody id="sourcesTable">
                               <tr>
                                   <td colspan="17">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯</td>
                               </tr>
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </section>

       <!-- Members Management Section -->
       <section id="members" class="page-section admin-only supervisor-only manager-only">
           <div class="card">
               <div class="card-header">
                   <h2 class="card-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
                   <button class="btn btn-primary admin-only supervisor-only" onclick="showAddMemberForm()">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</button>
               </div>
               <div class="card-body">
                   <!-- Branch Selector for Admin/Manager -->
                   <div class="filters-container">
                       <div class="filters-grid">
                           <div class="form-group admin-only manager-only" id="membersBranchFilterGroup">
                               <label class="form-label">Ø§Ù„ÙØ±Ø¹</label>
                               <select class="form-input form-select" id="membersBranchFilter" onchange="filterMembers()">
                                   <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                                   <option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                                   <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                                   <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                                   <option value="Ø­Ø§Ø¦Ù„">Ø­Ø§Ø¦Ù„</option>
                                   <option value="Ù†Ø¬Ø±Ø§Ù†">Ù†Ø¬Ø±Ø§Ù†</option>
                                   <option value="Ø¬Ø§Ø²Ø§Ù†">Ø¬Ø§Ø²Ø§Ù†</option>
                                   <option value="Ø³ÙƒØ§ÙƒØ§">Ø³ÙƒØ§ÙƒØ§</option>
                                   <option value="Ø¨Ø±ÙŠØ¯Ø©">Ø¨Ø±ÙŠØ¯Ø©</option>
                               </select>
                           </div>
                       </div>
                   </div>

                   <div class="search-container">
                       <input type="text" class="search-input" id="memberSearch" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡... (Ø§Ù„Ø§Ø³Ù…ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©)">
                       <button class="search-btn" onclick="searchMembers()">ğŸ”</button>
                   </div>

                   <div id="addMemberForm" style="display: none;" class="card" style="margin-bottom: 2rem;">
                       <div class="card-header">
                           <h3 class="card-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</h3>
                       </div>
                       <div class="card-body">
                           <form id="memberForm" onsubmit="addMember(event)">
                               <div class="form-grid">
                                   <div class="form-group">
                                       <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© *</label>
                                       <input type="text" class="form-input" name="membershipNumber" required id="membershipNumberInput" placeholder="Ù…Ø«Ø§Ù„: LIB001">
                                       <small style="color: #666; font-size: 0.9rem;">Ø±Ù‚Ù… Ø¹Ø¶ÙˆÙŠØ© ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</small>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
                                       <input type="password" class="form-input" name="userPassword" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©">
                                       <small style="color: #666; font-size: 0.9rem;">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© ÙˆØ¢Ù…Ù†Ø©</small>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                                       <input type="text" class="form-input" name="fullName" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© *</label>
                                       <select class="form-input form-select" name="memberType" required>
                                           <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                           <option value="Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                                           <option value="Ù…Ø´Ø±Ù ÙØ±Ø¹">Ù…Ø´Ø±Ù ÙØ±Ø¹</option>
                                           <option value="Ø£Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø©">Ø£Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø©</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">Ø§Ù„ÙØ±Ø¹ *</label>
                                       <select class="form-input form-select" name="branch" required>
                                           <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
                                           <option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                                           <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
                                           <option value="Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©">Ø£Ø­Ø¯ Ø±ÙÙŠØ¯Ø©</option>
                                           <option value="Ø­Ø§Ø¦Ù„">Ø­Ø§Ø¦Ù„</option>
                                           <option value="Ù†Ø¬Ø±Ø§Ù†">Ù†Ø¬Ø±Ø§Ù†</option>
                                           <option value="Ø¬Ø§Ø²Ø§Ù†">Ø¬Ø§Ø²Ø§Ù†</option>
                                           <option value="Ø³ÙƒØ§ÙƒØ§">Ø³ÙƒØ§ÙƒØ§</option>
                                           <option value="Ø¨Ø±ÙŠØ¯Ø©">Ø¨Ø±ÙŠØ¯Ø©</option>
                                       </select>
                                   </div>
                               </div>
                               <div style="text-align: center; margin-top: 2rem;">
                                   <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ø¶Ùˆ</button>
                                   <button type="button" class="btn btn-secondary" onclick="hideAddMemberForm()">Ø¥Ù„ØºØ§Ø¡</button>
                               </div>
                           </form>
                       </div>
                   </div>

                   <div class="table-container">
                       <table class="table">
                           <thead>
                               <tr>
                                   <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                                   <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                                   <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                                   <th style="border-right: 1px solid rgba(255,255,255,0.1);">Ø§Ù„ÙØ±Ø¹</th>
                                   <th class="admin-only supervisor-only" style="border-right: 1px solid rgba(255,255,255,0.1);">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                               </tr>
                           </thead>
                           <tbody id="membersTable">
                               <tr>
                                   <td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</td>
                               </tr>
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </section>

       <!-- Circulation Section -->
       <section id="circulation" class="page-section">
           <div class="card">
               <div class="card-header">
                 <h2 class="card-title">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</h2>
                  <small style="color: #666;">Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©: Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</small>
              </div>
              <div class="card-body">
                  <div class="form-grid">
                      <div class="scanner-container">
                          <h3>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</h3>
                          <input type="text" class="scanner-input" id="memberBarcode" placeholder="Ø§Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø¶Ùˆ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©" onchange="loadMemberInfo()" readonly>
                          <div id="memberInfo" style="margin-top: 1rem;"></div>
                      </div>
                      <div class="scanner-container">
                          <h3>Ø§Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±</h3>
                          <input type="text" class="scanner-input" id="sourceBarcode" placeholder="Ø§Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… BIB" onchange="loadSourceInfo()">
                          <div id="sourceInfo" style="margin-top: 1rem;"></div>
                      </div>
                  </div>

                  <div style="text-align: center; margin: 2rem 0;">
                      <button class="btn btn-success" onclick="borrowSource()" id="borrowBtn" disabled>ğŸ“š Ø¥Ø¹Ø§Ø±Ø© Ø§Ù„Ù…ØµØ¯Ø±</button>
                      <button class="btn btn-warning" onclick="returnSource()" id="returnBtn" disabled>â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…ØµØ¯Ø±</button>
                      <button class="btn btn-secondary" onclick="clearCirculation()">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                  </div>

                  <div id="circulationResult" style="margin-top: 2rem;"></div>
              </div>
          </div>

          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
              </div>
              <div class="card-body">
                  <div class="table-container">
                      <table class="table">
                          <thead>
                              <tr>
                                  <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
                                  <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                                  <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©</th>
                                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</th>
                                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
                                  <th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                  <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                  <th>Ø§Ù„ÙØ±Ø¹</th>
                                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                              </tr>
                          </thead>
                          <tbody id="activeBorrowings">
                              <tr>
                                  <td colspan="9">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </section>

      <!-- Search Section -->
      <section id="search" class="page-section">
          <div class="card">
              <div class="card-header">
                  <h2 class="card-title">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
              </div>
              <div class="card-body">
                  <div class="form-grid">
                      <div class="form-group">
                          <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                          <input type="text" class="form-input" id="searchTitle">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ø§Ù„Ù…Ø¤Ù„Ù</label>
                          <input type="text" class="form-input" id="searchAuthor">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ø±Ù‚Ù… BIB</label>
                          <input type="text" class="form-input" id="searchBib">
                      </div>
                      <div class="form-group">
                          <label class="form-label">ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ</label>
                          <input type="text" class="form-input" id="searchDewey">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø± Ù…Ù†</label>
                          <input type="number" class="form-input" id="searchYearFrom">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰</label>
                          <input type="number" class="form-input" id="searchYearTo">
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                          <select class="form-input form-select" id="searchLibrary">
                              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª</option>
                              <option value="Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                              <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</option>
                              <option value="Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„</option>
                          </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                          <select class="form-input form-select" id="searchStatus">
                              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                              <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option>
                              <option value="Ù…Ø³ØªØ¹Ø§Ø±">Ù…Ø³ØªØ¹Ø§Ø±</option>
                              <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                          </select>
                      </div>
                  </div>
                  <div style="text-align: center; margin: 2rem 0;">
                      <button class="btn btn-primary" onclick="performAdvancedSearch()">ğŸ” Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…</button>
                      <button class="btn btn-secondary" onclick="clearSearch()">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
                  </div>

                  <div class="table-container">
                      <table class="table" id="searchResults" style="display: none;">
                          <thead>
                              <tr>
                                  <th>BIB</th>
                                  <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                  <th>Ø§Ù„Ù…Ø¤Ù„Ù</th>
                                  <th>Ø§Ù„Ù…ÙƒØªØ¨Ø©</th>
                                  <th>Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø±</th>
                                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                  <th>Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠ</th>
                                  <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                  <th>Ø§Ù„ÙØ±Ø¹</th>
                              </tr>
                          </thead>
                          <tbody id="searchResultsBody">
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </section>

      <!-- Reports Section -->
      <section id="reports" class="page-section">
          <div class="card">
              <div class="card-header">
                  <h2 class="card-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
              </div>
              <div class="card-body">
                  <!-- Date Range Selector -->
                  <div class="date-range-selector">
                      <h4>ğŸ—“ï¸ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h4>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                              <input type="date" class="form-input" id="reportStartDate">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                              <input type="date" class="form-input" id="reportEndDate">
                          </div>
                      </div>
                  </div>

                  <div class="form-grid">
                      <button class="btn btn-primary" onclick="generateDailyReport()">ğŸ“… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
                      <button class="btn btn-primary" onclick="generateWeeklyReport()">ğŸ“† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                      <button class="btn btn-primary" onclick="generateMonthlyReport()">ğŸ—“ï¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
                      <button class="btn btn-primary" onclick="generateSourcesReport()">ğŸ“š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
                      <button class="btn btn-primary admin-only supervisor-only manager-only" onclick="generateMembersReport()">ğŸ‘¥ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
                      <button class="btn btn-primary" onclick="generateBorrowingReport()">ğŸ”„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª</button>
                      <button class="btn btn-primary" onclick="generateLibraryTypeReport()">ğŸ›ï¸ ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
                      <button class="btn btn-primary" onclick="generateStatisticsReport()">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ Ø´Ø§Ù…Ù„</button>
                      <button class="btn btn-primary" onclick="generateReadingReport()">ğŸ“– ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</button>
                      <button class="btn btn-primary admin-only" onclick="generateDeletedSourcesReport()">ğŸ—‘ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</button>
                  </div>

                  <div id="reportResults" class="card" style="margin-top: 2rem; display: none;">
                      <div class="card-header">
                          <h3 class="card-title" id="reportTitle">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
                      </div>
                      <div class="card-body" id="reportContent">
                      </div>
                  </div>
              </div>
          </div>
      </section>

      <!-- Import Section -->
      <section id="import" class="page-section">
          <div class="card">
              <div class="card-header">
                  <h2 class="card-title">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
              </div>
              <div class="card-body">
                  <div class="card">
                      <div class="card-header">
                          <h4>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ø±</h4>
                      </div>
                      <div class="card-body">
                          <div class="file-upload" onclick="document.getElementById('sourcesFileInput').click()">
                              <p>ğŸ“ Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù„Ù„Ù…ØµØ§Ø¯Ø±</p>
                              <p style="font-size: 0.9rem; color: #666;">
                                  <strong>Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong><br>
                                  â€¢ Ø±Ù‚Ù… BIB (14 Ø±Ù‚Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·)<br>
                                  â€¢ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†<br><br>
                                  <strong>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©:</strong><br>
                                  â€¢ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Title<br>
                                  â€¢ Ø§Ù„Ù…Ø¤Ù„Ù / Author<br>
                                  â€¢ BIB / Ø±Ù‚Ù… BIB<br>
                                  â€¢ Ø§Ù„Ù†Ø§Ø´Ø± / Publisher<br>
                                  â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø± / Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø±<br>
                                  â€¢ Ø§Ù„Ù„ØºØ© / Language<br>
                                  â€¢ ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ / Dewey Classification<br>
                                  â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®<br>
                                  â€¢ Ø§Ù„Ù…ÙƒØªØ¨Ø©<br>
                                  â€¢ Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯ / Source<br>
                                  â€¢ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø± / Status<br>
                                  â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯<br>
                                  â€¢ Ø±Ù‚Ù… Ø§Ù„Ø±Ù
                              </p>
                              <p style="font-size: 0.8rem; color: #888;">
                                  ğŸ’¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØªØ¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
                              </p>
                          </div>
                          <input type="file" id="sourcesFileInput" accept=".xlsx,.xls,.csv" onchange="showFileUploadWarning('sources', this)">
                          <div style="margin-top: 1rem; display: flex; gap: 10px; flex-wrap: wrap;">
                              <button class="btn btn-success" onclick="document.getElementById('sourcesFileInput').click()" style="flex: 1; min-width: 150px;">ğŸ“š Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
                          </div>
                      </div>
                  </div>

                  <div id="importResults" style="margin-top: 2rem;"></div>
              </div>
          </div>
      </section>

      <!-- Settings Section -->
      <section id="settings" class="page-section admin-only supervisor-only settings-page-only">
          <div class="card settings-only-card">
              <div class="card-header">
                  <h2 class="card-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
              </div>
              <div class="card-body">
                  <!-- System Configuration Card -->
                  <div class="card" style="margin-bottom: 2rem;">
                      <div class="card-header">
                          <h4>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h4>
                      </div>
                      <div class="card-body">
                          <div class="form-grid">
                              <div class="form-group">
                                  <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©</label>
                                  <input type="text" class="form-input" id="libraryName" value="Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
                                  <small style="color: #666; font-size: 0.9rem;">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚</small>
                              </div>
                              <div class="form-group">
                                  <label class="form-label">ÙØªØ±Ø© Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</label>
                                  <select class="form-input form-select" id="borrowingPeriod" readonly>
                                      <option value="end_of_day">Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</option>
                                  </select>
                                  <small style="color: #666; font-size: 0.9rem;">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© ØªÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</small>
                              </div>
                              <div class="form-group">
                                  <label class="form-label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</label>
                                  <input type="number" class="form-input" id="maxBorrowedSources" value="999" min="1" max="999" readonly>
                                  <small style="color: #666; font-size: 0.9rem;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ø­Ø§Ù„ÙŠØ§Ù‹</small>
                              </div>
                          </div>
                          
                          <div class="alert alert-info" style="margin-top: 1rem; background: #f8f9fa; border-color: #dee2e6; color: #495057;">
                              <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:</strong><br>
                              â€¢ ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±<br>
                              â€¢ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©<br>
                              â€¢ Ù„Ù† ØªØªØ£Ø«Ø± Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¨ØªØºÙŠÙŠØ± ÙØªØ±Ø© Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©<br>
                              â€¢ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                          </div>
                      </div>
                  </div>

                  <!-- Data Management Card -->
                  <div class="card" style="margin-bottom: 2rem;">
                      <div class="card-header">
                          <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                      </div>
                      <div class="card-body">
                          <div class="form-grid">
                              <div class="form-group">
                                  <button class="btn btn-success" onclick="saveSettings()" style="width: 100%;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                                  <small style="color: #666; font-size: 0.9rem;">Ø§Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</small>
                              </div>
                              <div class="form-group">
                                  <button class="btn btn-warning" onclick="exportCompleteBackup()" style="width: 100%;">ğŸ“¤ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                                  <small style="color: #666; font-size: 0.9rem;">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
                              </div>
                              <div class="form-group admin-only">
                                  <button class="btn btn-danger" onclick="clearAllData()" style="width: 100%;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                                  <small style="color: #666; font-size: 0.9rem;">âš ï¸ Ø§Ø­Ø°Ø±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡</small>
                              </div>
                          </div>
                          
                          <div class="alert alert-warning" style="margin-top: 1rem; background: #f8f9fa; border-color: #dee2e6; color: #495057;">
                              <strong>âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…:</strong><br>
                              â€¢ Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ±<br>
                              â€¢ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸<br>
                              â€¢ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± ÙˆØ§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
                          </div>
                      </div>
                  </div>

                  <!-- System Status Card -->
                  <div class="card">
                      <div class="card-header">
                          <h4>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
                      </div>
                      <div class="card-body">
                          <div class="stats-grid">
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsSourceCount">0</div>
                                  <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù†Ø´Ø·Ø©</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsMemberCount">0</div>
                                  <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsBorrowingCount">0</div>
                                  <div class="stat-label">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsDeletedCount">0</div>
                                  <div class="stat-label">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</div>
                              </div>
                          </div>
                          
                          <!-- Deleted Sources Summary -->
                          <div style="margin-top: 2rem;">
                              <h5>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø­Ø³Ø¨ Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯:</h5>
                              <div id="deletedSourcesSummary" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                  <p style="color: #666; margin: 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± Ù…Ø­Ø°ÙˆÙØ©</p>
                              </div>
                          </div>
                          
                          <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                              <strong>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©:</strong><br>
                              <p style="margin: 0.5rem 0; font-size: 0.9rem;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdateTime">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span></p>
                              <p style="margin: 0.5rem 0; font-size: 0.9rem;">Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: <span id="dataSize">Ø­Ø³Ø§Ø¨...</span></p>
                              <p style="margin: 0.5rem 0; font-size: 0.9rem;">Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: <span style="color: green;">âœ… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ</span></p>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </section>
  </main>

 <footer class="footer">
        <p>Â© Ø±ÙÙ€Ù€Ù€ÙˆÙÙ€Ù€Ù€</p>
        <p>ØµÙÙ†Ø¹  Ø¨Ù€Ù€Ù€ğŸ¤ ÙÙŠ Ø­Ø§Ø¦Ù„  </p>
        <p>Ù„Ù„Ø¯Ø¹Ù…: <a href="mailto:aisha.a@ihr.com.sa">aisha.a@ihr.com.sa</a></p>
    </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
      // Global Variables - Branch-isolated data structures
      const DATA = {
          sources: [],
          members: [],
          borrowings: [],
          deletedSources: [],
          settings: { 
              libraryName: 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 
              borrowingPeriod: 'end_of_day', 
              maxBorrowedSources: 999 
          }
      };

      // User management with updated roles - Admin -> Manager, Added Manager role
      const USER_ACCOUNTS = {
          'ADMIN001': { password: 'Admin@123', role: 'admin', name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…', branch: 'all' },
          'MANAGER001': { password: 'Manager@123', role: 'manager', name: 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…', branch: 'all' },
           '3945': { password: 'Deema@123', role: 'librarian', name: 'Ø¯ÙŠÙ…Ø§  Ù…Ø¨Ø§Ø±Ùƒ Ø§Ù„Ø³Ù„Ø§Ù…Ø©', branch: 'Ø­Ø§Ø¦Ù„' },
         '1111': { password: 'LIB@123', role: 'librarian', name: 'Ø³Ø§Ø±Ø© Ø¹Ø§Ø¯Ù„ Ø§Ù„ØµÙ„Ø­Ø§Ù†ÙŠ', branch: 'Ø­Ø§Ø¦Ù„' },
          '3234': { password: 'LIB@123', role: 'librarian', name: 'Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø­Ù…Ø§Ø¯', branch: 'Ø­Ø§Ø¦Ù„' },
         '4002': { password: 'LIB@123', role: 'librarian', name: 'Ø­Ù…ÙˆØ¯ Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ù„Ù…Ø¹Ø¬Ù„', branch: 'Ø­Ø§Ø¦Ù„' },
'3944': { password: 'LIB@123', role: 'librarian', name: 'Ù…Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø§Ù„Ø¹Ù†Ø²ÙŠ', branch: 'Ø­Ø§Ø¦Ù„' },
          '1': { password: 'LIB@123', role: 'librarian', name: 'Ù†ÙˆÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù… Ø§Ù„Ø´Ù„Ø§Ø´', branch: 'Ø­Ø§Ø¦Ù„' }

      };

      let currentUser = { role: '', membershipNumber: '', name: '', branch: '', authenticated: false };
      let currentReportData = null, currentReportType = '';
      let pendingDeleteAction = null;

      // Updated Dewey Decimal Classification System
      const DEWEY_CLASSIFICATIONS = {
          '000-099': 'Ø§Ù„Ù…Ø¹Ø§Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ø©',
          '100-199': 'Ø§Ù„ÙÙ„Ø³ÙØ© ÙˆØ¹Ù„Ù… Ø§Ù„Ù†ÙØ³', 
          '200-299': 'Ø§Ù„Ø¯ÙŠØ§Ù†Ø§Øª',
          '300-399': 'Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©',
          '400-499': 'Ø§Ù„Ù„ØºØ§Øª',
          '500-599': 'Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¨Ø­ØªØ©',
          '600-699': 'Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©',
          '700-799': 'Ø§Ù„ÙÙ†ÙˆÙ†',
          '800-899': 'Ø§Ù„Ø¢Ø¯Ø§Ø¨',
          '900-999': 'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ ÙˆØ§Ù„ØªØ±Ø§Ø¬Ù…'
      };

      // Enhanced special notes criteria for sources
      const SPECIAL_NOTES_CRITERIA = [
          'BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
          'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©',
          'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù', 
          'Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦',
          'ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©',
          'Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù…Ù„Ù Ø§Ù„ØªÙˆØ±ÙŠØ¯',
          'Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…',
          'Ù…ÙƒØ±Ø±'
      ];

      // CRITICAL FIX: Updated source statuses that prevent borrowing
      const NON_BORROWABLE_STATUSES = [
          'BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
          'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©',
          'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù',
          'Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦',
          'ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©',
          'Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…',
          'Ù…ÙƒØ±Ø±',
          'ØªØ§Ù„Ù'
      ];

      // Utility Functions - Updated with enhanced special notes detection
      const Utils = {
          formatDate: (dateString) => new Date(dateString).toLocaleDateString('en-GB'),
          
          showAlert: (message, type) => {
              const alertDiv = document.createElement('div');
              alertDiv.className = `alert alert-${type}`;
              alertDiv.innerHTML = message;
              Object.assign(alertDiv.style, {
                  position: 'fixed', top: '100px', right: '20px', zIndex: '9999',
                  minWidth: '300px', maxWidth: '500px'
              });
              document.body.appendChild(alertDiv);
              setTimeout(() => alertDiv.remove(), 4000);
          },

          validateBibNumber: (input) => {
              const value = input.value.replace(/\D/g, '');
              input.value = value;
              const errorDiv = input.parentNode.querySelector('.bib-error');
              const isValid = value.length === 14 || value.length === 0;
              input.classList.toggle('invalid', !isValid);
              if (errorDiv) errorDiv.classList.toggle('show', !isValid);
              return isValid;
          },

          getLibraryTypeFromBib: (bib) => {
              if (!bib) return { type: 'unknown', name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', class: 'library-unknown' };
              const prefix = bib.substring(0, 2);
              const types = {
                  '01': { type: 'main', name: 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', class: 'library-main' },
                  '02': { type: 'youth', name: 'Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†', class: 'library-youth' },
                  '03': { type: 'child', name: 'Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„', class: 'library-child' }
              };
              return types[prefix] || { type: 'unknown', name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', class: 'library-unknown' };
          },

          getDeweyCategory: (classification) => {
              if (!classification) return '';
              const number = parseInt(classification);
              for (const [range, category] of Object.entries(DEWEY_CLASSIFICATIONS)) {
                  const [start, end] = range.split('-').map(r => parseInt(r));
                  if (number >= start && number <= end) return category;
              }
              return '';
          },

          getStatusColor: (status) => {
              const colors = {
                  'Ù…ØªØ§Ø­': 'success', 'Ù…Ø³ØªØ¹Ø§Ø±': 'warning', 'ØªØ§Ù„Ù': 'danger',
                  'Ù…Ø­Ø°ÙˆÙ': 'danger',
                  'BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': 'danger',
                  'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©': 'danger', 
                  'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù': 'danger',
                  'Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦': 'warning',
                  'ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©': 'warning',
                  'Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…': 'secondary',
                  'Ù…ÙƒØ±Ø±': 'danger'
              };
              return colors[status] || 'secondary';
          },

          isWithinPeriod: (date, period) => {
              const now = new Date();
              const targetDate = new Date(date);
              
              switch(period) {
                  case 'daily':
                      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                      const checkDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
                      return checkDate.getTime() === today.getTime();
                  case 'weekly':
                      const weekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                      return targetDate >= weekAgo && targetDate <= now;
                  case 'monthly':
                      const monthAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                      return targetDate >= monthAgo && targetDate <= now;
                  default:
                      return true;
              }
          },

          // Enhanced: Check if source has special notes that need attention
          hasSpecialNotes: (source) => {
              if (!source) return false;
              
              // Check for all zeros BIB (no chip)
              if (source.bibNumber === '00000000000000') {
                  return true;
              }
              
              // Check for old publication (before 2014)
              if (source.publishYear && parseInt(source.publishYear) < 2014) {
                  return true;
              }
              
              // Check for duplicate BIB in same branch
              const duplicateBib = DATA.sources.filter(s => 
                  s.bibNumber === source.bibNumber && 
                  s.branch === source.branch && 
                  s.id !== source.id &&
                  !s.deleted
              ).length > 0;
              
              if (duplicateBib) {
                  return true;
              }
              
              // Check for explicit special notes criteria
              if (source.notes) {
                  const notes = source.notes.toLowerCase();
                  const hasSpecialCriteria = SPECIAL_NOTES_CRITERIA.some(criteria => 
                      notes.includes(criteria.toLowerCase())
                  );
                  
                  if (hasSpecialCriteria) {
                      return true;
                  }
              }
              
              // Check status for special conditions - CRITICAL UPDATE
              if (source.status && NON_BORROWABLE_STATUSES.includes(source.status)) {
                  return true;
              }
              
              return false;
          },

          // Enhanced: Get end of day date
          getEndOfDay: (date = new Date()) => {
              const endOfDay = new Date(date);
              endOfDay.setHours(23, 59, 59, 999);
              return endOfDay;
          },

          // NEW: Check if source is borrowable
          isBorrowable: (source) => {
              if (!source || source.deleted) return false;
              
              // Sources with special notes statuses are NOT borrowable
              if (NON_BORROWABLE_STATUSES.includes(source.status)) {
                  return false;
              }
              
              // Only available sources can be borrowed
              return source.status === 'Ù…ØªØ§Ø­';
          }
      };


const ValidationUtils = {
    // Check for "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©" or 14 zeros in BIB or title
    hasNoChipIndicator: (text) => {
        if (!text) return false;
        const cleanText = text.toString().toLowerCase().trim();
        
        // Check for "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©" phrase
        if (cleanText.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©') || 
            cleanText.includes('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©') ||
            cleanText.includes('no chip') ||
            cleanText.includes('no slide')) {
            return true;
        }
        
        // Check for 14 zeros (all zeros BIB)
        if (cleanText === '00000000000000' || cleanText.includes('00000000000000')) {
            return true;
        }
        
        return false;
    },
    
    // Check for BIB duplication within same branch
    checkBibDuplication: (bibNumber, currentSourceId, branch) => {
        return DATA.sources.find(s => 
            s.bibNumber === bibNumber && 
            s.branch === branch && 
            !s.deleted &&
            s.id !== currentSourceId
        );
    },
    
    // Check for title duplication within same branch
    checkTitleDuplication: (title, currentSourceId, branch) => {
        const normalizedTitle = title.toLowerCase().trim();
        return DATA.sources.find(s => 
            s.title.toLowerCase().trim() === normalizedTitle && 
            s.branch === branch && 
            !s.deleted &&
            s.id !== currentSourceId
        );
    },
    
    // Enhanced source validation
    validateSourceData: (sourceData, currentSourceId = null) => {
        const errors = [];
        const warnings = [];
        const userBranch = ['admin', 'manager'].includes(currentUser.role) ? 
            (sourceData.branch || 'Ø§Ù„Ø±ÙŠØ§Ø¶') : currentUser.branch;
        
        // BIB validation
        if (!sourceData.bibNumber || sourceData.bibNumber.length !== 14) {
            errors.push('Ø±Ù‚Ù… BIB ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¶Ø¨Ø·');
        }
        
        // Title validation
        if (!sourceData.title || sourceData.title.trim() === '') {
            errors.push('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨');
        }
        
        // Author validation
        if (!sourceData.author || sourceData.author.trim() === '') {
            errors.push('Ø§Ù„Ù…Ø¤Ù„Ù Ù…Ø·Ù„ÙˆØ¨');
        }
        
        // Check for no chip indicators
        if (ValidationUtils.hasNoChipIndicator(sourceData.bibNumber)) {
            warnings.push('ØªÙ… Ø§ÙƒØªØ´Ø§Ù "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©" Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù… ØµÙØ±ÙŠØ© ÙÙŠ Ø±Ù‚Ù… BIB');
        }
        
        if (ValidationUtils.hasNoChipIndicator(sourceData.title)) {
            warnings.push('ØªÙ… Ø§ÙƒØªØ´Ø§Ù "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©" ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†');
        }
        
        // Check for BIB duplication
        if (sourceData.bibNumber) {
            const duplicateBib = ValidationUtils.checkBibDuplication(
                sourceData.bibNumber, currentSourceId, userBranch
            );
            if (duplicateBib) {
                warnings.push(`Ø±Ù‚Ù… BIB Ù…ÙƒØ±Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹ - Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø±: "${duplicateBib.title}"`);
            }
        }
        
        // Check for title duplication
        if (sourceData.title) {
            const duplicateTitle = ValidationUtils.checkTitleDuplication(
                sourceData.title, currentSourceId, userBranch
            );
            if (duplicateTitle) {
                warnings.push(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…ÙƒØ±Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹ - Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¹ Ø±Ù‚Ù… BIB: "${duplicateTitle.bibNumber}"`);
            }
        }
        
        return { errors, warnings, isValid: errors.length === 0 };
    }
};

      // Storage Management - same as before
      const Storage = {
          save: () => {
              try {
                  Object.entries(DATA).forEach(([key, value]) => {
                      localStorage.setItem(`librarySystem${key.charAt(0).toUpperCase() + key.slice(1)}`, JSON.stringify(value));
                  });
                  localStorage.setItem('librarySystemAuth', JSON.stringify({
                      ...currentUser, loginTime: new Date().getTime()
                  }));
              } catch (error) {
                  Utils.showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'warning');
              }
          },

          load: () => {
              try {
                  Object.keys(DATA).forEach(key => {
                      const saved = localStorage.getItem(`librarySystem${key.charAt(0).toUpperCase() + key.slice(1)}`);
                      if (saved) DATA[key] = JSON.parse(saved);
                  });

                  // Check authentication
                  const savedAuth = localStorage.getItem('librarySystemAuth');
                  if (savedAuth) {
                      const authData = JSON.parse(savedAuth);
                      const hoursSinceLogin = (new Date().getTime() - authData.loginTime) / (1000 * 60 * 60);
                      
                      if (hoursSinceLogin < 24 && authData.authenticated) {
                          currentUser = authData;
                          hideLoginModal();
                          applyUserPermissions();
                          initializeSystem();
                      }
                  }
              } catch (error) {
                  Utils.showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', 'warning');
              }
          }
      };

      // Authentication System - Updated for new roles
    function authenticateUser(event) {
    event.preventDefault();
    // Trim whitespace from both inputs for robust validation
    const membershipNumber = document.getElementById('membershipNumber').value.trim();
    const password = document.getElementById('password').value.trim();
    

          // Check predefined accounts first
          const account = USER_ACCOUNTS[membershipNumber];
          if (account && account.password === password) {
              currentUser = {
                  membershipNumber,
                  role: account.role,
                  name: account.name,
                  branch: account.branch,
                  authenticated: true
              };
              
              hideLoginModal();
              applyUserPermissions();
              Storage.save();
              initializeSystem();
              return;
          }

          // Check custom users
          const customUser = DATA.members.find(user => 
              user.membershipNumber === membershipNumber && 
              user.password === password
          );

          if (customUser) {
              // Auto-detect role from memberType
              let role = 'librarian';
              if (customUser.memberType === 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…') role = 'admin';
              else if (customUser.memberType === 'Ù…Ø´Ø±Ù ÙØ±Ø¹') role = 'supervisor';
              
              currentUser = {
                  membershipNumber,
                  role,
                  name: customUser.fullName,
                  branch: customUser.branch,
                  authenticated: true
              };
              
              hideLoginModal();
              applyUserPermissions();
              Storage.save();
              initializeSystem();
          } else {
              errorDiv.style.display = 'block';
              errorDiv.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
          }
      }

      function applyUserPermissions() {
          document.body.className = `${currentUser.role}-mode`;
          document.getElementById('currentUser').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name}`;
          
          if (!['admin', 'manager'].includes(currentUser.role)) {
              document.getElementById('currentBranch').textContent = `Ø§Ù„ÙØ±Ø¹: ${currentUser.branch}`;
          }
      }

      function hideLoginModal() {
          document.getElementById('loginModal').style.display = 'none';
      }

      function logout() {
          if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
              currentUser = { role: '', membershipNumber: '', name: '', branch: '', authenticated: false };
              document.body.className = '';
              localStorage.removeItem('librarySystemAuth');
              location.reload();
          }
      }

      // Data Filtering - Updated for Manager role
      const DataFilter = {
          getFilteredSources: (filters = {}) => {
              let filtered = DATA.sources.filter(source => !source.deleted);
              
              // Branch filtering - Updated for Manager role
              if (['admin', 'manager'].includes(currentUser.role)) {
                  // Admin and Manager can see all or filter by specific branch
                  if (filters.branch && filters.branch !== 'all') {
                      filtered = filtered.filter(source => source.branch === filters.branch);
                  }
              } else {
                  // Non-admin users can only see their branch data
                  filtered = filtered.filter(source => source.branch === currentUser.branch);
              }

              // Other filters
              Object.entries(filters).forEach(([key, value]) => {
                  if (value && value !== 'all' && key !== 'branch') {
                      if (key === 'status' && value === 'special_notes') {
                          filtered = filtered.filter(source => Utils.hasSpecialNotes(source));
                      } else if (key === 'library') {
                          filtered = filtered.filter(source => {
                              const libType = Utils.getLibraryTypeFromBib(source.bibNumber);
                              return libType.type === value;
                          });
                      } else {
                          filtered = filtered.filter(source => source[key] === value);
                      }
                  }
              });

              return filtered;
          },

          getFilteredMembers: (filters = {}) => {
              let filtered = [...DATA.members];
              
              // Add predefined accounts to the filtered members list
              const predefinedMembers = Object.entries(USER_ACCOUNTS).map(([membershipNumber, account]) => ({
                  id: `predefined_${membershipNumber}`,
                  membershipNumber,
                  fullName: account.name,
                  memberType: account.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' : 
                            account.role === 'supervisor' ? 'Ù…Ø´Ø±Ù ÙØ±Ø¹' : 
                            account.role === 'manager' ? 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…' : 'Ø£Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø©',
                  branch: account.branch === 'all' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : account.branch,
                  joinDate: new Date().toISOString(),
                  isPredefined: true
              }));
              
              filtered = [...filtered, ...predefinedMembers];
              
              // Branch filtering - Updated for Manager role
              if (['admin', 'manager'].includes(currentUser.role)) {
                  if (filters.branch && filters.branch !== 'all') {
                      filtered = filtered.filter(member => 
                          member.branch === filters.branch || 
                          (member.branch === 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' && filters.branch !== 'all')
                      );
                  }
              } else if (currentUser.role === 'supervisor') {
                  // Supervisors can only see members from their branch
                  filtered = filtered.filter(member => 
                      member.branch === currentUser.branch || 
                      member.branch === 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹'
                  );
              }

              return filtered;
          },

          getFilteredBorrowings: (filters = {}) => {
              let filtered = DATA.borrowings;
              
              // Branch filtering - Updated for Manager role
              if (['admin', 'manager'].includes(currentUser.role)) {
                  if (filters.branch && filters.branch !== 'all') {
                      filtered = filtered.filter(borrowing => borrowing.branch === filters.branch);
                  }
              } else {
                  // Non-admin/manager users can only see their branch borrowings
                  filtered = filtered.filter(borrowing => borrowing.branch === currentUser.branch);
              }

              return filtered;
          }
      };
function editSource(sourceId) {
Â  Â  Â  Â  Â  // Check if the provided ID is valid before doing anything else
Â  Â  Â  Â  Â  if (sourceId === null || sourceId === undefined) {
Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.', 'danger');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const source = DATA.sources.find(s => s.id === sourceId);
Â  Â  Â  Â  Â  if (!source) {
Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', 'danger');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (!['admin', 'supervisor'].includes(currentUser.role)) {
Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±.', 'danger');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (!['admin', 'manager'].includes(currentUser.role) && source.branch !== currentUser.branch) {
Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ¯Ø± Ù…Ù† ÙØ±Ø¹ Ø¢Ø®Ø±!', 'danger');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Populate edit form
Â  Â  Â  Â  Â  document.getElementById('editSourceId').value = source.id;
Â  Â  Â  Â  Â  document.getElementById('editSourceBib').value = source.bibNumber || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceTitle').value = source.title || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceAuthor').value = source.author || '';
Â  Â  Â  Â  Â  document.getElementById('editSourcePublisher').value = source.publisher || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceYear').value = source.publishYear || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceLanguage').value = source.language || 'ara';
Â  Â  Â  Â  Â  document.getElementById('editSourceDewey').value = source.deweyClassification || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceCopies').value = source.copiesCount || 1;
Â  Â  Â  Â  Â  document.getElementById('editSourceLibrary').value = source.library || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceSupply').value = source.source || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceStatus').value = source.status || 'Ù…ØªØ§Ø­';
Â  Â  Â  Â  Â  document.getElementById('editSourceLocation').value = source.location || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceSupplyDate').value = source.supplyDate || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceShelf').value = source.shelfNumber || '';
Â  Â  Â  Â  Â  document.getElementById('editSourceNotes').value = source.notes || '';

Â  Â  Â  Â  Â  if (source.deweyClassification) {
Â  Â  Â  Â  Â  Â  Â  updateEditDeweyInfo({ value: source.deweyClassification });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  document.getElementById('editSourceModal').classList.add('active');
Â  Â  Â  }
    function updateSource(event) {
Â  Â  Â  Â  Â  event.preventDefault();

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  // --- 1. FIND THE SOURCE ---
Â  Â  Â  Â  Â  Â  Â  const sourceIdValue = document.getElementById('editSourceId').value;
Â  Â  Â  Â  Â  Â  Â  if (!sourceIdValue) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('Ø®Ø·Ø£ Ø­Ø±Ø¬: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØµØ¯Ø±.', 'danger');
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  const sourceId = parseFloat(sourceIdValue);
Â  Â  Â  Â  Â  Â  Â  const sourceIndex = DATA.sources.findIndex(s => s.id === sourceId);

Â  Â  Â  Â  Â  Â  Â  if (sourceIndex === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ¯Ø±. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.', 'danger');
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  // --- 2. VALIDATE THE FORM INPUTS ---
Â  Â  Â  Â  Â  Â  Â  const bibInput = document.getElementById('editSourceBib');
Â  Â  Â  Â  Â  Â  Â  const titleInput = document.getElementById('editSourceTitle');
Â  Â  Â  Â  Â  Â  Â  const authorInput = document.getElementById('editSourceAuthor');

Â  Â  Â  Â  Â  Â  Â  if (!bibInput.value.trim() || bibInput.value.trim().length !== 14 || !/^\d{14}$/.test(bibInput.value.trim())) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: Ø±Ù‚Ù… BIB ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¶Ø¨Ø·.', 'danger');
Â  Â  Â  Â  Â  Â  Â  Â  Â  bibInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  if (!titleInput.value.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨.', 'danger');
Â  Â  Â  Â  Â  Â  Â  Â  Â  titleInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  if (!authorInput.value.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¤Ù„Ù Ù…Ø·Ù„ÙˆØ¨.', 'danger');
Â  Â  Â  Â  Â  Â  Â  Â  Â  authorInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  // --- 3. UPDATE THE DATA AND SAVE ---
Â  Â  Â  Â  Â  Â  Â  const updatedSource = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  ...DATA.sources[sourceIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  bibNumber: bibInput.value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  title: titleInput.value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  author: authorInput.value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  publisher: document.getElementById('editSourcePublisher').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  publishYear: document.getElementById('editSourceYear').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  language: document.getElementById('editSourceLanguage').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  deweyClassification: document.getElementById('editSourceDewey').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  copiesCount: Math.max(1, parseInt(document.getElementById('editSourceCopies').value) || 1),
Â  Â  Â  Â  Â  Â  Â  Â  Â  library: document.getElementById('editSourceLibrary').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  source: document.getElementById('editSourceSupply').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  status: document.getElementById('editSourceStatus').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  location: document.getElementById('editSourceLocation').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  supplyDate: document.getElementById('editSourceSupplyDate').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  shelfNumber: document.getElementById('editSourceShelf').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  notes: document.getElementById('editSourceNotes').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  lastModified: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  modifiedBy: currentUser.name
Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  DATA.sources[sourceIndex] = updatedSource;
Â  Â  Â  Â  Â  Â  Â  Storage.save();

Â  Â  Â  Â  Â  Â  Â  // --- 4. REFRESH THE USER INTERFACE ---
Â  Â  Â  Â  Â  Â  Â  closeEditSourceModal(); // Close the pop-up window
Â  Â  Â  Â  Â  Â  Â  loadSourcesTable(); Â  Â  // Redraw the main sources table
Â  Â  Â  Â  Â  Â  Â  updateDashboard(); Â  Â  Â // Update the stats on the dashboard
Â  Â  Â  Â  Â  Â  Â  Utils.showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success'); // Show success message

Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  // This will catch any unexpected errors during the process
Â  Â  Â  Â  Â  Â  Â  console.error("An unexpected error occurred in updateSource:", error);
Â  Â  Â  Â  Â  Â  Â  Utils.showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….", 'danger');
Â  Â  Â  Â  Â  }
Â  Â  Â  }
      function editMember(memberId) {
          const member = DATA.members.find(m => m.id === memberId);
          if (!member) {
              Utils.showAlert('Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', 'danger');
              return;
          }

          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.', 'danger');
              return;
          }

          // Branch permission check for supervisors
          if (currentUser.role === 'supervisor' && member.branch !== currentUser.branch) {
              Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ Ù…Ù† ÙØ±Ø¹ Ø¢Ø®Ø±!', 'danger');
              return;
          }

          // Populate edit form
          document.getElementById('editMemberId').value = member.id;
          document.getElementById('editMembershipNumber').value = member.membershipNumber || '';
          document.getElementById('editMemberPassword').value = member.password || '';
          document.getElementById('editMemberName').value = member.fullName || '';
          document.getElementById('editMemberType').value = member.memberType || '';
          document.getElementById('editMemberBranch').value = member.branch || '';

          // Show modal
          document.getElementById('editMemberModal').classList.add('active');
      }

      function updateMember(event) {
          event.preventDefault();
          
          const memberId = parseInt(document.getElementById('editMemberId').value);
          const member = DATA.members.find(m => m.id === memberId);
          
          if (!member) {
              Utils.showAlert('Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', 'danger');
              return;
          }

          const password = document.getElementById('editMemberPassword').value;
          const fullName = document.getElementById('editMemberName').value.trim();
          const memberType = document.getElementById('editMemberType').value;
          const branch = document.getElementById('editMemberBranch').value;

          // Validate required fields
          if (!password || !fullName || !memberType || !branch) {
              Utils.showAlert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙŠØ¬Ø¨ Ù…Ù„Ø¤Ù‡Ø§!', 'danger');
              return;
          }

          // Branch restriction for supervisors
          if (currentUser.role === 'supervisor' && branch !== currentUser.branch) {
              Utils.showAlert('Ø§Ù„Ù…Ø´Ø±Ù ÙŠÙ…ÙƒÙ†Ù‡ ÙÙ‚Ø· ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¹Ø¶Ø§Ø¡ ÙØ±Ø¹Ù‡ ÙÙ‚Ø·!', 'danger');
              return;
          }

          // Validate password strength
          if (password.length < 4) {
              Utils.showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!', 'danger');
              return;
          }

          // Update member properties
          member.password = password;
          member.fullName = fullName;
          member.memberType = memberType;
          member.branch = branch;
          member.lastModified = new Date().toISOString();
          member.modifiedBy = currentUser.name;

          Storage.save();
          closeEditMemberModal();
          loadMembersTable();
          updateDashboard();
          
          Utils.showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      }

      function closeEditMemberModal() {
          document.getElementById('editMemberModal').classList.remove('active');
          document.getElementById('editMemberForm').reset();
      }

function closeEditSourceModal() {
Â  Â  Â  Â  Â  document.getElementById('editSourceModal').classList.remove('active');
Â  Â  Â  Â  Â  document.getElementById('editSourceForm').reset();
Â  Â  Â  }

      // Enhanced Delete Functions with Confirmation Modal
      function deleteSource(sourceId) {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø­Ø°Ù.', 'danger');
              return;
          }

          const source = DATA.sources.find(s => s.id === sourceId);
          if (!source) {
              Utils.showAlert('Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', 'danger');
              return;
          }

          // Branch permission check
          if (!['admin', 'manager'].includes(currentUser.role) && source.branch !== currentUser.branch) {
              Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…ØµØ¯Ø± Ù…Ù† ÙØ±Ø¹ Ø¢Ø®Ø±!', 'danger');
              return;
          }

          if (source.deleted) {
              // Restore source
              if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±ØŸ')) {
                  source.deleted = false;
                  source.status = 'Ù…ØªØ§Ø­';
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  Utils.showAlert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
              }
          } else {
              // Check for active borrowing
              const activeBorrowing = DATA.borrowings.find(b => 
                  b.sourceId === sourceId && !b.returned
              );
              
              if (activeBorrowing) {
                  Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…ØµØ¯Ø± Ù…Ø³ØªØ¹Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹!', 'warning');
                  return;
              }

              // Show delete confirmation modal with reason
              showDeleteConfirmationModal('source', sourceId, `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±: "${source.title}"ØŸ`);
          }
      }

      function deleteMember(memberId) {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.', 'danger');
              return;
          }

          const member = DATA.members.find(m => m.id === memberId);
          if (!member) {
              Utils.showAlert('Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', 'danger');
              return;
          }

          // Branch permission check for supervisors
          if (currentUser.role === 'supervisor' && member.branch !== currentUser.branch) {
              Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¹Ø¶Ùˆ Ù…Ù† ÙØ±Ø¹ Ø¢Ø®Ø±!', 'danger');
              return;
          }

          // Check for active borrowings
          const activeBorrowings = DATA.borrowings.filter(b => 
              b.membershipNumber === member.membershipNumber && !b.returned
          );
          
          if (activeBorrowings.length > 0) {
              Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¹Ø¶Ùˆ Ù„Ù‡ Ø¥Ø¹Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©!', 'warning');
              return;
          }

          // Show delete confirmation modal
          showDeleteConfirmationModal('member', memberId, `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ: "${member.fullName}"ØŸ`);
      }

      function showDeleteConfirmationModal(type, id, message) {
          document.getElementById('deleteConfirmationText').textContent = message;
          
          // Show reason selector only for sources
          const reasonGroup = document.getElementById('deleteReasonGroup');
          if (type === 'source') {
              reasonGroup.style.display = 'block';
              document.getElementById('deleteReason').required = true;
          } else {
              reasonGroup.style.display = 'none';
              document.getElementById('deleteReason').required = false;
          }

          pendingDeleteAction = { type, id };
          document.getElementById('deleteConfirmationModal').classList.add('active');
      }

      function closeDeleteConfirmationModal() {
          document.getElementById('deleteConfirmationModal').classList.remove('active');
          document.getElementById('deleteReason').value = '';
          pendingDeleteAction = null;
      }

      function confirmDelete() {
          if (!pendingDeleteAction) return;

          const { type, id } = pendingDeleteAction;
          let reason = '';

          if (type === 'source') {
              reason = document.getElementById('deleteReason').value;
              if (!reason) {
                  Utils.showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù!', 'warning');
                  return;
              }

              const source = DATA.sources.find(s => s.id === id);
              if (source) {
                  source.deleted = true;
                  source.status = 'Ù…Ø­Ø°ÙˆÙ';
                  source.deletedDate = new Date().toISOString();
                  source.deletedBy = currentUser.name;
                  source.deleteReason = reason;
                  
                  // Add to deleted sources summary
                  const deletedRecord = {
                      id: Date.now(),
                      source: source.source,
                      copiesCount: source.copiesCount || 1,
                      deletedDate: new Date().toISOString(),
                      deletedBy: currentUser.name,
                      branch: source.branch,
                      reason: reason
                  };
                  DATA.deletedSources.push(deletedRecord);
                  
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  Utils.showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
              }
          } else if (type === 'member') {
              const memberIndex = DATA.members.findIndex(m => m.id === id);
              if (memberIndex !== -1) {
                  DATA.members.splice(memberIndex, 1);
                  Storage.save();
                  loadMembersTable();
                  updateDashboard();
                  Utils.showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
              }
          }

          closeDeleteConfirmationModal();
      }

      // Dashboard Functions - Updated for special notes count
      function updateDashboard() {
          const period = document.getElementById('activityPeriod').value;
          const libraryType = document.getElementById('libraryTypeFilter').value;
          const branchFilter = ['admin', 'manager'].includes(currentUser.role) ? 
              document.getElementById('dashboardBranchFilter')?.value : null;
          
          const filteredSources = DataFilter.getFilteredSources({ 
              branch: branchFilter,
              library: libraryType !== 'all' ? libraryType : null 
          });
          const filteredBorrowings = DataFilter.getFilteredBorrowings({ branch: branchFilter })
              .filter(b => period === 'all' || Utils.isWithinPeriod(b.borrowDate, period));
          
          // Update stats
          document.getElementById('totalSources').textContent = filteredSources.length;
          document.getElementById('totalMembers').textContent = DataFilter.getFilteredMembers({ branch: branchFilter }).length;
          
          const activeBorrowings = filteredBorrowings.filter(b => !b.returned);
          document.getElementById('borrowedSources').textContent = activeBorrowings.length;
          
          // Library type stats
          ['main', 'youth', 'child'].forEach(type => {
              const sources = filteredSources.filter(s => 
                  Utils.getLibraryTypeFromBib(s.bibNumber).type === type && s.status === 'Ù…ØªØ§Ø­'
              );
              const elementId = type === 'main' ? 'mainLibrarySources' : 
                                type === 'youth' ? 'youthLibrarySources' : 'childLibrarySources';
              document.getElementById(elementId).textContent = sources.length;
          });
          
          // Updated: Sources with special notes
          const sourcesWithSpecialNotes = filteredSources.filter(s => Utils.hasSpecialNotes(s));
          document.getElementById('sourcesWithSpecialNotes').textContent = sourcesWithSpecialNotes.length;
          
          // Update other components
          loadRecentBorrowings();
          updateUserPersonalStats();
          if (!['librarian'].includes(currentUser.role)) {
              updateEmployeePerformance();
          }
      }

      function updateUserPersonalStats() {
          const userBorrowings = DATA.borrowings.filter(b => b.employeeName === currentUser.name);
          
          ['daily', 'weekly', 'monthly'].forEach(period => {
              const count = userBorrowings.filter(b => Utils.isWithinPeriod(b.borrowDate, period)).length;
              const elementId = period === 'daily' ? 'userTodayBorrowings' : 
                                period === 'weekly' ? 'userWeekBorrowings' : 'userMonthBorrowings';
              document.getElementById(elementId).textContent = count;
          });
          
          document.getElementById('userTotalBorrowings').textContent = userBorrowings.length;
      }

      function updateEmployeePerformance() {
          const tbody = document.getElementById('employeePerformance');
          tbody.innerHTML = '';
          
          // Get borrowings filtered by branch
          const filteredBorrowings = DataFilter.getFilteredBorrowings({});
          const employees = [...new Set(filteredBorrowings.map(b => b.employeeName).filter(name => name))];
          
          if (employees.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
              return;
          }
          
          employees.forEach(employeeName => {
              const employeeBorrowings = filteredBorrowings.filter(b => b.employeeName === employeeName);
              const employeeBranch = employeeBorrowings[0]?.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
              
              const [today, week, month] = ['daily', 'weekly', 'monthly'].map(period => 
                  employeeBorrowings.filter(b => Utils.isWithinPeriod(b.borrowDate, period)).length
              );
              const returns = employeeBorrowings.filter(b => b.returned).length;
              
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${employeeName}</td>
                  <td>${employeeBranch}</td>
                  <td>${today}</td>
                  <td>${week}</td>
                  <td>${month}</td>
                  <td>${employeeBorrowings.length}</td>
                  <td>${returns}</td>
              `;
              tbody.appendChild(row);
          });
      }

      function loadRecentBorrowings() {
          const tbody = document.getElementById('recentBorrowings');
          const recent = DataFilter.getFilteredBorrowings({})
              .filter(b => !b.returned)
              .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
              .slice(0, 5);
          
          if (recent.length === 0) {
              tbody.innerHTML = '<tr><td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª Ø­Ø¯ÙŠØ«Ø©</td></tr>';
              return;
          }
          
          tbody.innerHTML = recent.map(borrowing => {
              const member = DATA.members.find(m => m.membershipNumber === borrowing.membershipNumber) ||
                            USER_ACCOUNTS[borrowing.membershipNumber];
              const source = DATA.sources.find(s => s.id === borrowing.sourceId);
              const libraryType = source ? Utils.getLibraryTypeFromBib(source.bibNumber) : { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', class: 'library-unknown' };
              const dueDate = new Date(borrowing.dueDate);
              const isOverdue = dueDate < new Date();
              
              return `
                  <tr>
                      <td>${member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                      <td>${source ? source.title : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                      <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                      <td>${Utils.formatDate(borrowing.borrowDate)}</td>
                      <td>${Utils.formatDate(borrowing.dueDate)}</td>
                      <td><span class="badge ${isOverdue ? 'badge-danger' : 'badge-success'}">${isOverdue ? 'Ù…ØªØ£Ø®Ø±' : 'Ù†Ø´Ø·'}</span></td>
                      <td>${borrowing.employeeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                      <td>${borrowing.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                  </tr>
              `;
          }).join('');
      }

      // Sources Management - Updated with enhanced special notes detection
      function showAddSourceForm() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø¯Ø±.', 'danger');
              return;
          }
          document.getElementById('addSourceForm').style.display = 'block';
      }

      function hideAddSourceForm() {
          document.getElementById('addSourceForm').style.display = 'none';
          document.getElementById('sourceForm').reset();
      }

      function addSource(event) {
          event.preventDefault();
          
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø¯Ø±.', 'danger');
              return;
          }
          
          const formData = new FormData(event.target);
          const bibNumber = formData.get('bibNumber');
          
          if (!Utils.validateBibNumber({ value: bibNumber, parentNode: { querySelector: () => ({ classList: { add: () => {}, remove: () => {} }, style: { display: '' } }) } })) {
              Utils.showAlert('Ø±Ù‚Ù… BIB ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¶Ø¨Ø·', 'danger');
              return;
          }
          
          // Check for duplicates WITHIN THE SAME BRANCH ONLY
          const userBranch = currentUser.branch === 'all' ? 'Ø§Ù„Ø±ÙŠØ§Ø¶' : currentUser.branch;
          const existingSource = DATA.sources.find(source => 
              source.bibNumber === bibNumber && 
              source.branch === userBranch && 
              !source.deleted
          );
          
          let sourceStatus = formData.get('status') || 'Ù…ØªØ§Ø­';
          let notes = formData.get('notes') || '';
          
          if (existingSource) {
              notes = `Ù…ÙƒØ±Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹ - Ø±Ù‚Ù… BIB Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹. ${notes}`.trim();
              Utils.showAlert('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… BIB Ù…ÙƒØ±Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹! ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©.', 'warning');
          }
          
          const source = {
              id: Date.now() + Math.random(),
              bibNumber,
              title: formData.get('title'),
              author: formData.get('author'),
              publisher: formData.get('publisher'),
              publishYear: formData.get('publishYear'),
              language: formData.get('language'),
              deweyClassification: formData.get('deweyClassification'),
              copiesCount: parseInt(formData.get('copiesCount')) || 1,
              library: formData.get('library'),
              source: formData.get('source'),
              status: sourceStatus,
              location: formData.get('location'),
              supplyDate: formData.get('supplyDate'),
              shelfNumber: formData.get('shelfNumber'),
              notes,
              branch: userBranch,
              addedDate: new Date().toISOString(),
              deleted: false
          };
          
          DATA.sources.push(source);
          Storage.save();
          
          loadSourcesTable();
          hideAddSourceForm();
          updateDashboard();
          
          Utils.showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      }

      // CRITICAL FIX: Updated loadSourcesTable to show proper status and make non-borrowable sources visually distinct
      function loadSourcesTable() {
          const tbody = document.getElementById('sourcesTable');
          tbody.innerHTML = '';
          
          const branchFilter = ['admin', 'manager'].includes(currentUser.role) ? 
              document.getElementById('sourcesBranchFilter')?.value : null;
          const statusFilter = document.getElementById('sourceStatusFilter')?.value;
          const libraryFilter = document.getElementById('sourceLibraryFilter')?.value;
          const sourceFilter = document.getElementById('sourceSupplyFilter')?.value;
          
          let displaySources = DataFilter.getFilteredSources({
              branch: branchFilter,
              status: statusFilter,
              library: libraryFilter,
              source: sourceFilter
          });

          // Handle special filters
          if (statusFilter === 'special_notes') {
              displaySources = displaySources.filter(source => Utils.hasSpecialNotes(source));
          } else if (statusFilter === 'Ù…Ø­Ø°ÙˆÙ') {
              // Show deleted sources from current branch
              if (['admin', 'manager'].includes(currentUser.role)) {
                  displaySources = DATA.sources.filter(source => 
                      source.deleted && 
                      (branchFilter === 'all' || !branchFilter || source.branch === branchFilter)
                  );
              } else {
                  displaySources = DATA.sources.filter(source => 
                      source.deleted && source.branch === currentUser.branch
                  );
              }
          }
          
          if (displaySources.length === 0) {
              const colspan = currentUser.role === 'librarian' ? '16' : '17';
              tbody.innerHTML = `<tr><td colspan="${colspan}">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯</td></tr>`;
              return;
          }
          
          tbody.innerHTML = displaySources.map((source, index) => {
              const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
              const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
              const actionsHtml = currentUser.role !== 'librarian' ? 
                  `<td>
                      <button class="btn btn-sm btn-warning" onclick="editSource(${source.id})">âœï¸</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteSource(${source.id})">${source.deleted ? 'ğŸ”„' : 'ğŸ—‘ï¸'}</button>
                  </td>` : '';
              
              // CRITICAL FIX: Enhanced special notes highlighting and non-borrowable indication
              const hasSpecialNotes = Utils.hasSpecialNotes(source);
              const isNonBorrowable = NON_BORROWABLE_STATUSES.includes(source.status);
              const rowClass = hasSpecialNotes || isNonBorrowable ? 
                  'class="not-borrowable"' : '';
              
              // CRITICAL FIX: Show actual status instead of just "Available" for sources with notes
              const displayStatus = source.deleted ? 'Ù…Ø­Ø°ÙˆÙ' : source.status;
              
              return `
                  <tr ${rowClass}>
                      <td>${index + 1}</td>
                      <td>${source.bibNumber || '-'}</td>
                      <td>${source.title}${hasSpecialNotes || isNonBorrowable ? ' <span class=""></span>' : ''}</td>
                      <td>${source.author}</td>
                      <td>${source.publisher || '-'}</td>
                      <td>${source.publishYear || '-'}</td>
                      <td>${source.language || '-'}</td>
                      <td>${source.deweyClassification || '-'}</td>
                      <td><span class="badge badge-secondary">${thematicClassification || '-'}</span></td>
                      <td>${source.copiesCount || 1}</td>
                      <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                      <td>${source.source || '-'}</td>
                      <td>${source.supplyDate ? Utils.formatDate(source.supplyDate) : '-'}</td>
                      <td>${source.shelfNumber || '-'}</td>
                      <td>${source.branch || '-'}</td>
                      <td><span class="badge badge-${Utils.getStatusColor(displayStatus)}">${displayStatus}</span></td>
                      ${actionsHtml}
                  </tr>
              `;
          }).join('');
      }

      function showDeleteBySourceModal() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø§Ù„Ù…ØµØ§Ø¯Ø±.', 'danger');
              return;
          }
          document.getElementById('deleteBySourceModal').style.display = 'block';
      }

      function hideDeleteBySourceModal() {
          document.getElementById('deleteBySourceModal').style.display = 'none';
          document.getElementById('deleteSourceSelect').value = '';
          document.getElementById('deleteBulkReason').value = '';
      }

      function deleteBySource() {
          const sourceType = document.getElementById('deleteSourceSelect').value;
          const reason = document.getElementById('deleteBulkReason').value;
          
          if (!sourceType) {
              Utils.showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯', 'warning');
              return;
          }

          if (!reason) {
              Utils.showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù', 'warning');
              return;
          }

          // Get sources to delete from current branch only
          const sourcesToDelete = DATA.sources.filter(source => 
              source.source === sourceType && 
              !source.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || source.branch === currentUser.branch)
          );

          if (sourcesToDelete.length === 0) {
              Utils.showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ ÙÙŠ ÙØ±Ø¹Ùƒ', 'info');
              return;
          }

          if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù…Ù† "${sourceType}" Ø¨Ø³Ø¨Ø¨ "${reason}"ØŸ (${sourcesToDelete.length} Ù…ØµØ¯Ø±)`)) {
              let deletedCount = 0;
              let cannotDeleteCount = 0;

              sourcesToDelete.forEach(source => {
                  const activeBorrowing = DATA.borrowings.find(b => 
                      b.sourceId === source.id && !b.returned
                  );
                  
                  if (activeBorrowing) {
                      cannotDeleteCount++;
                  } else {
                      source.deleted = true;
                      source.status = 'Ù…Ø­Ø°ÙˆÙ';
                      source.deletedDate = new Date().toISOString();
                      source.deletedBy = currentUser.name;
                      source.deleteReason = reason;
                      deletedCount++;

                      // Add to deleted sources summary
                      const deletedRecord = {
                          id: Date.now() + Math.random(),
                          source: source.source,
                          copiesCount: source.copiesCount || 1,
                          deletedDate: new Date().toISOString(),
                          deletedBy: currentUser.name,
                          branch: source.branch,
                          reason: `Ø­Ø°Ù Ù…Ø¬Ù…Ø¹ Ù„Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯: ${sourceType} - ${reason}`
                      };
                      DATA.deletedSources.push(deletedRecord);
                  }
              });

              Storage.save();
              hideDeleteBySourceModal();
              loadSourcesTable();
              updateDashboard();

              let message = `ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…ØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­!`;
              if (cannotDeleteCount > 0) {
                  message += `\n${cannotDeleteCount} Ù…ØµØ¯Ø± Ù„Ù… ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù„Ø£Ù†Ù‡ Ù…Ø³ØªØ¹Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.`;
              }
              
              Utils.showAlert(message, 'success');
          }
      }

      function deleteAllSources() {
          if (currentUser.role !== 'admin') {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±.', 'danger');
              return;
          }

          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) {
              if (confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!')) {
                  DATA.sources = [];
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  Utils.showAlert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
              }
          }
      }

      function filterSources() {
          loadSourcesTable();
      }

      function resetSourceFilters() {
          ['sourceStatusFilter', 'sourceLibraryFilter', 'sourceSupplyFilter'].forEach(id => {
              const element = document.getElementById(id);
              if (element) element.value = 'all';
          });
          if (['admin', 'manager'].includes(currentUser.role)) {
              const branchFilter = document.getElementById('sourcesBranchFilter');
              if (branchFilter) branchFilter.value = 'all';
          }
          loadSourcesTable();
      }

   function searchSources() {
    const searchQuery = document.getElementById('sourceSearch').value.toLowerCase();
    const filteredSources = DATA.sources.filter(source => {
        return source.title.toLowerCase().includes(searchQuery) ||
               source.author.toLowerCase().includes(searchQuery);
    });
    displayFilteredSources(filteredSources);
}

      function displayFilteredSources(sources) {
          const tbody = document.getElementById('sourcesTable');
          tbody.innerHTML = sources.length === 0 ? 
              `<tr><td colspan="${currentUser.role === 'librarian' ? '16' : '17'}">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</td></tr>` :
              sources.map((source, index) => {
                  const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
                  const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
                  const actionsHtml = currentUser.role !== 'librarian' ? 
                      `<td>
                          <button class="btn btn-sm btn-warning" onclick="editSource(${source.id})">âœï¸</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteSource(${source.id})">ğŸ—‘ï¸</button>
                      </td>` : '';
                  
                  // Enhanced special notes highlighting and non-borrowable indication
                  const hasSpecialNotes = Utils.hasSpecialNotes(source);
                  const isNonBorrowable = NON_BORROWABLE_STATUSES.includes(source.status);
                  const rowClass = hasSpecialNotes || isNonBorrowable ? 
                      'class="not-borrowable"' : '';
                  
                  return `
                      <tr ${rowClass}>
                          <td>${index + 1}</td>
                          <td>${source.bibNumber || '-'}</td>
                          <td>${source.title}${hasSpecialNotes || isNonBorrowable ? ' <span class="notes-highlight"></span>' : ''}</td>
                          <td>${source.author}</td>
                          <td>${source.publisher || '-'}</td>
                          <td>${source.publishYear || '-'}</td>
                          <td>${source.language || '-'}</td>
                          <td>${source.deweyClassification || '-'}</td>
                          <td><span class="badge badge-secondary">${thematicClassification || '-'}</span></td>
                          <td>${source.copiesCount || 1}</td>
                          <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                          <td>${source.source || '-'}</td>
                          <td>${source.supplyDate ? Utils.formatDate(source.supplyDate) : '-'}</td>
                          <td>${source.shelfNumber || '-'}</td>
                          <td>${source.branch || '-'}</td>
                          <td><span class="badge badge-${Utils.getStatusColor(source.status)}">${source.status}</span></td>
                          ${actionsHtml}
                      </tr>
                  `;
              }).join('');
      }

      // Members Management - CRITICAL FIX: Updated for column removal and actions restoration
      function showAddMemberForm() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.', 'danger');
              return;
          }
          
          document.getElementById('membershipNumberInput').value = '';
          document.getElementById('addMemberForm').style.display = 'block';
      }

      function hideAddMemberForm() {
          document.getElementById('addMemberForm').style.display = 'none';
          document.getElementById('memberForm').reset();
      }

      function addMember(event) {
          event.preventDefault();
          
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.', 'danger');
              return;
          }
          
          const formData = new FormData(event.target);
          const membershipNumber = formData.get('membershipNumber').trim();
          const password = formData.get('userPassword');
          const fullName = formData.get('fullName').trim();
          const memberType = formData.get('memberType');
          const branch = formData.get('branch');
          
          // Validate required fields
          if (!membershipNumber || !password || !fullName || !memberType || !branch) {
              Utils.showAlert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙŠØ¬Ø¨ Ù…Ù„Ø¤Ù‡Ø§!', 'danger');
              return;
          }

          // Branch restriction for supervisors
          if (currentUser.role === 'supervisor' && branch !== currentUser.branch) {
             Utils.showAlert('Ø§Ù„Ù…Ø´Ø±Ù ÙŠÙ…ÙƒÙ†Ù‡ ÙÙ‚Ø· Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ø¶Ø§Ø¡ Ù„ÙØ±Ø¹Ù‡ ÙÙ‚Ø·!', 'danger');
              return;
          }
          
          // Check for existing membership number
          const existingMember = DATA.members.find(member => member.membershipNumber === membershipNumber);
          if (existingMember) {
              Utils.showAlert('Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹! Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø¹Ø¶ÙˆÙŠØ© Ø¢Ø®Ø±.', 'danger');
              return;
          }
          
          // Check for existing predefined account
          if (USER_ACCOUNTS[membershipNumber]) {
              Utils.showAlert('Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ù…Ø­Ø¬ÙˆØ² Ù„Ù„Ù†Ø¸Ø§Ù…! Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø¹Ø¶ÙˆÙŠØ© Ø¢Ø®Ø±.', 'danger');
              return;
          }
          
          // Validate password strength
          if (password.length < 4) {
              Utils.showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!', 'danger');
              return;
          }
          
          const member = {
              id: Date.now(),
              membershipNumber,
              password,
              fullName,
              memberType,
              branch,
              joinDate: new Date().toISOString(),
              borrowedSources: 0
          };
          
          DATA.members.push(member);
          Storage.save();
          
          loadMembersTable();
          hideAddMemberForm();
          updateDashboard();
          
          Utils.showAlert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­!\nØ±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${membershipNumber}`, 'success');
      }

      // CRITICAL FIX: Updated loadMembersTable - removed columns and added actions
      function loadMembersTable() {
    const tbody = document.getElementById('membersTable');
    tbody.innerHTML = '';
    
    const branchFilter = ['admin', 'manager'].includes(currentUser.role) ? 
        document.getElementById('membersBranchFilter')?.value : null;
    const filteredMembers = DataFilter.getFilteredMembers({ branch: branchFilter });
    
    if (filteredMembers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredMembers.map(member => {
        // Show actions for all members (except predefined for non-admin)
        const showActions = ['admin', 'supervisor'].includes(currentUser.role) && 
                           (!member.isPredefined || currentUser.role === 'admin');
        
        const actionsHtml = showActions ? 
            `<td>
                <button class="btn btn-sm btn-warning" onclick="editMember(${member.id})">âœï¸</button>
                <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id})">ğŸ—‘ï¸</button>
            </td>` : 
            '<td>-</td>';
        
        const memberTypeDisplay = member.isPredefined ? 
            `${member.memberType} <span class=""></span>` : 
            member.memberType;
        
        return `
            <tr ${member.isPredefined ? 'style="background-color: #f0f9ff;"' : ''}>
                <td>${member.membershipNumber}</td>
                <td>${member.fullName}</td>
                <td>${memberTypeDisplay}</td>
                <td>${member.branch}</td>
                ${actionsHtml}
            </tr>
        `;
    }).join('');
}

      function filterMembers() {
          loadMembersTable();
      }

      // CRITICAL FIX: Updated searchMembers - removed ID number from search
      function searchMembers() {
          const query = document.getElementById('memberSearch').value.toLowerCase();
          const filtered = DataFilter.getFilteredMembers({}).filter(member => 
              member.fullName.toLowerCase().includes(query) ||
              member.membershipNumber.toLowerCase().includes(query)
          );
          
          const tbody = document.getElementById('membersTable');
          tbody.innerHTML = filtered.length === 0 ? 
              '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</td></tr>' :
              filtered.map(member => {
                  const actionsHtml = ['admin', 'supervisor'].includes(currentUser.role) && !member.isPredefined ? 
                      `<td>
                          <button class="btn btn-sm btn-warning" onclick="editMember(${member.id})">âœï¸</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id})">ğŸ—‘ï¸</button>
                      </td>` : 
                      '<td>-</td>';
                  
                  const memberTypeDisplay = member.isPredefined ? 
                      `${member.memberType} <span class=""></span>` : 
                      member.memberType;
                  
                  return `
                      <tr ${member.isPredefined ? 'style="background-color: #f0f9ff;"' : ''}>
                          <td>${member.membershipNumber}</td>
                          <td>${member.fullName}</td>
                          <td>${memberTypeDisplay}</td>
                          <td>${member.branch}</td>
                          ${actionsHtml}
                      </tr>
                  `;
              }).join('');
      }

      // CRITICAL FIX: Updated Circulation System to prevent borrowing non-borrowable sources
      function loadMemberInfo() {
          const input = document.getElementById('memberBarcode').value;
          const memberInfo = document.getElementById('memberInfo');
          
          if (!input) {
              memberInfo.innerHTML = '';
              return;
          }
          
          // Check predefined accounts first
          const predefinedAccount = USER_ACCOUNTS[input];
          if (predefinedAccount) {
              const borrowedCount = DATA.borrowings.filter(b => 
                  b.membershipNumber === input && 
                  !b.returned &&
                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
              ).length;
              
              memberInfo.innerHTML = `
                  <div class="alert alert-success">
                      <strong>${predefinedAccount.name}</strong><br>
                      Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${input}<br>
                      Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${predefinedAccount.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' : predefinedAccount.role === 'supervisor' ? 'Ù…Ø´Ø±Ù ÙØ±Ø¹' : predefinedAccount.role === 'manager' ? 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…' : 'Ø£Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø©'}<br>
                      Ø§Ù„ÙØ±Ø¹: ${predefinedAccount.branch}<br>
                      Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©: ${borrowedCount}
                  </div>
              `;
              checkCirculationButtons();
              return;
          }
          
          // Check custom members
          const member = DATA.members.find(m => 
              m.membershipNumber === input || 
              m.id.toString() === input
          );
          
          if (member) {
              const borrowedCount = DATA.borrowings.filter(b => 
                  b.membershipNumber === member.membershipNumber && 
                  !b.returned &&
                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
              ).length;
              
              memberInfo.innerHTML = `
                  <div class="alert alert-success">
                      <strong>${member.fullName}</strong><br>
                      Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${member.membershipNumber}<br>
                      Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${member.memberType}<br>
                      Ø§Ù„ÙØ±Ø¹: ${member.branch}<br>
                      Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©: ${borrowedCount}
                  </div>
              `;
              checkCirculationButtons();
          } else {
              memberInfo.innerHTML = '<div class="alert alert-danger">Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!</div>';
          }
      }

      function loadSourceInfo() {
          const input = document.getElementById('sourceBarcode').value;
          const sourceInfo = document.getElementById('sourceInfo');
          
          if (!input) {
              sourceInfo.innerHTML = '';
              return;
          }
          
          // Find source - restrict to current branch for non-admin/manager users
          const source = DATA.sources.find(s => 
              (s.bibNumber === input || s.id.toString() === input) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (source) {
              const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
              const availableCopies = source.copiesCount - DATA.borrowings.filter(b => 
                  b.sourceId === source.id && !b.returned
              ).length;
              
              // CRITICAL FIX: Check if source is borrowable
              const isBorrowable = Utils.isBorrowable(source);
              const borrowableText = isBorrowable ? 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©' : 'ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©';
              const alertType = isBorrowable && availableCopies > 0 ? 'success' : 'warning';
              
              sourceInfo.innerHTML = `
                  <div class="alert alert-${alertType}">
                      <strong>${source.title}</strong><br>
                      Ø§Ù„Ù…Ø¤Ù„Ù: ${source.author}<br>
                      Ø±Ù‚Ù… BIB: ${source.bibNumber}<br>
                      Ø§Ù„Ù…ÙƒØªØ¨Ø©: <span class="library-type ${libraryType.class}">${libraryType.name}</span><br>
                      Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ØªØ§Ø­Ø©: ${availableCopies} Ù…Ù† ${source.copiesCount}<br>
                      Ø§Ù„ÙØ±Ø¹: ${source.branch}<br>
                      Ø§Ù„Ø­Ø§Ù„Ø©: ${source.status}<br>
                      <strong style="color: ${isBorrowable ? 'green' : 'red'};">${borrowableText}</strong>
                      ${!isBorrowable ? '<br><small>Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø±ØªÙ‡ Ø¨Ø³Ø¨Ø¨ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø®Ø§ØµØ©</small>' : ''}
                  </div>
              `;
              checkCirculationButtons();
          } else {
              sourceInfo.innerHTML = '<div class="alert alert-danger">Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù…Ø­Ø°ÙˆÙ Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ÙØ±Ø¹Ùƒ!</div>';
          }
      }

      function checkCirculationButtons() {
          const memberInput = document.getElementById('memberBarcode').value;
          const sourceInput = document.getElementById('sourceBarcode').value;
          const borrowBtn = document.getElementById('borrowBtn');
          const returnBtn = document.getElementById('returnBtn');
          
          // Find member
          const predefinedAccount = USER_ACCOUNTS[memberInput];
          const member = predefinedAccount || DATA.members.find(m => 
              m.membershipNumber === memberInput || 
              m.id.toString() === memberInput
          );
          
          // Find source - restrict to current branch
          const source = DATA.sources.find(s => 
              (s.bibNumber === sourceInput || s.id.toString() === sourceInput) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (member && source) {
              const availableCopies = source.copiesCount - DATA.borrowings.filter(b => 
                  b.sourceId === source.id && !b.returned
              ).length;
              
              const memberBorrowedThis = DATA.borrowings.find(b => 
                  b.membershipNumber === (member.membershipNumber || memberInput) && 
                  b.sourceId === source.id && 
                  !b.returned
              );
              
              // CRITICAL FIX: Check if source is borrowable
              const isBorrowable = Utils.isBorrowable(source);
              
              if (memberBorrowedThis) {
                  borrowBtn.disabled = true;
                  returnBtn.disabled = false;
              } else if (availableCopies > 0 && isBorrowable) {
                  borrowBtn.disabled = false;
                  returnBtn.disabled = true;
              } else {
                  borrowBtn.disabled = true;
                  returnBtn.disabled = true;
              }
          } else {
              borrowBtn.disabled = true;
              returnBtn.disabled = true;
          }
      }

      function borrowSource() {
          const memberInput = document.getElementById('memberBarcode').value;
          const sourceInput = document.getElementById('sourceBarcode').value;
          
          // Find member
          const predefinedAccount = USER_ACCOUNTS[memberInput];
          const member = predefinedAccount || DATA.members.find(m => 
              m.membershipNumber === memberInput || 
              m.id.toString() === memberInput
          );
          
          // Find source - restrict to current branch
          const source = DATA.sources.find(s => 
              (s.bibNumber === sourceInput || s.id.toString() === sourceInput) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (!member || !source) {
              Utils.showAlert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ÙØ±Ø¹Ùƒ!', 'danger');
              return;
          }
          
          // Additional branch permission check
          if (!['admin', 'manager'].includes(currentUser.role) && source.branch !== currentUser.branch) {
              Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø±Ø© Ù…ØµØ¯Ø± Ù…Ù† ÙØ±Ø¹ Ø¢Ø®Ø±!', 'warning');
              return;
          }
          
          // CRITICAL FIX: Check if source is borrowable
          if (!Utils.isBorrowable(source)) {
              Utils.showAlert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø© Ø¨Ø³Ø¨Ø¨ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø®Ø§ØµØ©!', 'warning');
              return;
          }
          
          // Check available copies
          const currentBorrowings = DATA.borrowings.filter(b => 
              b.sourceId === source.id && !b.returned
          ).length;
          
          if (currentBorrowings >= source.copiesCount) {
              Utils.showAlert('Ø¬Ù…ÙŠØ¹ Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…Ø³ØªØ¹Ø§Ø±Ø©!', 'warning');
              return;
          }
          
          // CRITICAL FIX: For sources with two copies, only one can be borrowed at a time (for special sources)
          if (Utils.hasSpecialNotes(source) && source.copiesCount > 1 && currentBorrowings >= 1) {
              Utils.showAlert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù„Ù‡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© - ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¹Ø§Ø±Ø© Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©!', 'warning');
              return;
          }
          
          // Check if member already borrowed this source
          const membershipNumber = member.membershipNumber || memberInput;
          const existingBorrowing = DATA.borrowings.find(b => 
              b.membershipNumber === membershipNumber && 
              b.sourceId === source.id && 
              !b.returned
          );
          
          if (existingBorrowing) {
              Utils.showAlert('Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ø³ØªØ¹Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹!', 'warning');
              return;
          }
          
          const borrowDate = new Date();
          const dueDate = Utils.getEndOfDay(borrowDate);
          
          const borrowing = {
              id: Date.now(),
              membershipNumber,
              sourceId: source.id,
              borrowDate: borrowDate.toISOString(),
              dueDate: dueDate.toISOString(),
              returned: false,
              employeeName: currentUser.name,
              branch: ['admin', 'manager'].includes(currentUser.role) ? source.branch : currentUser.branch
          };
          
          DATA.borrowings.push(borrowing);
          
          // Update source status if all copies are borrowed
          if (currentBorrowings + 1 >= source.copiesCount) {
              source.status = 'Ù…Ø³ØªØ¹Ø§Ø±';
          }
          
          Storage.save();
          
          const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
          
          document.getElementById('circulationResult').innerHTML = `
              <div class="alert alert-success">
                  <h4>ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­!</h4>
                  <p><strong>Ø§Ù„Ø¹Ø¶Ùˆ:</strong> ${member.fullName || member.name}</p>
                  <p><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${source.title}</p>
                  <p><strong>Ø§Ù„Ù…ÙƒØªØ¨Ø©:</strong> <span class="library-type ${libraryType.class}">${libraryType.name}</span></p>
                  <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©:</strong> ${Utils.formatDate(borrowDate.toISOString())}</p>
                  <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong> ${Utils.formatDate(dueDate.toISOString())} - 11:59 Ù…Ø³Ø§Ø¡Ù‹</p>
                  <p><strong>Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©:</strong> Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</p>
                  <p><strong>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> ${currentUser.name}</p>
                  <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${borrowing.branch}</p>
              </div>
          `;
          
          clearCirculation();
          loadActiveBorrowings();
          updateDashboard();
      }

      function returnSource() {
          const memberInput = document.getElementById('memberBarcode').value;
          const sourceInput = document.getElementById('sourceBarcode').value;
          
          // Find member
          const predefinedAccount = USER_ACCOUNTS[memberInput];
          const member = predefinedAccount || DATA.members.find(m => 
              m.membershipNumber === memberInput || 
              m.id.toString() === memberInput
          );
          
          // Find source - restrict to current branch
          const source = DATA.sources.find(s => 
              (s.bibNumber === sourceInput || s.id.toString() === sourceInput) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (!member || !source) {
              Utils.showAlert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ÙØ±Ø¹Ùƒ!', 'danger');
              return;
          }
          
          const membershipNumber = member.membershipNumber || memberInput;
          const borrowing = DATA.borrowings.find(b => 
              b.membershipNumber === membershipNumber && 
              b.sourceId === source.id && 
              !b.returned
          );
          
          if (!borrowing) {
              Utils.showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø© Ù†Ø´Ø·Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ!', 'warning');
              return;
          }
          
          borrowing.returned = true;
          borrowing.returnDate = new Date().toISOString();
          borrowing.returnEmployeeName = currentUser.name;
          
          // Check if we should make source available again
          const remainingBorrowings = DATA.borrowings.filter(b => 
              b.sourceId === source.id && !b.returned
          ).length;
          
          if (remainingBorrowings === 0 && Utils.isBorrowable(source)) {
              source.status = 'Ù…ØªØ§Ø­';
          }
          
          Storage.save();
          
          const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
          const dueDate = new Date(borrowing.dueDate);
          const returnDate = new Date(borrowing.returnDate);
          const isLate = returnDate > dueDate;
          
          document.getElementById('circulationResult').innerHTML = `
              <div class="alert alert-success">
                  <h4>ØªÙ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­!</h4>
                  <p><strong>Ø§Ù„Ø¹Ø¶Ùˆ:</strong> ${member.fullName || member.name}</p>
                  <p><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${source.title}</p>
                  <p><strong>Ø§Ù„Ù…ÙƒØªØ¨Ø©:</strong> <span class="library-type ${libraryType.class}">${libraryType.name}</span></p>
                  <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:</strong> ${Utils.formatDate(borrowing.returnDate)} - ${returnDate.toLocaleTimeString('ar')}</p>
                  <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:</strong> <span class="badge ${isLate ? 'badge-warning' : 'badge-success'}">${isLate ? 'Ù…ØªØ£Ø®Ø±' : 'ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯'}</span></p>
                  <p><strong>Ù…ÙˆØ¸Ù Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:</strong> ${currentUser.name}</p>
              </div>
          `;
          
          clearCirculation();
          loadActiveBorrowings();
          updateDashboard();
      }

      function clearCirculation() {
          document.getElementById('sourceBarcode').value = '';
          document.getElementById('memberInfo').innerHTML = '';
          document.getElementById('sourceInfo').innerHTML = '';
          document.getElementById('borrowBtn').disabled = true;
          document.getElementById('returnBtn').disabled = true;
          
          // Keep member info if membership ID is set
          const memberBarcodeInput = document.getElementById('memberBarcode');
          if (memberBarcodeInput.value) {
              setTimeout(() => {
                  loadMemberInfo();
              }, 100);
          }
      }

      function loadActiveBorrowings() {
          const tbody = document.getElementById('activeBorrowings');
          const active = DataFilter.getFilteredBorrowings({}).filter(b => !b.returned);
          
          if (active.length === 0) {
              tbody.innerHTML = '<tr><td colspan="9">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©</td></tr>';
              return;
          }
          
          tbody.innerHTML = active.map(borrowing => {
              const member = DATA.members.find(m => m.membershipNumber === borrowing.membershipNumber) ||
                            USER_ACCOUNTS[borrowing.membershipNumber];
              const source = DATA.sources.find(s => s.id === borrowing.sourceId);
              const dueDate = new Date(borrowing.dueDate);
              const now = new Date();
              const hoursLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60));
              const libraryType = source ? Utils.getLibraryTypeFromBib(source.bibNumber) : { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', class: 'library-unknown' };
              
              return `
                  <tr>
                      <td>${member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                      <td>${source ? source.title : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                      <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                      <td>${Utils.formatDate(borrowing.borrowDate)}</td>
                      <td>${Utils.formatDate(borrowing.dueDate)}</td>
                      <td><span class="badge badge-${hoursLeft < 0 ? 'danger' : hoursLeft <= 6 ? 'warning' : 'success'}">
                          ${hoursLeft < 0 ? `Ù…ØªØ£Ø®Ø± ${Math.abs(hoursLeft)} Ø³Ø§Ø¹Ø©` : `${hoursLeft} Ø³Ø§Ø¹Ø©`}
                      </span></td>
                      <td>${borrowing.employeeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                      <td>${borrowing.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                      <td>
                          <button class="btn btn-sm btn-warning" onclick="renewBorrowing(${borrowing.id})">ØªØ¬Ø¯ÙŠØ¯</button>
                          <button class="btn btn-sm btn-success" onclick="quickReturn(${borrowing.id})">Ø¥Ø±Ø¬Ø§Ø¹</button>
                      </td>
                  </tr>
              `;
          }).join('');
      }

      // Advanced Search - Updated for Dewey classification
      function performAdvancedSearch() {
          const searchCriteria = {
              title: document.getElementById('searchTitle').value.toLowerCase(),
              author: document.getElementById('searchAuthor').value.toLowerCase(),
              bib: document.getElementById('searchBib').value.toLowerCase(),
              dewey: document.getElementById('searchDewey').value.toLowerCase(),
              yearFrom: document.getElementById('searchYearFrom').value,
              yearTo: document.getElementById('searchYearTo').value,
              library: document.getElementById('searchLibrary').value,
              status: document.getElementById('searchStatus').value
          };
          
          const results = DataFilter.getFilteredSources({}).filter(source => {
              let matches = true;
              
              if (searchCriteria.title && !source.title.toLowerCase().includes(searchCriteria.title)) matches = false;
              if (searchCriteria.author && !source.author.toLowerCase().includes(searchCriteria.author)) matches = false;
              if (searchCriteria.bib && !source.bibNumber.toLowerCase().includes(searchCriteria.bib)) matches = false;
if (searchCriteria.dewey && !source.deweyClassification.toLowerCase().includes(searchCriteria.dewey)) matches = false;
              if (searchCriteria.yearFrom && source.publishYear < searchCriteria.yearFrom) matches = false;
              if (searchCriteria.yearTo && source.publishYear > searchCriteria.yearTo) matches = false;
              if (searchCriteria.library && source.library !== searchCriteria.library) matches = false;
              if (searchCriteria.status && source.status !== searchCriteria.status) matches = false;
              
              return matches;
          });
          
          displaySearchResults(results);
      }

      function displaySearchResults(results) {
          const table = document.getElementById('searchResults');
          const tbody = document.getElementById('searchResultsBody');
          
          tbody.innerHTML = results.length === 0 ? 
              '<tr><td colspan="9">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</td></tr>' :
              results.map(source => {
                  const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
                  const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
                  
                  return `
                      <tr>
                          <td>${source.bibNumber || '-'}</td>
                          <td>${source.title}</td>
                          <td>${source.author}</td>
                          <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                          <td>${source.publishYear || '-'}</td>
                          <td><span class="badge badge-${Utils.getStatusColor(source.status)}">${source.status}</span></td>
                          <td><span class="badge badge-secondary">${thematicClassification || '-'}</span></td>
                          <td>${source.location || '-'}</td>
                          <td>${source.branch || '-'}</td>
                      </tr>
                  `;
              }).join('');
          
          table.style.display = 'table';
      }

      function clearSearch() {
          ['searchTitle', 'searchAuthor', 'searchBib', 'searchDewey', 'searchYearFrom', 'searchYearTo', 'searchLibrary', 'searchStatus']
              .forEach(id => document.getElementById(id).value = '');
          document.getElementById('searchResults').style.display = 'none';
      }

      function generateReadingReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        Utils.showAlert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'warning');
        return;
    }

    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);

    // Get borrowings that were RETURNED within the date range to count them as "read"
    const returnedBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
        if (!b.returned || !b.returnDate) return false;
        const returnDate = new Date(b.returnDate);
        return returnDate >= start && returnDate <= end;
    });

    if (returnedBorrowings.length === 0) {
        showReport('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©', '<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ (Ù…Ù‚Ø±ÙˆØ¡Ø©) ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</div>');
        currentReportData = [];
        currentReportType = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…ØµØ§Ø¯Ø±_Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©';
        return;
    }
    
    const readingStats = {};
    returnedBorrowings.forEach(borrowing => {
        const source = DATA.sources.find(s => s.id === borrowing.sourceId);
        if (!source) return;
        
        const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
        const ageGroup = libraryType.type === 'child' ? 'Ø£Ø·ÙØ§Ù„' : 
                         libraryType.type === 'youth' ? 'ÙŠØ§ÙØ¹ÙŠÙ†' : 'Ø¹Ø§Ù…';

        if (!readingStats[source.id]) {
            readingStats[source.id] = {
                title: source.title,
                author: source.author,
                bibNumber: source.bibNumber,
                branch: source.branch,
                library: libraryType.name,
                ageGroup: ageGroup, // Add age group here
                readCount: 0,
            };
        }
        readingStats[source.id].readCount++;
    });

    const sortedStats = Object.values(readingStats).sort((a, b) => b.readCount - a.readCount);
    const mostReadSource = sortedStats[0];

    let content = `
        <h4>ğŸ“– ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</h4>
        <div class="alert alert-info">
            <strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† ${Utils.formatDate(startDate)} Ø¥Ù„Ù‰ ${Utils.formatDate(endDate)}<br>
            <strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}<br>
            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹):</strong> ${returnedBorrowings.length} Ø¹Ù…Ù„ÙŠØ©<br>
            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©:</strong> ${sortedStats.length} Ù…ØµØ¯Ø±<br>
            ${mostReadSource ? `<strong>Ø£ÙƒØ«Ø± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù‚Ø±Ø§Ø¡Ø©:</strong> "${mostReadSource.title}" (${mostReadSource.readCount} Ù…Ø±Ø©)` : ''}
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                        <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØµØ¯Ø±</th>
                        <th>Ø§Ù„Ù…Ø¤Ù„Ù</th>
                        <th>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
                        <th>Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedStats.map((stat, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${stat.title}</td>
                            <td>${stat.author}</td>
                            <td><span class="badge badge-primary">${stat.readCount}</span></td>
                            <td>${stat.ageGroup}</td>
                            <td>${stat.branch}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>

        <h5 style="margin-top: 2rem;">ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©:</h5>
        <div class="stats-grid" style="margin-top: 1rem;">
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.readCount >= 3).length}</div>
                <div class="stat-label">Ù…ØµØ§Ø¯Ø± Ù‚ÙØ±Ø¦Øª 3 Ù…Ø±Ø§Øª Ø£Ùˆ Ø£ÙƒØ«Ø±</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.ageGroup === 'Ø£Ø·ÙØ§Ù„').reduce((acc, s) => acc + s.readCount, 0)}</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.ageGroup === 'ÙŠØ§ÙØ¹ÙŠÙ†').reduce((acc, s) => acc + s.readCount, 0)}</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.ageGroup === 'Ø¹Ø§Ù…').reduce((acc, s) => acc + s.readCount, 0)}</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            </div>
        </div>
    `;

    showReport('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©', content);

    currentReportData = sortedStats.map((stat, index) => ({
        'Ø§Ù„ØªØ±ØªÙŠØ¨': index + 1,
        'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØµØ¯Ø±': stat.title,
        'Ø§Ù„Ù…Ø¤Ù„Ù': stat.author,
        'Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©': stat.readCount,
        'Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©': stat.ageGroup,
        'Ø§Ù„ÙØ±Ø¹': stat.branch
    }));
    currentReportType = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…ØµØ§Ø¯Ø±_Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©';
}

      // Updated Report Functions
      function generateDailyReport() {
          const today = new Date();
          const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
          
          const todayBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
              const borrowDate = new Date(b.borrowDate);
              return borrowDate >= startOfDay && borrowDate <= endOfDay;
          });
          
          const todayReturns = DataFilter.getFilteredBorrowings({}).filter(b => {
              if (!b.returnDate) return false;
              const returnDate = new Date(b.returnDate);
              return returnDate >= startOfDay && returnDate <= endOfDay;
          });
          
          const content = `
              <h4>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ - ${Utils.formatDate(today.toISOString())}</h4>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…:</strong> ${todayBorrowings.length}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…:</strong> ${todayReturns.length}</p>
              
              <h5>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…:</h5>
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
                              <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                              <th>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</th>
                              <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                              <th>Ø§Ù„ÙØ±Ø¹</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${todayBorrowings.length === 0 ? 
                              '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</td></tr>' :
                              todayBorrowings.map(b => {
                                  const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) ||
                                                USER_ACCOUNTS[b.membershipNumber];
                                  const source = DATA.sources.find(s => s.id === b.sourceId);
                                  return `
                                      <tr>
                                          <td>${member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                          <td>${source ? source.title : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                          <td>${new Date(b.borrowDate).toLocaleTimeString('ar')}</td>
                                          <td>${b.employeeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                          <td>${b.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                      </tr>
                                  `;
                              }).join('')
                          }
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ', content);
          
          // Store for export
          currentReportData = todayBorrowings.map(b => {
              const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) ||
                            USER_ACCOUNTS[b.membershipNumber];
              const source = DATA.sources.find(s => s.id === b.sourceId);
              return {
                  'Ø§Ù„Ø¹Ø¶Ùˆ': member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                  'Ø§Ù„Ù…ØµØ¯Ø±': source ? source.title : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                  'ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©': new Date(b.borrowDate).toLocaleString('ar'),
                  'Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„': b.employeeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                  'Ø§Ù„ÙØ±Ø¹': b.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
              };
          });
          currentReportType = 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ÙŠÙˆÙ…ÙŠ';
      }

      function generateWeeklyReport() {
          const today = new Date();
          const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
          
          const weekBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
              const borrowDate = new Date(b.borrowDate);
              return borrowDate >= weekAgo && borrowDate <= today;
          });
          
          const weekReturns = DataFilter.getFilteredBorrowings({}).filter(b => {
              if (!b.returnDate) return false;
              const returnDate = new Date(b.returnDate);
              return returnDate >= weekAgo && returnDate <= today;
          });
          
          const content = `
              <h4>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h4>
              <p><strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† ${Utils.formatDate(weekAgo.toISOString())} Ø¥Ù„Ù‰ ${Utils.formatDate(today.toISOString())}</p>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª:</strong> ${weekBorrowings.length}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª:</strong> ${weekReturns.length}</p>
              
              <h5>Ø£ÙƒØ«Ø± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø¥Ø¹Ø§Ø±Ø©:</h5>
              ${getMostBorrowedSources(weekBorrowings)}
          `;
          
          showReport('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ', content);
      }

      function generateMonthlyReport() {
          const today = new Date();
          const monthAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
          
          const monthBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
              const borrowDate = new Date(b.borrowDate);
              return borrowDate >= monthAgo && borrowDate <= today;
          });
          
          const monthReturns = DataFilter.getFilteredBorrowings({}).filter(b => {
              if (!b.returnDate) return false;
              const returnDate = new Date(b.returnDate);
              return returnDate >= monthAgo && returnDate <= today;
          });
          
          const content = `
              <h4>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h4>
              <p><strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† ${Utils.formatDate(monthAgo.toISOString())} Ø¥Ù„Ù‰ ${Utils.formatDate(today.toISOString())}</p>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª:</strong> ${monthBorrowings.length}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª:</strong> ${monthReturns.length}</p>
              
              <h5>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©:</h5>
              ${getMonthlyStatistics(monthBorrowings)}
          `;
          
          showReport('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ', content);
      }

      function generateMembersReport() {
          if (!['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.', 'danger');
              return;
          }
          
          const members = DataFilter.getFilteredMembers({});
          const content = `
              <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h4>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:</strong> ${members.length}</p>
              
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                              <th>Ø§Ù„Ø§Ø³Ù…</th>
                              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                              <th>Ø§Ù„ÙØ±Ø¹</th>
                              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                              <th>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</th>
                         <th style="border-right: 1px solid rgba(255,255,255,0.1);">Ø§Ù„ÙØ±Ø¹</th>
    </tr>
                      </thead>
                      <tbody>
                          ${members.map(member => {
                              const borrowedCount = DATA.borrowings.filter(b => 
                                  b.membershipNumber === member.membershipNumber && 
                                  !b.returned &&
                                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
                              ).length;
                              
                              return `
                                  <tr>
                                      <td>${member.membershipNumber}</td>
                                      <td>${member.fullName}</td>
                                      <td>${member.memberType}</td>
                                      <td>${member.branch}</td>
                                      <td>${Utils.formatDate(member.joinDate)}</td>
                                      <td>${borrowedCount}</td>
                                  </tr>
                              `;
                          }).join('')}
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡', content);
      }

function generateBorrowingReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        Utils.showAlert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }

    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999); // Ensure the end date includes the entire day

    const periodBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
        const borrowDate = new Date(b.borrowDate);
        return borrowDate >= start && borrowDate <= end;
    });

    const activeBorrowings = periodBorrowings.filter(b => !b.returned);
    const completedBorrowings = periodBorrowings.filter(b => b.returned);

    let content = `
        <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙØµÙ„</h4>
        <div class="alert alert-info">
            <strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† ${Utils.formatDate(startDate)} Ø¥Ù„Ù‰ ${Utils.formatDate(endDate)}<br>
            <strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}<br>
            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø©:</strong> ${periodBorrowings.length}<br>
            <strong>Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:</strong> ${activeBorrowings.length}<br>
            <strong>Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</strong> ${completedBorrowings.length}
        </div>

        <h5>Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© (${activeBorrowings.length})</h5>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                    </tr>
                </thead>
                <tbody>
                    ${activeBorrowings.length === 0 ? '<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>' :
                    activeBorrowings.map(b => {
                        const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) || USER_ACCOUNTS[b.membershipNumber];
                        const source = DATA.sources.find(s => s.id === b.sourceId);
                        const isOverdue = new Date(b.dueDate) < new Date();
                        return `
                            <tr>
                                <td>${member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                <td>${source ? source.title : 'Ù…ØµØ¯Ø± Ù…Ø­Ø°ÙˆÙ'}</td>
                                <td>${Utils.formatDate(b.borrowDate)}</td>
                                <td>${Utils.formatDate(b.dueDate)}</td>
                                <td><span class="badge ${isOverdue ? 'badge-danger' : 'badge-success'}">${isOverdue ? 'Ù…ØªØ£Ø®Ø±' : 'Ù†Ø´Ø·'}</span></td>
                                <td>${b.branch || '-'}</td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>

        <h5 style="margin-top: 2rem;">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (${completedBorrowings.length})</h5>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                    </tr>
                </thead>
                <tbody>
                    ${completedBorrowings.length === 0 ? '<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>' :
                    completedBorrowings.map(b => {
                        const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) || USER_ACCOUNTS[b.membershipNumber];
                        const source = DATA.sources.find(s => s.id === b.sourceId);
                        const isLate = new Date(b.returnDate) > new Date(b.dueDate);
                        return `
                            <tr>
                                <td>${member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                <td>${source ? source.title : 'Ù…ØµØ¯Ø± Ù…Ø­Ø°ÙˆÙ'}</td>
                                <td>${Utils.formatDate(b.borrowDate)}</td>
                                <td>${Utils.formatDate(b.returnDate)}</td>
                                <td><span class="badge ${isLate ? 'badge-warning' : 'badge-success'}">${isLate ? 'Ù…ØªØ£Ø®Ø±' : 'ÙÙŠ Ø§Ù„ÙˆÙ‚Øª'}</span></td>
                                <td>${b.branch || '-'}</td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;

    showReport('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙØµÙ„', content);

    // Prepare data for export
    currentReportData = periodBorrowings.map(b => {
        const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) || USER_ACCOUNTS[b.membershipNumber];
        const source = DATA.sources.find(s => s.id === b.sourceId);
        return {
            'Ø§Ù„Ø¹Ø¶Ùˆ': member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'Ø§Ù„Ù…ØµØ¯Ø±': source ? source.title : 'Ù…ØµØ¯Ø± Ù…Ø­Ø°ÙˆÙ',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©': Utils.formatDate(b.borrowDate),
            'Ø§Ù„Ø­Ø§Ù„Ø©': b.returned ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù†Ø´Ø·',
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹': b.returnDate ? Utils.formatDate(b.returnDate) : '-',
            'Ø§Ù„ÙØ±Ø¹': b.branch
        };
    });
    currentReportType = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª';
}

      function generateLibraryTypeReport() {
          const sources = DataFilter.getFilteredSources({});
          const mainSources = sources.filter(s => Utils.getLibraryTypeFromBib(s.bibNumber).type === 'main');
          const youthSources = sources.filter(s => Utils.getLibraryTypeFromBib(s.bibNumber).type === 'youth');
          const childSources = sources.filter(s => Utils.getLibraryTypeFromBib(s.bibNumber).type === 'child');
          
          const content = `
              <h4>ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©</h4>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}</p>
              
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${mainSources.length}</div>
                      <div class="stat-label">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${youthSources.length}</div>
                      <div class="stat-label">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${childSources.length}</div>
                      <div class="stat-label">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„</div>
                  </div>
              </div>
              
              <h5>ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ù…ÙƒØªØ¨Ø©:</h5>
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©</th>
                              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø±</th>
                              <th>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©</th>
                              <th>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</th>
                              <th>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ§Ù„ÙØ©</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${[
                              ['Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', mainSources],
                              ['Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†', youthSources],
                              ['Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„', childSources]
                          ].map(([name, sources]) => `
                              <tr>
                                  <td>${name}</td>
                                  <td>${sources.length}</td>
                                  <td>${sources.filter(s => s.status === 'Ù…ØªØ§Ø­').length}</td>
                                  <td>${sources.filter(s => s.status === 'Ù…Ø³ØªØ¹Ø§Ø±').length}</td>
                                  <td>${sources.filter(s => s.status === 'ØªØ§Ù„Ù').length}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©', content);
      }

      // CRITICAL FIX: Enhanced generateStatisticsReport with complete status and Dewey categories
      function generateStatisticsReport() {
          const sources = DataFilter.getFilteredSources({});
          const members = DataFilter.getFilteredMembers({});
          const borrowings = DataFilter.getFilteredBorrowings({});
          
          let content = `
              <h4>ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ Ø´Ø§Ù…Ù„</h4>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}</p>
              <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> ${Utils.formatDate(new Date().toISOString())}</p>
              
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${sources.length}</div>
                      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø±</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${members.length}</div>
                      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${borrowings.length}</div>
                      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${borrowings.filter(b => !b.returned).length}</div>
                      <div class="stat-label">Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
                  </div>
              </div>
              
              <h5>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø­Ø¯Ø«):</h5>
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                              <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                              <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                          </tr>
                      </thead>
                      <tbody>
          `;
          
          // CRITICAL FIX: Include all status categories
          const allStatuses = [
              'Ù…ØªØ§Ø­', 'Ù…Ø³ØªØ¹Ø§Ø±', 'ØªØ§Ù„Ù',
              'BIB Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠØ­Ø©', 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø®Ø§Ù„Ù',
              'Ø§Ù„ØªØµÙ†ÙŠÙ Ø®Ø§Ø·Ø¦', 'ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©', 'Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…', 'Ù…ÙƒØ±Ø±'
          ];
          
          allStatuses.forEach(status => {
              const count = sources.filter(s => s.status === status).length;
              if (count > 0) {
                  const percentage = sources.length ? ((count / sources.length) * 100).toFixed(1) : 0;
                  content += `
                      <tr>
                          <td>${status}</td>
                          <td>${count}</td>
                          <td>${percentage}%</td>
                      </tr>
                  `;
              }
          });
          
          content += `
                      </tbody>
                  </table>
              </div>
              
              ${getDeweyClassificationReport(sources)}
          `;
          
          showReport('ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ Ø´Ø§Ù…Ù„', content);
      }

      function generateDeletedSourcesReport() {
          if (currentUser.role !== 'admin') {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.', 'danger');
              return;
          }
          
          const deletedSources = DATA.sources.filter(s => s.deleted);
          
          let content = `
              <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h4>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:</strong> ${deletedSources.length}</p>
              
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                              <th>Ø§Ù„Ù…Ø¤Ù„Ù</th>
                              <th>Ø±Ù‚Ù… BIB</th>
                              <th>Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</th>
                              <th>Ø§Ù„ÙØ±Ø¹</th>
                              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø°Ù</th>
                              <th>Ø§Ù„Ù…Ø­Ø°ÙˆÙ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                              <th>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù</th>
                          </tr>
                      </thead>
                      <tbody>
          `;
          
          if (deletedSources.length === 0) {
              content += '<tr><td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± Ù…Ø­Ø°ÙˆÙØ©</td></tr>';
          } else {
              content += deletedSources.map(source => `
                  <tr>
                      <td>${source.title}</td>
                      <td>${source.author}</td>
                      <td>${source.bibNumber}</td>
                      <td>${source.source || '-'}</td>
                      <td>${source.branch || '-'}</td>
                      <td>${source.deletedDate ? Utils.formatDate(source.deletedDate) : '-'}</td>
                      <td>${source.deletedBy || '-'}</td>
                      <td>${source.deleteReason || 'Ø­Ø°Ù ÙŠØ¯ÙˆÙŠ'}</td>
                  </tr>
              `).join('');
          }
          
          content += `
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', content);
          
          // Prepare data for export
          currentReportData = deletedSources.map(source => ({
              'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': source.title,
              'Ø§Ù„Ù…Ø¤Ù„Ù': source.author,
              'Ø±Ù‚Ù… BIB': source.bibNumber,
              'Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯': source.source || '-',
              'Ø§Ù„ÙØ±Ø¹': source.branch || '-',
              'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø°Ù': source.deletedDate ? Utils.formatDate(source.deletedDate) : '-',
              'Ø§Ù„Ù…Ø­Ø°ÙˆÙ Ø¨ÙˆØ§Ø³Ø·Ø©': source.deletedBy || '-',
              'Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù': source.deleteReason || 'Ø­Ø°Ù ÙŠØ¯ÙˆÙŠ'
          }));
          currentReportType = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…ØµØ§Ø¯Ø±_Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©';
      }

      function generateSourcesReport() {
          const sources = DataFilter.getFilteredSources({});
          const content = `
              <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø´Ø§Ù…Ù„</h4>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch}</p>
              <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø±:</strong> ${sources.length}</p>
              <p><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:</strong> ${sources.filter(s => s.status === 'Ù…ØªØ§Ø­').length}</p>
              <p><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©:</strong> ${sources.filter(s => s.status === 'Ù…Ø³ØªØ¹Ø§Ø±').length}</p>
              <p><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ§Ù„ÙØ©:</strong> ${sources.filter(s => s.status === 'ØªØ§Ù„Ù').length}</p>
              <p><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${sources.filter(s => Utils.hasSpecialNotes(s)).length}</p>
              
              <h5>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø­Ø³Ø¨ ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ:</h5>
              ${getDeweyClassificationReport(sources)}
              
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr><th>Ø§Ù„Ù„ØºØ©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ø±</th></tr>
                      </thead>
                      <tbody>
                          ${getLanguageReport(sources)}
                      </tbody>
                  </table>
              </div>
          `;
          showReport('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ø±', content);
      }

      // Helper functions for reports
      function getMostBorrowedSources(borrowings) {
          const sourceCounts = {};
          borrowings.forEach(b => {
              const source = DATA.sources.find(s => s.id === b.sourceId);
              if (source) {
                  sourceCounts[source.title] = (sourceCounts[source.title] || 0) + 1;
              }
          });
          
          const sorted = Object.entries(sourceCounts)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 5);
          
          if (sorted.length === 0) {
              return '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</p>';
          }
          
          return `
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${sorted.map(([title, count]) => `
                              <tr>
                                  <td>${title}</td>
                                  <td>${count}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              </div>
          `;
      }

      function getMonthlyStatistics(borrowings) {
          const totalBorrowings = borrowings.length;
          const uniqueMembers = [...new Set(borrowings.map(b => b.membershipNumber))].length;
          const uniqueSources = [...new Set(borrowings.map(b => b.sourceId))].length;
          
          return `
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${totalBorrowings}</div>
                      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${uniqueMembers}</div>
                      <div class="stat-label">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${uniqueSources}</div>
                      <div class="stat-label">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</div>
                  </div>
              </div>
          `;
      }

      // CRITICAL FIX: Enhanced getDeweyClassificationReport with all categories
      function getDeweyClassificationReport(sources) {
          const classifications = {};
          
          // Initialize all Dewey categories
          Object.values(DEWEY_CLASSIFICATIONS).forEach(category => {
              classifications[category] = 0;
          });
          classifications['ØºÙŠØ± Ù…Ø­Ø¯Ø¯'] = 0;
          
          sources.forEach(source => {
              if (source.deweyClassification) {
                  const category = Utils.getDeweyCategory(source.deweyClassification) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                  classifications[category]++;
              } else {
                  classifications['ØºÙŠØ± Ù…Ø­Ø¯Ø¯']++;
              }
          });
          
          return `
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr><th>ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ø±</th><th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th></tr>
                      </thead>
                      <tbody>
                          ${Object.entries(classifications)
                              .map(([category, count]) => {
                                  const percentage = sources.length ? ((count / sources.length) * 100).toFixed(1) : 0;
                                  return `<tr><td>${category}</td><td>${count}</td><td>${percentage}%</td></tr>`;
                              })
                              .join('')}
                      </tbody>
                  </table>
              </div>
          `;
      }

      function getLanguageReport(sources) {
          const languages = {};
          sources.forEach(source => {
              const lang = source.language || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
              languages[lang] = (languages[lang] || 0) + 1;
          });
          
          return Object.entries(languages)
              .map(([lang, count]) => `<tr><td>${lang}</td><td>${count}</td></tr>`)
              .join('');
      }

      function showReport(title, content) {
          currentReportType = title;
          document.getElementById('reportTitle').textContent = title;
          document.getElementById('reportContent').innerHTML = content;
          document.getElementById('reportResults').style.display = 'block';
      }

      // Updated Dewey Info Function
      function updateDeweyInfo(input) {
          const classification = input.value;
          const infoDiv = document.getElementById('deweyInfo');
          const thematicDiv = document.getElementById('thematicClassification');
          
          if (!classification) {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
              return;
          }

          const number = parseInt(classification);
          let categoryInfo = '';
          let thematicClassification = '';

          for (const [range, category] of Object.entries(DEWEY_CLASSIFICATIONS)) {
              const [start, end] = range.split('-').map(r => parseInt(r));
              if (number >= start && number <= end) {
                  categoryInfo = `${range}: ${category}`;
                  thematicClassification = `Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠ: ${category}`;
                  break;
              }
          }

          if (categoryInfo) {
              infoDiv.textContent = categoryInfo;
              infoDiv.style.display = 'block';
              thematicDiv.textContent = thematicClassification;
              thematicDiv.style.display = 'block';
          } else {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
          }
      }

      // Enhanced Edit Dewey Info Function
      function updateEditDeweyInfo(input) {
          const classification = input.value;
          const infoDiv = document.getElementById('editDeweyInfo');
          const thematicDiv = document.getElementById('editThematicClassification');
          
          if (!classification) {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
              return;
          }

          const number = parseInt(classification);
          let categoryInfo = '';
          let thematicClassification = '';

          for (const [range, category] of Object.entries(DEWEY_CLASSIFICATIONS)) {
              const [start, end] = range.split('-').map(r => parseInt(r));
              if (number >= start && number <= end) {
                  categoryInfo = `${range}: ${category}`;
                  thematicClassification = `Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠ: ${category}`;
                  break;
              }
          }

          if (categoryInfo) {
              infoDiv.textContent = categoryInfo;
              infoDiv.style.display = 'block';
              thematicDiv.textContent = thematicClassification;
              thematicDiv.style.display = 'block';
          } else {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
          }
      }

      // Import System - Updated for Dewey classification
      function showFileUploadWarning(type, input) {
          if (input.files.length > 0) {
              const confirmed = confirm(
                  'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ù‡Ø§Ù…: Ù‡Ù„ ØªÙ… Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù‚Ø¨Ù„ Ø±ÙØ¹Ù‡ØŸ\n\n' +
                  'ÙŠØ¬Ø¨ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹.\n\n' +
                  'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
              );
              
              if (confirmed) {
                  if (type === 'sources') {
                      importSources(input);
                  }
              } else {
                  input.value = '';
              }
          }
      }

      function importSources(input) {
          const file = input.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = function(e) {
              try {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, {type: 'array'});
                  const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                  const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                      header: 1,
                      defval: '',
                      raw: false
                  });
                  
                  if (jsonData.length < 2) {
                      throw new Error('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©');
                  }
                  
                  const headers = jsonData[0];
                  const sources = [];
                  
                  for (let i = 1; i < jsonData.length; i++) {
                      const row = jsonData[i];
                      if (!row || row.length === 0) continue;
                      
                      const source = {};
                      headers.forEach((header, index) => {
                          if (header && row[index] !== undefined) {
                              source[header.toString().trim()] = row[index] ? row[index].toString().trim() : '';
                          }
                      });
                      
                      if (source[headers[0]] || source[headers[1]] || source['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || source['Title'] || source['BIB']) {
                          sources.push({data: source, rowNumber: i + 1});
                      }
                  }
                  
                  // Validation
                  let errors = [];
                  let validSources = [];
                  
                  sources.forEach((sourceEntry) => {
                      const sourceRow = sourceEntry.data;
                      const rowNumber = sourceEntry.rowNumber;
                      
                      try {
                          const bibNumber = findValue(sourceRow, ['BIB', 'bib', 'Ø±Ù‚Ù… BIB', 'Ø±Ù‚Ù…_BIB', 'Bib Number']);
                          const title = findValue(sourceRow, ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Title', 'Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ù…ØµØ¯Ø±', 'Source Title']);
                          
                          if (!bibNumber) {
                              return; // Skip row
                          }
                          
                          if (bibNumber.length !== 14) {
                              errors.push(`Ø§Ù„ØµÙ ${rowNumber}: Ø±Ù‚Ù… BIB "${bibNumber}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¶Ø¨Ø·`);
                              return;
                          }
                          
                          if (!title || title.trim() === '') {
                              errors.push(`Ø§Ù„ØµÙ ${rowNumber}: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨`);
                              return;
                          }
                          
                          validSources.push({
                              data: sourceRow,
                              rowNumber: rowNumber,
                              bibNumber: bibNumber,
                              title: title
                          });
                          
                      } catch (error) {
                          errors.push(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ ${rowNumber}: ${error.message}`);
                      }
                  });
                  
                  if (errors.length > 0) {
                      const resultMessage = `
                          <div class="alert alert-danger">
                              <strong>âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…Ù„Ù! ÙŠØ¬Ø¨ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹:</strong><br>
                              <div style="max-height: 250px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dc3545;">
                                  ${errors.join('<br>')}
                              </div>
                              <br><strong>âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…ØµØ¯Ø±. ÙŠØ±Ø¬Ù‰ Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.</strong>
                          </div>
                      `;
                      
                      document.getElementById('importResults').innerHTML = resultMessage;
                      input.value = '';
                      return;
                  }
                  
                  // Import valid sources
                  let imported = 0;
                  const userBranch = currentUser.branch === 'all' ? 'Ø§Ù„Ø±ÙŠØ§Ø¶' : currentUser.branch;
                  
                  validSources.forEach((validSource) => {
                      const sourceRow = validSource.data;
                      
                      const notes = findValue(sourceRow, ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'Notes', 'Ù…Ù„Ø§Ø­Ø¸Ø©']) || '';
                      
                      const source = {
                          id: Date.now() + Math.random(),
                          bibNumber: validSource.bibNumber,
                          title: validSource.title,
                          author: findValue(sourceRow, ['Ø§Ù„Ù…Ø¤Ù„Ù', 'Author', 'Ù…Ø¤Ù„Ù', 'Ø§Ù„ÙƒØ§ØªØ¨', 'Writer']) || '',
                          publisher: findValue(sourceRow, ['Ø§Ù„Ù†Ø§Ø´Ø±', 'Publisher', 'Ù†Ø§Ø´Ø±', 'Ø¯Ø§Ø± Ø§Ù„Ù†Ø´Ø±']) || '',
                          publishYear: findValue(sourceRow, ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±', 'Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø±', 'Publish Year', 'Year', 'Ø§Ù„Ø³Ù†Ø©']) || '',
                          language: findValue(sourceRow, ['Ø§Ù„Ù„ØºØ©', 'Language', 'Ù„ØºØ©']) || 'ara',
                          deweyClassification: findValue(sourceRow, ['ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ', 'Dewey Classification', 'Ø§Ù„ØªØµÙ†ÙŠÙ', 'Classification']) || '',
                          copiesCount: parseInt(findValue(sourceRow, ['Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®', 'Copies Count', 'Ø§Ù„Ù†Ø³Ø®', 'Copies']) || '1'),
                          library: findValue(sourceRow, ['Ø§Ù„Ù…ÙƒØªØ¨Ø©', 'Library', 'Ù…ÙƒØªØ¨Ø©']) || getLibraryFromBib(validSource.bibNumber),
                          source: findValue(sourceRow, ['Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯', 'Source', 'Ø§Ù„Ù…ØµØ¯Ø±']) || 'Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø´Ø¯ 1',
                          status: findValue(sourceRow, ['Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±', 'Status', 'Ø§Ù„Ø­Ø§Ù„Ø©']) || 'Ù…ØªØ§Ø­',
                          location: findValue(sourceRow, ['Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'Location', 'Ù…ÙˆÙ‚Ø¹']) || '',
                          supplyDate: findValue(sourceRow, ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯', 'Supply Date', 'Ø§Ù„ØªÙˆØ±ÙŠØ¯']) || '',
                          shelfNumber: findValue(sourceRow, ['Ø±Ù‚Ù… Ø§Ù„Ø±Ù', 'Shelf Number', 'Ø§Ù„Ø±Ù']) || '',
                          notes,
                          branch: userBranch,
                          addedDate: new Date().toISOString(),
                          deleted: false
                      };
                      
                      DATA.sources.push(source);
                      imported++;
                  });
                  
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  
                  const resultMessage = `
                      <div class="alert alert-success">
                          <strong>ğŸ‰ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
                          ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported} Ù…ØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ÙØ±Ø¹ ${userBranch}
                      </div>
                  `;
                  
                  document.getElementById('importResults').innerHTML = resultMessage;
                  input.value = '';
                      
              } catch (error) {
                  document.getElementById('importResults').innerHTML = 
                      `<div class="alert alert-danger">
                          <strong>Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù:</strong><br>
                          ${error.message}
                      </div>`;
              }
          };
          
          reader.readAsArrayBuffer(file);
      }

      function findValue(obj, possibleKeys) {
          for (let key of possibleKeys) {
              if (obj[key] !== undefined && obj[key] !== '') {
                  return obj[key];
              }
          }
          for (let objKey in obj) {
              for (let searchKey of possibleKeys) {
                  if (objKey.toLowerCase().includes(searchKey.toLowerCase()) || 
                      searchKey.toLowerCase().includes(objKey.toLowerCase())) {
                      if (obj[objKey] !== undefined && obj[objKey] !== '') {
                          return obj[objKey];
                      }
                  }
              }
          }
          return '';
      }

      function getLibraryFromBib(bib) {
          if (!bib) return 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
          const prefix = bib.toString().substring(0, 2);
          const types = {
              '01': 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
              '02': 'Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙŠØ§ÙØ¹ÙŠÙ†', 
              '03': 'Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„'
          };
          return types[prefix] || 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
      }

      // Settings and System Management - Updated for new borrowing period
      function loadSettings() {
          if (document.getElementById('settings').classList.contains('active')) {
              document.getElementById('libraryName').value = DATA.settings.libraryName;
              document.getElementById('borrowingPeriod').value = DATA.settings.borrowingPeriod;
              document.getElementById('maxBorrowedSources').value = DATA.settings.maxBorrowedSources;
              updateSettingsStats();
          }
      }

      function saveSettings() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'danger');
              return;
          }

          DATA.settings = {
              libraryName: document.getElementById('libraryName').value,
              borrowingPeriod: document.getElementById('borrowingPeriod').value,
              maxBorrowedSources: parseInt(document.getElementById('maxBorrowedSources').value)
          };
          
          Storage.save();
          Utils.showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      }

      function updateSettingsStats() {
          if (document.getElementById('settings').classList.contains('active')) {
              const filteredSources = DataFilter.getFilteredSources({});
              const filteredMembers = DataFilter.getFilteredMembers({});
              const filteredBorrowings = DataFilter.getFilteredBorrowings({});
              
              document.getElementById('settingsSourceCount').textContent = filteredSources.length;
              document.getElementById('settingsMemberCount').textContent = filteredMembers.length;
              document.getElementById('settingsBorrowingCount').textContent = filteredBorrowings.filter(b => !b.returned).length;
              
              // Deleted sources for current branch
              let deletedSources;
              if (['admin', 'manager'].includes(currentUser.role)) {
                  deletedSources = DATA.sources.filter(s => s.deleted);
              } else {
                  deletedSources = DATA.sources.filter(s => s.deleted && s.branch === currentUser.branch);
              }
              document.getElementById('settingsDeletedCount').textContent = deletedSources.length;
              
              document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('en-GB');
              
              // Calculate data size
              const dataSize = JSON.stringify(DATA).length;
              document.getElementById('dataSize').textContent = `${(dataSize / 1024).toFixed(2)} ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª`;
              
              updateDeletedSourcesSummary();
          }
      }

      function updateDeletedSourcesSummary() {
          const summaryDiv = document.getElementById('deletedSourcesSummary');
          
          // Show deleted sources for current branch only (except admin/manager)
          let deletedSources;
          if (['admin', 'manager'].includes(currentUser.role)) {
              deletedSources = DATA.sources.filter(s => s.deleted);
          } else {
              deletedSources = DATA.sources.filter(s => s.deleted && s.branch === currentUser.branch);
          }
          
          if (deletedSources.length === 0) {
              summaryDiv.innerHTML = '<p style="color: #666; margin: 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± Ù…Ø­Ø°ÙˆÙØ©</p>';
              return;
          }
          
          // Group by source
          const sourceGroups = {};
          let totalDeleted = 0;
          
          deletedSources.forEach(source => {
              const sourceType = source.source || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
              if (!sourceGroups[sourceType]) {
                  sourceGroups[sourceType] = 0;
              }
              sourceGroups[sourceType] += source.copiesCount || 1;
              totalDeleted += source.copiesCount || 1;
          });
          
          let summaryHtml = `<div style="margin-bottom: 1rem;"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${totalDeleted} Ù…ØµØ¯Ø±</strong></div>`;
          summaryHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">';
          
          Object.entries(sourceGroups).forEach(([source, count]) => {
              summaryHtml += `
                  <div style="background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid #dee2e6;">
                      <strong>${source}:</strong> ${count} Ù…ØµØ¯Ø±
                  </div>
              `;
          });
          
          summaryHtml += '</div>';
          summaryDiv.innerHTML = summaryHtml;
      }

      function clearAllData() {
          if (currentUser.role !== 'admin') {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'danger');
              return;
          }

          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) {
              Object.keys(DATA).forEach(key => {
                  if (key === 'settings') {
                      DATA[key] = { 
                          libraryName: 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 
                          borrowingPeriod: 'end_of_day', 
                          maxBorrowedSources: 999 
                      };
                  } else {
                      DATA[key] = [];
                  }
              });
              
              Storage.save();
              updateDashboard();
              loadSourcesTable();
              if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
                  loadMembersTable();
              }
              loadActiveBorrowings();
              loadSettings();
              
              Utils.showAlert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'success');
          }
      }

      // Export Functions - Updated
      function exportCurrentPageData() {
          const activeSection = document.querySelector('.page-section.active');
          if (!activeSection) {
              Utils.showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ø´Ø·Ø©', 'warning');
              return;
          }
          
          const sectionId = activeSection.id;
          let sheetsData = {};
          let filterSuffix = '';
          
          switch(sectionId) {
              case 'dashboard':
                  const period = document.getElementById('activityPeriod').value || 'all';
                  const libraryType = document.getElementById('libraryTypeFilter').value || 'all';
                  filterSuffix = `Ù„ÙˆØ­Ø©_Ø§Ù„ØªØ­ÙƒÙ…_${period}_${libraryType}`;
                  sheetsData['Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª_Ø¹Ø§Ù…Ø©'] = createDashboardStatsSheet();
                  sheetsData['Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª_Ø§Ù„Ø­Ø¯ÙŠØ«Ø©'] = createRecentBorrowingsSheet();
                  break;
                  
              case 'sources':
                  filterSuffix = 'Ø§Ù„Ù…ØµØ§Ø¯Ø±';
                  const filteredSources = DataFilter.getFilteredSources({});
                  sheetsData['Ø§Ù„Ù…ØµØ§Ø¯Ø±'] = createSourcesSheet(filteredSources);
                  break;
                  
              case 'members':
                  if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
                      filterSuffix = 'Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡';
                      sheetsData['Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡'] = createMembersSheet();
                  }
                  break;
                  
              case 'circulation':
                  filterSuffix = 'Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª_Ø§Ù„Ù†Ø´Ø·Ø©';
                  const activeBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => !b.returned);
                  sheetsData['Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª_Ø§Ù„Ù†Ø´Ø·Ø©'] = createBorrowingsSheet(activeBorrowings);
                  break;
                  
              case 'reports':
                  if (currentReportData && currentReportType) {
                      filterSuffix = currentReportType;
                      sheetsData[currentReportType] = currentReportData;
                  }
                  break;
                  
              default:
                  Utils.showAlert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ø§ ØªØ¯Ø¹Ù… Ø§Ù„ØªØµØ¯ÙŠØ±', 'warning');
                  return;
          }
          
          if (Object.keys(sheetsData).length === 0) {
              Utils.showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ± Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©', 'warning');
              return;
          }
          
          const wb = XLSX.utils.book_new();
          
          Object.entries(sheetsData).forEach(([sheetName, data]) => {
              if (data && data.length > 0) {
                  const ws = XLSX.utils.json_to_sheet(data);
                  XLSX.utils.book_append_sheet(wb, ws, sheetName);
              }
          });
          
          const currentDate = new Date().toISOString().split('T')[0];
          const branchSuffix = ['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹_Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch;
          const filename = `ØªØµØ¯ÙŠØ±_${filterSuffix}_${branchSuffix}_${currentDate}.xlsx`;
          XLSX.writeFile(wb, filename);
          
          Utils.showAlert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      }

      function exportCompleteBackup() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.', 'danger');
              return;
          }
          
          const wb = XLSX.utils.book_new();
          
          // Export filtered data based on user role
          const filteredSources = DataFilter.getFilteredSources({});
          const filteredMembers = DataFilter.getFilteredMembers({});
          const filteredBorrowings = DataFilter.getFilteredBorrowings({});
          
          if (filteredSources.length > 0) {
              const sourcesSheet = createSourcesSheet(filteredSources);
              const sourcesWs = XLSX.utils.json_to_sheet(sourcesSheet);
              XLSX.utils.book_append_sheet(wb, sourcesWs, 'Ø§Ù„Ù…ØµØ§Ø¯Ø±');
          }
          
          if (filteredMembers.length > 0) {
              const membersSheet = createMembersSheet();
              const membersWs = XLSX.utils.json_to_sheet(membersSheet);
              XLSX.utils.book_append_sheet(wb, membersWs, 'Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡');
          }
          
          if (filteredBorrowings.length > 0) {
              const borrowingsSheet = createBorrowingsSheet(filteredBorrowings);
              const borrowingsWs = XLSX.utils.json_to_sheet(borrowingsSheet);
              XLSX.utils.book_append_sheet(wb, borrowingsWs, 'Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª');
          }
          
          const currentDate = new Date().toISOString().split('T')[0];
          const branchSuffix = ['admin', 'manager'].includes(currentUser.role) ? 'Ø¬Ù…ÙŠØ¹_Ø§Ù„ÙØ±ÙˆØ¹' : currentUser.branch;
          const filename = `Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_${branchSuffix}_${currentDate}.xlsx`;
          XLSX.writeFile(wb, filename);
          
          Utils.showAlert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      }

      // Helper functions for creating export sheets
      function createSourcesSheet(sources) {
          return sources.map((source, index) => {
              const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
              return {
                  'Ø§Ù„Ø±Ù‚Ù…': index + 1,
                  'Ø±Ù‚Ù… BIB': source.bibNumber,
                  'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': source.title,
                  'Ø§Ù„Ù…Ø¤Ù„Ù': source.author,
                  'Ø§Ù„Ù†Ø§Ø´Ø±': source.publisher || '',
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±': source.publishYear || '',
                  'Ø§Ù„Ù„ØºØ©': source.language || '',
                  'ØªØµÙ†ÙŠÙ Ø¯ÙŠÙˆÙŠ': source.deweyClassification || '',
                  'Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠ': thematicClassification || '',
                  'Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®': source.copiesCount || 1,
                  'Ø§Ù„Ù…ÙƒØªØ¨Ø©': libraryType.name,
                  'Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯': source.source || '',
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯': source.supplyDate ? Utils.formatDate(source.supplyDate) : '',
                  'Ø±Ù‚Ù… Ø§Ù„Ø±Ù': source.shelfNumber || '',
                  'Ø§Ù„ÙØ±Ø¹': source.branch || '',
                  'Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±': source.deleted ? 'Ù…Ø­Ø°ÙˆÙ' : source.status,
                  'Ø§Ù„Ù…ÙˆÙ‚Ø¹': source.location || '',
                  'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': source.notes || '',
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©': Utils.formatDate(source.addedDate)
              };
          });
      }

      function createMembersSheet() {
          return DataFilter.getFilteredMembers({}).map(member => {
              const borrowedCount = DATA.borrowings.filter(b => 
                  b.membershipNumber === member.membershipNumber && 
                  !b.returned &&
                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
              ).length;
              
              return {
                  'Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©': member.membershipNumber,
                  'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„': member.fullName,
                  'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©': member.memberType,
                  'Ø§Ù„ÙØ±Ø¹': member.branch,
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„': Utils.formatDate(member.joinDate),
                  'Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹': borrowedCount
              };
          });
      }

      function createBorrowingsSheet(borrowings) {
          return borrowings.map(borrowing => {
              const member = DATA.members.find(m => m.membershipNumber === borrowing.membershipNumber) ||
                            USER_ACCOUNTS[borrowing.membershipNumber];
              const source = DATA.sources.find(s => s.id === borrowing.sourceId);
              const libraryType = source ? Utils.getLibraryTypeFromBib(source.bibNumber) : { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
              
              return {
                  'Ø§Ù„Ø¹Ø¶Ùˆ': member ? (member.fullName || member.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                  'Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©': borrowing.membershipNumber,
                  'Ø§Ù„Ù…ØµØ¯Ø±': source ? source.title : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                  'Ø±Ù‚Ù… BIB': source ? source.bibNumber : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                  'Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©': libraryType.name,
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©': Utils.formatDate(borrowing.borrowDate),
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨': Utils.formatDate(borrowing.dueDate),
                  'ØªÙ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹': borrowing.returned ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ': borrowing.returnDate ? Utils.formatDate(borrowing.returnDate) : '-',
                  'Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„': borrowing.employeeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                  'Ù…ÙˆØ¸Ù Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹': borrowing.returnEmployeeName || '-',
                  'Ø§Ù„ÙØ±Ø¹': borrowing.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
              };
          });
      }

      function createDashboardStatsSheet() {
          return [{
              'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø±',
              'Ø§Ù„Ù‚ÙŠÙ…Ø©': DataFilter.getFilteredSources({}).length
          }, {
              'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡',
              'Ø§Ù„Ù‚ÙŠÙ…Ø©': DataFilter.getFilteredMembers({}).length
          }, {
              'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø§Ù„Ø¥Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©',
              'Ø§Ù„Ù‚ÙŠÙ…Ø©': DataFilter.getFilteredBorrowings({}).filter(b => !b.returned).length
          }];
      }

      function createRecentBorrowingsSheet() {
          const recent = DataFilter.getFilteredBorrowings({})
              .filter(b => !b.returned)
              .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
              .slice(0, 10);
          
          return createBorrowingsSheet(recent);
      }

      // Navigation and UI Management
      function showSection(sectionId) {
          document.querySelectorAll('.page-section').forEach(section => {
              section.classList.remove('active');
          });
          
          document.querySelectorAll('.menu-item').forEach(item => {
              item.classList.remove('active');
          });
          
          document.getElementById(sectionId).classList.add('active');
          event.target.classList.add('active');
          
          // Close mobile menu
          document.getElementById('sidebar').classList.remove('mobile-open');
          
          // Section-specific initialization
          switch(sectionId) {
              case 'dashboard':
                  updateDashboard();
                  break;
              case 'sources':
                  loadSourcesTable();
                  break;
              case 'members':
                  if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
                      loadMembersTable();
                  }
                  break;
              case 'circulation':
                  loadActiveBorrowings();
                  break;
              case 'settings':
                  if (['admin', 'supervisor'].includes(currentUser.role)) {
                      loadSettings();
                      updateSettingsStats();
                  }
                  break;
          }
      }

      function toggleMobileMenu() {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.toggle('mobile-open');
      }

      function updateLibraryType() {
          const bibInput = document.querySelector('input[name="bibNumber"]');
          const librarySelect = document.getElementById('librarySelect');
          
          if (bibInput && librarySelect && bibInput.value) {
              const libraryType = Utils.getLibraryTypeFromBib(bibInput.value);
              if (libraryType.type !== 'unknown') {
                  librarySelect.value = libraryType.name;
              }
          }
      }

      // Additional Functions
      function renewBorrowing(borrowingId) {
          const borrowing = DATA.borrowings.find(b => b.id === borrowingId);
          if (!borrowing) {
              Utils.showAlert('Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!', 'danger');
              return;
          }
          
          if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¬Ø¯ÙŠØ¯ ÙØªØ±Ø© Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠØŸ')) {
              // Extend until end of next day
              const newDueDate = Utils.getEndOfDay(new Date(new Date().getTime() + 24 * 60 * 60 * 1000));
              
              borrowing.dueDate = newDueDate.toISOString();
              borrowing.renewed = true;
              borrowing.renewDate = new Date().toISOString();
              borrowing.renewEmployeeName = currentUser.name;
              
              Storage.save();
              loadActiveBorrowings();
              updateDashboard();
              
              Utils.showAlert('ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
          }
      }

      function quickReturn(borrowingId) {
          const borrowing = DATA.borrowings.find(b => b.id === borrowingId);
          if (!borrowing) {
              Utils.showAlert('Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!', 'danger');
              return;
          }
          
          const source = DATA.sources.find(s => s.id === borrowing.sourceId);
          if (!source) {
              Utils.showAlert('Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', 'danger');
              return;
          }
          
          if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø¬Ø§Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±ØŸ')) {
              borrowing.returned = true;
              borrowing.returnDate = new Date().toISOString();
              borrowing.returnEmployeeName = currentUser.name;
              
              // Update source status if needed
              const remainingBorrowings = DATA.borrowings.filter(b => 
                  b.sourceId === source.id && !b.returned
              ).length;
              
              if (remainingBorrowings === 0 && Utils.isBorrowable(source)) {
                  source.status = 'Ù…ØªØ§Ø­';
              }
              
              Storage.save();
              Utils.showAlert('ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
              
              loadActiveBorrowings();
              updateDashboard();
          }
      }

      // Initialize System
      function initializeSystem() {
          updateDashboard();
          loadSourcesTable();
          if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
              loadMembersTable();
              loadSettings();
          }
          loadActiveBorrowings();
          
          // Set member barcode to current user and make it readonly
          const memberBarcodeInput = document.getElementById('memberBarcode');
          if (memberBarcodeInput && currentUser.membershipNumber) {
              memberBarcodeInput.value = currentUser.membershipNumber;
              memberBarcodeInput.setAttribute('readonly', true);
              setTimeout(() => {
                  loadMemberInfo();
              }, 500);
          }
      }

      // Global event listeners and initialization
      document.addEventListener('DOMContentLoaded', function() {
          // Set default dates for reports
          const today = new Date();
          const lastWeek = new Date();
          lastWeek.setDate(today.getDate() - 7);
          
          const reportStartDate = document.getElementById('reportStartDate');
          const reportEndDate = document.getElementById('reportEndDate');
          
          if (reportStartDate) reportStartDate.value = lastWeek.toISOString().split('T')[0];
          if (reportEndDate) reportEndDate.value = today.toISOString().split('T')[0];

          // Auto-focus and selection for barcode inputs
          document.getElementById('sourceBarcode')?.addEventListener('focus', function() {
              this.select();
          });

          // Auto-detect library type based on BIB number
          const bibInput = document.querySelector('input[name="bibNumber"]');
          if (bibInput) {
              bibInput.addEventListener('input', updateLibraryType);
          }

          // Load data and check authentication
          Storage.load();
          if (!currentUser.authenticated) {
              document.getElementById('loginModal').style.display = 'flex';
          } else {
              initializeSystem();
          }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
          if (window.innerWidth <= 768) {
              const sidebar = document.getElementById('sidebar');
              if (e.target.closest('.sidebar') === null && e.target.closest('.mobile-menu-btn') === null) {
                  sidebar.classList.remove('mobile-open');
              }
          }
          
          if (e.ctrlKey && e.key === 'e') {
              e.preventDefault();
              exportCurrentPageData();
          }
          
          if (e.ctrlKey && e.key === 'f' && document.getElementById('sources').classList.contains('active')) {
              e.preventDefault();
              document.getElementById('sourceSearch').focus();
          }
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', function(e) {
          if (window.innerWidth <= 768) {
              const sidebar = document.getElementById('sidebar');
              const mobileMenuBtn = e.target.closest('.mobile-menu-btn');
              const sidebarContent = e.target.closest('.sidebar');
              
              if (!mobileMenuBtn && !sidebarContent && sidebar.classList.contains('mobile-open')) {
                  sidebar.classList.remove('mobile-open');
              }
          }
      });

      // Close modals when clicking outside
      document.addEventListener('click', function(e) {
          // Close edit modals when clicking outside
          if (e.target.classList.contains('edit-modal')) {
              e.target.classList.remove('active');
          }
          
          // Close delete confirmation modal when clicking outside
          if (e.target.classList.contains('delete-confirmation-modal')) {
              closeDeleteConfirmationModal();
          }
      });

      // Global validation functions
      function validateBibNumber(input) {
          return Utils.validateBibNumber(input);
      }
  </script>
</body>
</html> 
