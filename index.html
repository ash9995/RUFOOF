<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفـــوفـــ</title>
    <style>


@font-face {
    font-family: 'Byt';
    src: url('byt-Regular.otf') format('opentype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}

@font-face {
    font-family: 'Larken';
    src: url('Larken-Regular.otf') format('opentype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}
        :root {
            --primary-color: #44556A;
            --secondary-color: #44556A;
            --success-color: #96BCB7;
            --warning-color: #D97E5C;
            --danger-color: #D97E5C;
            --dark-color: #1f2937;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --border-color: #e5e7eb;
            --text-color: #374151;
            --sidebar-bg: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
    font-family: 'Byt', 'Larken', 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.5;
        padding-bottom: 60px; /* Space for footer */
        }


.card-title, .stat-number, .btn, .menu-item, .form-label, .form-input {
    font-family: 'Byt', 'Larken', 'Segoe UI', Tahoma, Arial, sans-serif;
}
        /* Footer Styles */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #44556A;
            color: white;
            padding: 0.5rem;
            text-align: center;
            z-index: 100;
            border-top: 2px solid #91B9B4;
        }

        .footer a {
            color: #91B9B4;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }


        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;  
            max-width: 400px;
            text-align: center;
        }

        .login-form h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .login-form input, .login-form select {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .login-form button {
            width: 100%;
            padding: 0.75rem;
            background: #96BCB7;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        .login-form button:hover {
            background: #8EB4AF;
        }

        .login-error {
            color: var(--danger-color);
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* Header */
        .header {
            background: #44556A;
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
            margin: 0 auto;
        }

        .logo {
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: '';
            width: 210px;
            height: 80px;
            background-image: url('r.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: right;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-right: auto;
        }

        /* Responsive Header */
        @media (max-width: 768px) {
            .header { padding: 0.5rem 1rem; }
            .logo { right: 1rem; }
            .logo::before { width: 80px; height: 30px; }
            .user-info { flex-direction: column; gap: 0.5rem; font-size: 0.8rem; }
            .user-info .btn { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
        }

        @media (max-width: 480px) {
            .logo::before { width: 60px; height: 25px; }
            .user-info { font-size: 0.7rem; }
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 80px;
            right: 0;
            width: 280px;
            height: calc(100vh - 80px);
            background: #44556A;
            color: white;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .sidebar-menu { padding: 1rem 0; }

        .menu-item {
            display: block;
            padding: 1rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: right;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 1px solid #55687E;
        }

        .menu-item:hover, .menu-item.active {
            background: #91B9B4;
            color: white;
            padding-right: 2rem;
        }

        .menu-item i { margin-left: 0.5rem; width: 20px; }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            margin-right: 280px;
            padding: 2rem;
            min-height: calc(100vh - 80px);
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease;
            flex-direction: column;
        }

        .page-section.active { display: flex; }

        #settings, #import {
            width: 1420px;
            max-width: none;
            overflow-x: auto;
        }

        #settings .card, #import .card {
            width: 100%;
            min-width: 1250px;
            height: auto;
            margin-bottom: 2rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(45deg, #f8fafc, #f1f5f9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .card-body { padding: 1.5rem; }

        /* Consistent Filters Container */
        .filters-container {

            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        /* Consistent Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

       .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.form-label {
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-input {
    padding: 0.75rem;
    border-radius: 8px;
    border: 2px solid #ccc;
    font-size: 1rem;
}

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-input[readonly] {
            background-color: #f1f5f9;
            border-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-input[readonly]:focus {
            border-color: #d1d5db;
            box-shadow: none;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 1rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-left: 3rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-secondary {
            background: #91B9B4;
            color: white;
        }

        .btn-primary:hover, .btn-success:hover, .btn-warning:hover, .btn-danger:hover, .btn-secondary:hover {
            background: #7da8a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(145, 185, 180, 0.3);
        }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            font-size: 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background: var(--white);
        }

        .search-btn {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: #91B9B4;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 800px;
        }

        .table th {
            background: #44556A;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
.table thead th:first-child {
    border-top-right-radius: 8px;
}

        .table th:last-child {
            border-top-left-radius: 8px;

        }

        .table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .table tbody tr:hover { background: #f8fafc; }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover { transform: translateY(-5px); }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .stat-sublabel {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-primary { background: #dbeafe; color: #1e40af; }
        .badge-secondary { background: #f3f4f6; color: #374151; }

        /* Sources with Notes Status Badges */
        .status-bib-mismatch { background: #fecaca; color: #991b1b; }
        .status-no-chip { background: #fed7d7; color: #9b2c2c; }
        .status-inappropriate { background: #fbb6ce; color: #97266d; }
        .status-incorrect-classification { background: #fde68a; color: #92400e; }
        .status-not-for-loan { background: #c7d2fe; color: #3730a3; }
        .status-old-edition { background: #d1d5db; color: #374151; }
        .status-duplicate { background: #fbcfe8; color: #be185d; }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid;
        }

        .alert-success { background: #ecfdf5; border-color: #44556A; color: #065f46; }
        .alert-warning { background: #fffbeb; border-color: #f59e0b; color: #92400e; }
        .alert-danger { background: #fef2f2; border-color: #ef4444; color: #991b1b; }
        .alert-info { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }

        /* File Upload */
        .file-upload {
            border: 2px dashed #91B9B4;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #91B9B4;
            background: #f1f5f9;
        }

        .file-upload input { display: none; }

        /* Barcode Scanner */
        .scanner-container {
            text-align: center;
            padding: 2rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .scanner-input {
            font-size: 1.5rem;
            padding: 1rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .scanner-input[readonly] {
            background-color: #f1f5f9;
            border-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }

        .scanner-input[readonly]:focus {
            border-color: #d1d5db;
            box-shadow: none;
        }

        /* Library Type Indicators */
        .library-type {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .library-main { background: #dbeafe; color: #1e40af; }
        .library-youth { background: #fef3c7; color: #92400e; }
        .library-child { background: #fce7f3; color: #be185d; }

        /* Subject Classification Display */
        .subject-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #0c4a6e;
        }

        /* Thematic Classification Display */
        .thematic-classification {
            background: #f0fdf4;
            border: 1px solid #16a34a;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #15803d;
            font-weight: 500;
        }

        /* Date Range Selector */
        .date-range-selector {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(100%);
                width: 100%;
            }

            .sidebar.mobile-open { transform: translateX(0); }

            .main-content {
                margin-right: 0;
                padding: 1rem;
            }

            .header-content { padding: 0 1rem; }
            .form-grid, .stats-grid, .filters-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; align-items: stretch; }
            .stat-number { font-size: 2rem; }
            .table { font-size: 0.8rem; min-width: 600px; }
            .table th, .table td { padding: 0.5rem; }
            .scanner-input { font-size: 1.2rem; }
        }

        @media (max-width: 480px) {
            .main-content { padding: 0.5rem; }
            .card { margin-bottom: 1rem; }
            .card-header, .card-body { padding: 1rem; }
            .stat-number { font-size: 1.8rem; }
            .form-input, .search-input { font-size: 16px; }

        }

        /* Print Styles */
        @media print {
            .sidebar, .header, .btn, .footer { display: none !important; }
            .main-content { margin: 0; padding: 0; }
        }


        /* Role-based visibility */
        .admin-only, .supervisor-only, .manager-only { display: none; }
        .admin-mode .admin-only { display: inline-flex; }
        .supervisor-mode .supervisor-only { display: inline-flex; }
        .manager-mode .manager-only, .admin-mode .manager-only { display: inline-flex; }

        /* Hide sections */
        #members { display: none !important; }
        .admin-mode #members.active, .supervisor-mode #members.active, .manager-mode #members.active { display: flex !important; }
        #settings:not(.active) { display: none !important; }
        .admin-mode #settings.active .admin-only, .supervisor-mode #settings.active .supervisor-only { display: block; }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* BIB Input validation */
        .bib-input.invalid {
            border-color: var(--danger-color);
            background-color: #fee2e2;
        }

        .bib-error {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .bib-error.show { display: block; }

        .mobile-menu-btn { display: none; }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                margin-left: 1rem;
            }
        }

        /* User Stats Card */
        .user-stats-card {
            background: #44556A;
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .user-stats-card .stat-number {
            color: white;
            font-size: 2rem;
        }

        .user-stats-card .stat-label { color: rgba(255,255,255,0.9); }

        /* Membership number styling */
        .membership-number-display {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #374151;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        /* Branch selector */
        .branch-selector {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .branch-selector h4 {
            color: #0c4a6e;
            margin-bottom: 0.5rem;
        }

        /* Special Notes Highlighting */
        .notes-highlight {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            color: #92400e;
        }

        /* Enhanced Edit Modal Styles */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .edit-form h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Delete Confirmation Modal */
        .delete-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .delete-confirmation-modal.active {
            display: flex;
        }

        .delete-confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .delete-confirmation-content h3 {
            color: var(--danger-color);
            margin-bottom: 1rem;
        }

        .delete-confirmation-content p {
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .delete-reason-group {
            margin: 1rem 0;
            text-align: right;
        }

        .delete-reason-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .delete-reason-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        /* NOT BORROWABLE - Sources with Special Notes */
        .not-borrowable {
            background: #fee2e2 !important;
            border-left: 4px solid #ef4444;
        }

        .not-borrowable .notes-highlight {
            background: #dc2626;
            color: white;
            font-weight: bold;
        }

       /* Performance Panel - Match Recent Loans Styling */
.performance-panel {
    display: flex;
    flex-direction: column;
}


.performance-panel .card-header {
   padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(45deg, #f8fafc, #f1f5f9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;

.performance-panel .card-body {
    .card-body { padding: 1.5rem; }
}

 .performance-panel .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

.performance-panel .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
}

.performance-panel .table th {
    background-color: #44556A;
    color: white;
}

    </style>
</head>

<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-form">
            <h2>🔐 تسجيل الدخول للنظام</h2>
            <form id="loginForm" onsubmit="authenticateUser(event)">
                <input type="text" id="membershipNumber" placeholder="رقم العضوية" required>
                <input type="password" id="password" placeholder="كلمة المرور" required>
                <button type="submit">دخول</button>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: #666; text-align: right;">
                   
                </div>
            </form>
            <div id="loginError" class="login-error" style="display: none;"></div>
        </div>
    </div>

    <!-- Edit Source Modal -->
    <div id="editSourceModal" class="edit-modal">
        <div class="edit-form">
            <h3>تعديل المصدر</h3>
            <form id="editSourceForm" onsubmit="updateSource(event)">
                <input type="hidden" id="editSourceId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">رقم BIB * (14 رقم)</label>
                        <input type="text" class="form-input bib-input" id="editSourceBib" required placeholder="مثال: 01234567890123" maxlength="14" oninput="validateBibNumber(this)">
                        <div class="bib-error">رقم BIB يجب أن يكون 14 رقماً بالضبط</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">العنوان *</label>
                        <input type="text" class="form-input" id="editSourceTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المؤلف *</label>
                        <input type="text" class="form-input" id="editSourceAuthor" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الناشر</label>
                        <input type="text" class="form-input" id="editSourcePublisher">
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ النشر</label>
                        <input type="number" class="form-input" id="editSourceYear" min="1900" max="2030">
                    </div>
                    <div class="form-group">
                        <label class="form-label">اللغة</label>
                        <select class="form-input form-select" id="editSourceLanguage">
                            <option value="ara">العربية</option>
                            <option value="eng">الإنجليزية</option>
                            <option value="fre">الفرنسية</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تصنيف ديوي (Dewey Classification)</label>
                        <input type="text" class="form-input" id="editSourceDewey" onchange="updateEditDeweyInfo(this)">
                        <div id="editDeweyInfo" class="subject-info" style="display: none;"></div>
                        <div id="editThematicClassification" class="thematic-classification" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">عدد النسخ</label>
                        <input type="number" class="form-input" id="editSourceCopies" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">المكتبة</label>
                        <select class="form-input form-select" id="editSourceLibrary">
                            <option value="المكتبة الرئيسية">المكتبة الرئيسية</option>
                            <option value="مكتبة اليافعين">مكتبة اليافعين</option>
                            <option value="مكتبة الطفل">مكتبة الطفل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">مصدر التوريد</label>
                        <select class="form-input form-select" id="editSourceSupply">
                            <option value="مكتبة الرشد 1">مكتبة الرشد 1</option>
                            <option value="مكتبة الرشد 2">مكتبة الرشد 2</option>
                            <option value="مكتبة الرشد 3">مكتبة الرشد 3</option>
                            <option value="مكتبة الرشد 4">مكتبة الرشد 4</option>
                            <option value="مكتبة الرشد 5">مكتبة الرشد 5</option>
                            <option value="مكتبة الرشد 6">مكتبة الرشد 6</option>
                            <option value="الوزارة">الوزارة</option>
                            <option value="الدمام">الدمام</option>
                            <option value="أحد رفيدة">أحد رفيدة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">حالة المصدر</label>
                        <select class="form-input form-select" id="editSourceStatus">
                            <option value="متاح">متاح</option>
                            <option value="مستعار">مستعار</option>
                            <option value="تالف">تالف</option>
                            <option value="BIB لا يطابق العنوان">BIB لا يطابق العنوان</option>
                            <option value="لا يوجد شريحة">لا يوجد شريحة</option>
                            <option value="المحتوى مخالف">المحتوى مخالف</option>
                            <option value="التصنيف خاطئ">التصنيف خاطئ</option>
                            <option value="غير صالح للإعارة">غير صالح للإعارة</option>
                            <option value="إصدار قديم">إصدار قديم</option>
                            <option value="مكرر">مكرر</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الموقع في المكتبة</label>
                        <input type="text" class="form-input" id="editSourceLocation">
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ التوريد</label>
                        <input type="date" class="form-input" id="editSourceSupplyDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">رقم الرف</label>
                        <input type="text" class="form-input" id="editSourceShelf">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ملاحظات</label>
                    <textarea class="form-input" id="editSourceNotes" rows="3"></textarea>
                </div>
                <div style="text-align: center; margin-top: 2rem; gap: 1rem; display: flex; justify-content: center;">
                    <button type="submit" class="btn btn-success">💾 حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditSourceModal()">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="edit-modal">
        <div class="edit-form">
            <h3>تعديل العضو</h3>
            <form id="editMemberForm" onsubmit="updateMember(event)">
                <input type="hidden" id="editMemberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">رقم العضوية *</label>
                        <input type="text" class="form-input" id="editMembershipNumber" required readonly>
                        <small style="color: #666; font-size: 0.9rem;">لا يمكن تعديل رقم العضوية</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">كلمة المرور *</label>
                        <input type="password" class="form-input" id="editMemberPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الاسم الكامل *</label>
                        <input type="text" class="form-input" id="editMemberName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">نوع العضوية *</label>
                        <select class="form-input form-select" id="editMemberType" required>
                            <option value="مدير النظام">مدير النظام</option>
                            <option value="مشرف فرع">مشرف فرع</option>
                            <option value="أمين مكتبة">أمين مكتبة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الفرع *</label>
                        <select class="form-input form-select" id="editMemberBranch" required>
                            <option value="الرياض">الرياض</option>
                            <option value="الدمام">الدمام</option>
                            <option value="أحد رفيدة">أحد رفيدة</option>
                            <option value="حائل">حائل</option>
                            <option value="نجران">نجران</option>
                            <option value="جازان">جازان</option>
                            <option value="سكاكا">سكاكا</option>
                            <option value="بريدة">بريدة</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 2rem; gap: 1rem; display: flex; justify-content: center;">
                    <button type="submit" class="btn btn-success">💾 حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditMemberModal()">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal with Reason -->
    <div id="deleteConfirmationModal" class="delete-confirmation-modal">
        <div class="delete-confirmation-content">
            <h3>تأكيد الحذف</h3>
            <p id="deleteConfirmationText">هل أنت متأكد من حذف هذا العنصر؟</p>
            <div class="delete-reason-group" id="deleteReasonGroup" style="display: none;">
                <label class="form-label">سبب الحذف *</label>
                <select class="form-input form-select" id="deleteReason" required>
                    <option value="">اختر سبب الحذف</option>
                    <option value="BIB لا يطابق العنوان">BIB لا يطابق العنوان</option>
                    <option value="لا يوجد شريحة">لا يوجد شريحة</option>
                    <option value="المحتوى مخالف">المحتوى مخالف</option>
                    <option value="التصنيف خاطئ">التصنيف خاطئ</option>
                    <option value="غير صالح للإعارة">غير صالح للإعارة</option>
                    <option value="عدم مطابقة العنوان لملف التوريد">عدم مطابقة العنوان لملف التوريد</option>
                    <option value="إصدار قديم">إصدار قديم</option>
                    <option value="مكرر">مكرر</option>
                    <option value="تالف">تالف</option>
                    <option value="مفقود">مفقود</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            <div style="margin-top: 1.5rem; gap: 1rem; display: flex; justify-content: center;">
                <button class="btn btn-danger" onclick="confirmDelete()">نعم، احذف</button>
                <button class="btn btn-secondary" onclick="closeDeleteConfirmationModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo"></div>
            <div class="user-info">
                <span id="currentUser">مرحباً، مستخدم</span>
                <span id="currentBranch" style="font-size: 0.9rem; opacity: 0.8;"></span>
                <button class="btn btn-secondary" onclick="exportCurrentPageData()">تصدير البيانات</button>
                <button class="btn btn-danger" onclick="logout()">خروج</button>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-menu">
            <button class="menu-item active" onclick="showSection('dashboard')">
                🏠 لوحة التحكم
            </button>
            <button class="menu-item" onclick="showSection('sources')">
                📖 إدارة المصادر
            </button>
            <button class="menu-item admin-only supervisor-only manager-only" onclick="showSection('members')">
                👥 إدارة الأعضاء
            </button>
            <button class="menu-item" onclick="showSection('circulation')">
                🔄 الإعارة الداخلية
            </button>
            <button class="menu-item" onclick="showSection('search')">
                🔍 البحث المتقدم
            </button>
            <button class="menu-item" onclick="showSection('reports')">
                📊 التقارير والإحصائيات
            </button>
            <button class="menu-item" onclick="showSection('import')">
                📥 استيراد البيانات
            </button>
            <button class="menu-item admin-only supervisor-only" onclick="showSection('settings')">
                ⚙️ الإعدادات
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="page-section active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">لوحة التحكم الرئيسية</h2>
                    <div class="filters-container">
                        <div class="filters-grid">
                            <div class="form-group">
                                <label class="form-label">فترة النشاط</label>
                                <select class="form-input form-select" id="activityPeriod" onchange="updateDashboard()">
                                    <option value="daily">النشاط اليومي</option>
                                    <option value="weekly">النشاط الأسبوعي</option>
                                    <option value="monthly">النشاط الشهري</option>
                                    <option value="all">جميع الفترات</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">نوع المكتبة</label>
                                <select class="form-input form-select" id="libraryTypeFilter" onchange="updateDashboard()">
                                    <option value="all">جميع المكتبات</option>
                                    <option value="main">المكتبة الرئيسية</option>
                                    <option value="youth">مكتبة اليافعين</option>
                                    <option value="child">مكتبة الطفل</option>
                                </select>
                            </div>
                            <!-- Branch Selector for Admin/Manager -->
                            <div class="form-group admin-only manager-only" id="dashboardBranchFilterGroup">
                                <label class="form-label">الفرع</label>
                                <select class="form-input form-select" id="dashboardBranchFilter" onchange="updateDashboard()">
                                    <option value="all">جميع الفروع</option>
                                    <option value="الرياض">الرياض</option>
                                    <option value="الدمام">الدمام</option>
                                    <option value="أحد رفيدة">أحد رفيدة</option>
                                    <option value="حائل">حائل</option>
                                    <option value="نجران">نجران</option>
                                    <option value="جازان">جازان</option>
                                    <option value="سكاكا">سكاكا</option>
                                    <option value="بريدة">بريدة</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Personal Stats -->
            <div class="user-stats-card" id="userStatsCard">
                <h3>📊 إحصائياتي الشخصية</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userTodayBorrowings">0</div>
                        <div class="stat-label">إعاراتي اليوم</div>
                    </div>
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userWeekBorrowings">0</div>
                        <div class="stat-label">إعاراتي هذا الأسبوع</div>
                    </div>
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userMonthBorrowings">0</div>
                        <div class="stat-label">إعاراتي هذا الشهر</div>
                    </div>
                    <div class="stat-card" style="background: rgba(255,255,255,0.1); border: none;">
                        <div class="stat-number" id="userTotalBorrowings">0</div>
                        <div class="stat-label">إجمالي إعاراتي</div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSources">0</div>
                    <div class="stat-label">إجمالي المصادر</div>
                    <div class="stat-sublabel" id="sourcesByLibrary"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMembers">0</div>
                    <div class="stat-label">إجمالي الأعضاء</div>
                    <div class="stat-sublabel" id="newMembersCount"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="borrowedSources">0</div>
                    <div class="stat-label">الإعارات النشطة</div>
                    <div class="stat-sublabel" id="newBorrowingsCount"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mainLibrarySources">0</div>
                    <div class="stat-label">المكتبة الرئيسية</div>
                    <div class="stat-sublabel">مصدر متاح</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="youthLibrarySources">0</div>
                    <div class="stat-label">مكتبة اليافعين</div>
                    <div class="stat-sublabel">مصدر متاح</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="childLibrarySources">0</div>
                    <div class="stat-label">مكتبة الطفل</div>
                    <div class="stat-sublabel">مصدر متاح</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sourcesWithSpecialNotes">0</div>
                    <div class="stat-label">المصادر التي تحتوي على ملاحظات</div>
                    <div class="stat-sublabel">تحتاج مراجعة</div>
                </div>
            </div>

            <!-- Admin/Supervisor/Manager Only - Employee Performance -->
            <div class="card admin-only supervisor-only manager-only performance-panel">
                <div class="card-header">
                    <h3 class="card-title">أداء الموظفين</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>الموظف</th>
                                    <th>الفرع</th>
                                    <th>إعارات اليوم</th>
                                    <th>إعارات الأسبوع</th>
                                    <th>إعارات الشهر</th>
                                    <th>إجمالي الإعارات</th>
                                    <th>إجمالي الإرجاعات</th>
                                </tr>
                            </thead>
                            <tbody id="employeePerformance">
                                <tr>
                                    <td colspan="7">لا توجد بيانات</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card recent-loans-panel">
                <div class="card-header">
                    <h3 class="card-title">الإعارات الأخيرة</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>العضو</th>
                                    <th>المصدر</th>
                                    <th>نوع المكتبة</th>
                                    <th>تاريخ الإعارة</th>
                                    <th>تاريخ الإرجاع المتوقع</th>
                                    <th>الحالة</th>
                                    <th>الموظف المسؤول</th>
                                    <th>الفرع</th>
                                </tr>
                            </thead>
                            <tbody id="recentBorrowings">
                                <tr>
                                    <td colspan="8">لا توجد إعارات حديثة</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sources Management Section -->
        <section id="sources" class="page-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">إدارة المصادر</h2>
                    <div>
                        <button class="btn btn-primary admin-only supervisor-only" onclick="showAddSourceForm()">➕ إضافة مصدر جديد</button>
                        <button class="btn btn-warning admin-only supervisor-only" onclick="showDeleteBySourceModal()">🗑️ حذف حسب مصدر التوريد</button>
                        <button class="btn btn-danger admin-only" onclick="deleteAllSources()">🗑️ حذف جميع المصادر</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="filters-container">
                        <div class="filters-grid">
                            <div class="form-group">
                                <label class="form-label">حالة المصدر</label>
                                <select class="form-input form-select" id="sourceStatusFilter" onchange="filterSources()">
                                    <option value="all">جميع المصادر</option>
                                    <option value="متاح">متاح</option>
                                    <option value="مستعار">مستعار</option>
                                    <option value="تالف">تالف</option>
                                    <option value="special_notes">المصادر التي تحتوي على ملاحظات</option>
                                    <option value="محذوف">محذوف</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">فلترة حسب المكتبة</label>
                                <select class="form-input form-select" id="sourceLibraryFilter" onchange="filterSources()">
                                    <option value="all">جميع المكتبات</option>
                                    <option value="main">المكتبة الرئيسية</option>
                                    <option value="youth">مكتبة اليافعين</option>
                                    <option value="child">مكتبة الطفل</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">مصدر التوريد</label>
                                <select class="form-input form-select" id="sourceSupplyFilter" onchange="filterSources()">
                                    <option value="all">جميع المصادر</option>
                                    <option value="مكتبة الرشد 1">مكتبة الرشد 1</option>
                                    <option value="مكتبة الرشد 2">مكتبة الرشد 2</option>
                                    <option value="مكتبة الرشد 3">مكتبة الرشد 3</option>
                                    <option value="مكتبة الرشد 4">مكتبة الرشد 4</option>
                                    <option value="مكتبة الرشد 5">مكتبة الرشد 5</option>
                                    <option value="مكتبة الرشد 6">مكتبة الرشد 6</option>
                                    <option value="الوزارة">الوزارة</option>
                                    <option value="أحد رفيدة">أحد رفيدة</option>
                                    <option value="الدمام">الدمام</option>
                                </select>
                            </div>
                            <!-- Branch Selector for Admin/Manager -->
                            <div class="form-group admin-only manager-only" id="sourcesBranchFilterGroup">
                                <label class="form-label">الفرع</label>
                                <select class="form-input form-select" id="sourcesBranchFilter" onchange="filterSources()">
                                    <option value="all">جميع الفروع</option>
                                    <option value="الرياض">الرياض</option>
                                    <option value="الدمام">الدمام</option>
                                    <option value="أحد رفيدة">أحد رفيدة</option>
                                    <option value="حائل">حائل</option>
                                    <option value="نجران">نجران</option>
                                    <option value="جازان">جازان</option>
                                    <option value="سكاكا">سكاكا</option>
                                    <option value="بريدة">بريدة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="resetSourceFilters()">مسح الفلاتر</button>
                            </div>
                        </div>
                    </div>

                    <div class="search-container">
                        <input type="text" class="search-input" id="sourceSearch" placeholder="البحث في المصادر... (العنوان، المؤلف، رقم BIB، التصنيف)">
                        <button class="search-btn" onclick="searchSources()">🔍</button>
                    </div>

                    <div id="addSourceForm" style="display: none;" class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title">إضافة مصدر جديد</h3>
                        </div>
                        <div class="card-body">
                            <form id="sourceForm" onsubmit="addSource(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">رقم BIB * (14 رقم)</label>
                                        <input type="text" class="form-input bib-input" name="bibNumber" required placeholder="مثال: 01234567890123" maxlength="14" oninput="validateBibNumber(this)">
                                        <div class="bib-error">رقم BIB يجب أن يكون 14 رقماً بالضبط</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">العنوان *</label>
                                        <input type="text" class="form-input" name="title" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المؤلف *</label>
                                        <input type="text" class="form-input" name="author" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">الناشر</label>
                                        <input type="text" class="form-input" name="publisher">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">تاريخ النشر</label>
                                        <input type="number" class="form-input" name="publishYear" min="1900" max="2030">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">اللغة</label>
                                        <select class="form-input form-select" name="language">
                                            <option value="ara">العربية</option>
                                            <option value="eng">الإنجليزية</option>
                                            <option value="fre">الفرنسية</option>
                                            <option value="other">أخرى</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">تصنيف ديوي (Dewey Classification)</label>
                                        <input type="text" class="form-input" name="deweyClassification" onchange="updateDeweyInfo(this)">
                                        <div id="deweyInfo" class="subject-info" style="display: none;"></div>
                                        <div id="thematicClassification" class="thematic-classification" style="display: none;"></div>
</div>
                                   <div class="form-group">
                                       <label class="form-label">عدد النسخ</label>
                                       <input type="number" class="form-input" name="copiesCount" min="1" value="1">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">المكتبة</label>
                                       <select class="form-input form-select" name="library" id="librarySelect" onchange="updateLibraryType()">
                                           <option value="المكتبة الرئيسية">المكتبة الرئيسية</option>
                                           <option value="مكتبة اليافعين">مكتبة اليافعين</option>
                                           <option value="مكتبة الطفل">مكتبة الطفل</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">مصدر التوريد</label>
                                       <select class="form-input form-select" name="source">
                                           <option value="مكتبة الرشد 1">مكتبة الرشد 1</option>
                                           <option value="مكتبة الرشد 2">مكتبة الرشد 2</option>
                                           <option value="مكتبة الرشد 3">مكتبة الرشد 3</option>
                                           <option value="مكتبة الرشد 4">مكتبة الرشد 4</option>
                                           <option value="مكتبة الرشد 5">مكتبة الرشد 5</option>
                                           <option value="مكتبة الرشد 6">مكتبة الرشد 6</option>
                                           <option value="الوزارة">الوزارة</option>
                                           <option value="الدمام">الدمام</option>
                                           <option value="أحد رفيدة">أحد رفيدة</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">حالة المصدر</label>
                                       <select class="form-input form-select" name="status">
                                           <option value="متاح">متاح</option>
                                           <option value="مستعار">مستعار</option>
                                           <option value="تالف">تالف</option>
                                           <option value="BIB لا يطابق العنوان">BIB لا يطابق العنوان</option>
                                           <option value="لا يوجد شريحة">لا يوجد شريحة</option>
                                           <option value="المحتوى مخالف">المحتوى مخالف</option>
                                           <option value="التصنيف خاطئ">التصنيف خاطئ</option>
                                           <option value="غير صالح للإعارة">غير صالح للإعارة</option>
                                           <option value="إصدار قديم">إصدار قديم</option>
                                           <option value="مكرر">مكرر</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">الموقع في المكتبة</label>
                                       <input type="text" class="form-input" name="location">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">تاريخ التوريد</label>
                                       <input type="date" class="form-input" name="supplyDate">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">رقم الرف</label>
                                       <input type="text" class="form-input" name="shelfNumber">
                                   </div>
                               </div>
                               <div class="form-group">
                                   <label class="form-label">ملاحظات</label>
                                   <textarea class="form-input" name="notes" rows="3"></textarea>
                               </div>
                               <div style="text-align: center; margin-top: 2rem;">
                                   <button type="submit" class="btn btn-success">💾 حفظ المصدر</button>
                                   <button type="button" class="btn btn-secondary" onclick="hideAddSourceForm()">إلغاء</button>
                               </div>
                           </form>
                       </div>
                   </div>

                   <!-- Delete by Source Modal -->
                   <div id="deleteBySourceModal" style="display: none;" class="card">
                       <div class="card-header">
                           <h3 class="card-title">حذف المصادر حسب مصدر التوريد</h3>
                       </div>
                       <div class="card-body">
                           <div class="form-group">
                               <label class="form-label">اختر مصدر التوريد للحذف</label>
                               <select class="form-input form-select" id="deleteSourceSelect">
                                   <option value="">اختر مصدر التوريد</option>
                                   <option value="مكتبة الرشد 1">مكتبة الرشد 1</option>
                                   <option value="مكتبة الرشد 2">مكتبة الرشد 2</option>
                                   <option value="مكتبة الرشد 3">مكتبة الرشد 3</option>
                                   <option value="مكتبة الرشد 4">مكتبة الرشد 4</option>
                                   <option value="مكتبة الرشد 5">مكتبة الرشد 5</option>
                                   <option value="مكتبة الرشد 6">مكتبة الرشد 6</option>
                                   <option value="الوزارة">الوزارة</option>
                                   <option value="الدمام">الدمام</option>
                                   <option value="أحد رفيدة">أحد رفيدة</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label class="form-label">سبب الحذف *</label>
                               <select class="form-input form-select" id="deleteBulkReason" required>
                                   <option value="">اختر سبب الحذف</option>
                                   <option value="BIB لا يطابق العنوان">BIB لا يطابق العنوان</option>
                                   <option value="لا يوجد شريحة">لا يوجد شريحة</option>
                                   <option value="المحتوى مخالف">المحتوى مخالف</option>
                                   <option value="التصنيف خاطئ">التصنيف خاطئ</option>
                                   <option value="غير صالح للإعارة">غير صالح للإعارة</option>
                                   <option value="عدم مطابقة العنوان لملف التوريد">عدم مطابقة العنوان لملف التوريد</option>
                                   <option value="إصدار قديم">إصدار قديم</option>
                                   <option value="مكرر">مكرر</option>
                                   <option value="تالف">تالف</option>
                                   <option value="مفقود">مفقود</option>
                                   <option value="أخرى">أخرى</option>
                               </select>
                           </div>
                           <div style="text-align: center; margin-top: 1rem;">
                               <button class="btn btn-danger" onclick="deleteBySource()">🗑️ حذف المصادر</button>
                               <button class="btn btn-secondary" onclick="hideDeleteBySourceModal()">إلغاء</button>
                           </div>
                       </div>
                   </div>

                   <div class="table-container">
                       <table class="table">
                           <thead>
                               <tr>
                                   <th>الرقم</th>
                                   <th>BIB</th>
                                   <th>العنوان</th>
                                   <th>المؤلف</th>
                                   <th>الناشر</th>
                                   <th>تاريخ النشر</th>
                                   <th>اللغة</th>
                                   <th>تصنيف ديوي</th>
                                   <th>التصنيف الموضوعي</th>
                                   <th>عدد النسخ</th>
                                   <th>المكتبة</th>
                                   <th>مصدر التوريد</th>
                                   <th>تاريخ التوريد</th>
                                   <th>رقم الرف</th>
                                   <th>الفرع</th>
                                   <th style="border-right: 1px solid rgba(255,255,255,0.1);">حالة المصدر</th>
<th class="admin-only supervisor-only table-actions" style="border-right: none;">الإجراءات</th>
                               </tr>
                           </thead>
                           <tbody id="sourcesTable">
                               <tr>
                                   <td colspan="17">لا توجد مصادر مضافة بعد</td>
                               </tr>
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </section>

       <!-- Members Management Section -->
       <section id="members" class="page-section admin-only supervisor-only manager-only">
           <div class="card">
               <div class="card-header">
                   <h2 class="card-title">إدارة الأعضاء</h2>
                   <button class="btn btn-primary admin-only supervisor-only" onclick="showAddMemberForm()">👤 إضافة عضو جديد</button>
               </div>
               <div class="card-body">
                   <!-- Branch Selector for Admin/Manager -->
                   <div class="filters-container">
                       <div class="filters-grid">
                           <div class="form-group admin-only manager-only" id="membersBranchFilterGroup">
                               <label class="form-label">الفرع</label>
                               <select class="form-input form-select" id="membersBranchFilter" onchange="filterMembers()">
                                   <option value="all">جميع الفروع</option>
                                   <option value="الرياض">الرياض</option>
                                   <option value="الدمام">الدمام</option>
                                   <option value="أحد رفيدة">أحد رفيدة</option>
                                   <option value="حائل">حائل</option>
                                   <option value="نجران">نجران</option>
                                   <option value="جازان">جازان</option>
                                   <option value="سكاكا">سكاكا</option>
                                   <option value="بريدة">بريدة</option>
                               </select>
                           </div>
                       </div>
                   </div>

                   <div class="search-container">
                       <input type="text" class="search-input" id="memberSearch" placeholder="البحث في الأعضاء... (الاسم، رقم العضوية)">
                       <button class="search-btn" onclick="searchMembers()">🔍</button>
                   </div>

                   <div id="addMemberForm" style="display: none;" class="card" style="margin-bottom: 2rem;">
                       <div class="card-header">
                           <h3 class="card-title">إضافة عضو جديد</h3>
                       </div>
                       <div class="card-body">
                           <form id="memberForm" onsubmit="addMember(event)">
                               <div class="form-grid">
                                   <div class="form-group">
                                       <label class="form-label">رقم العضوية *</label>
                                       <input type="text" class="form-input" name="membershipNumber" required id="membershipNumberInput" placeholder="مثال: LIB001">
                                       <small style="color: #666; font-size: 0.9rem;">رقم عضوية فريد للمستخدم</small>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">كلمة المرور *</label>
                                       <input type="password" class="form-input" name="userPassword" required placeholder="أدخل كلمة مرور قوية">
                                       <small style="color: #666; font-size: 0.9rem;">يجب أن تكون كلمة المرور قوية وآمنة</small>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">الاسم الكامل *</label>
                                       <input type="text" class="form-input" name="fullName" required placeholder="الاسم الكامل للمستخدم">
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">نوع العضوية *</label>
                                       <select class="form-input form-select" name="memberType" required>
                                           <option value="">اختر النوع</option>
                                           <option value="مدير النظام">مدير النظام</option>
                                           <option value="مشرف فرع">مشرف فرع</option>
                                           <option value="أمين مكتبة">أمين مكتبة</option>
                                       </select>
                                   </div>
                                   <div class="form-group">
                                       <label class="form-label">الفرع *</label>
                                       <select class="form-input form-select" name="branch" required>
                                           <option value="">اختر الفرع</option>
                                           <option value="الرياض">الرياض</option>
                                           <option value="الدمام">الدمام</option>
                                           <option value="أحد رفيدة">أحد رفيدة</option>
                                           <option value="حائل">حائل</option>
                                           <option value="نجران">نجران</option>
                                           <option value="جازان">جازان</option>
                                           <option value="سكاكا">سكاكا</option>
                                           <option value="بريدة">بريدة</option>
                                       </select>
                                   </div>
                               </div>
                               <div style="text-align: center; margin-top: 2rem;">
                                   <button type="submit" class="btn btn-success">💾 حفظ العضو</button>
                                   <button type="button" class="btn btn-secondary" onclick="hideAddMemberForm()">إلغاء</button>
                               </div>
                           </form>
                       </div>
                   </div>

                   <div class="table-container">
                       <table class="table">
                           <thead>
                               <tr>
                                   <th>رقم العضوية</th>
                                   <th>الاسم الكامل</th>
                                   <th>نوع العضوية</th>
                                   <th style="border-right: 1px solid rgba(255,255,255,0.1);">الفرع</th>
                                   <th class="admin-only supervisor-only" style="border-right: 1px solid rgba(255,255,255,0.1);">الإجراءات</th>
                               </tr>
                           </thead>
                           <tbody id="membersTable">
                               <tr>
                                   <td colspan="5">لا يوجد أعضاء مسجلين بعد</td>
                               </tr>
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </section>

       <!-- Circulation Section -->
       <section id="circulation" class="page-section">
           <div class="card">
               <div class="card-header">
                 <h2 class="card-title">الإعارة الداخلية</h2>
                  <small style="color: #666;">مدة الإعارة: حتى نهاية نفس اليوم</small>
              </div>
              <div class="card-body">
                  <div class="form-grid">
                      <div class="scanner-container">
                          <h3>رقم العضوية</h3>
                          <input type="text" class="scanner-input" id="memberBarcode" placeholder="امسح باركود العضو أو اكتب رقم العضوية" onchange="loadMemberInfo()" readonly>
                          <div id="memberInfo" style="margin-top: 1rem;"></div>
                      </div>
                      <div class="scanner-container">
                          <h3>امسح باركود المصدر</h3>
                          <input type="text" class="scanner-input" id="sourceBarcode" placeholder="امسح باركود المصدر أو اكتب رقم BIB" onchange="loadSourceInfo()">
                          <div id="sourceInfo" style="margin-top: 1rem;"></div>
                      </div>
                  </div>

                  <div style="text-align: center; margin: 2rem 0;">
                      <button class="btn btn-success" onclick="borrowSource()" id="borrowBtn" disabled>📚 إعارة المصدر</button>
                      <button class="btn btn-warning" onclick="returnSource()" id="returnBtn" disabled>↩️ إرجاع المصدر</button>
                      <button class="btn btn-secondary" onclick="clearCirculation()">🔄 مسح البيانات</button>
                  </div>

                  <div id="circulationResult" style="margin-top: 2rem;"></div>
              </div>
          </div>

          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">الإعارات النشطة</h3>
              </div>
              <div class="card-body">
                  <div class="table-container">
                      <table class="table">
                          <thead>
                              <tr>
                                  <th>العضو</th>
                                  <th>المصدر</th>
                                  <th>نوع المكتبة</th>
                                  <th>تاريخ الإعارة</th>
                                  <th>تاريخ الإرجاع المطلوب</th>
                                  <th>الوقت المتبقي</th>
                                  <th>الموظف المسؤول</th>
                                  <th>الفرع</th>
                                  <th>الإجراءات</th>
                              </tr>
                          </thead>
                          <tbody id="activeBorrowings">
                              <tr>
                                  <td colspan="9">لا توجد إعارات نشطة</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </section>

      <!-- Search Section -->
      <section id="search" class="page-section">
          <div class="card">
              <div class="card-header">
                  <h2 class="card-title">البحث المتقدم</h2>
              </div>
              <div class="card-body">
                  <div class="form-grid">
                      <div class="form-group">
                          <label class="form-label">العنوان</label>
                          <input type="text" class="form-input" id="searchTitle">
                      </div>
                      <div class="form-group">
                          <label class="form-label">المؤلف</label>
                          <input type="text" class="form-input" id="searchAuthor">
                      </div>
                      <div class="form-group">
                          <label class="form-label">رقم BIB</label>
                          <input type="text" class="form-input" id="searchBib">
                      </div>
                      <div class="form-group">
                          <label class="form-label">تصنيف ديوي</label>
                          <input type="text" class="form-input" id="searchDewey">
                      </div>
                      <div class="form-group">
                          <label class="form-label">سنة النشر من</label>
                          <input type="number" class="form-input" id="searchYearFrom">
                      </div>
                      <div class="form-group">
                          <label class="form-label">سنة النشر إلى</label>
                          <input type="number" class="form-input" id="searchYearTo">
                      </div>
                      <div class="form-group">
                          <label class="form-label">المكتبة</label>
                          <select class="form-input form-select" id="searchLibrary">
                              <option value="">جميع المكتبات</option>
                              <option value="المكتبة الرئيسية">المكتبة الرئيسية</option>
                              <option value="مكتبة اليافعين">مكتبة اليافعين</option>
                              <option value="مكتبة الطفل">مكتبة الطفل</option>
                          </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">الحالة</label>
                          <select class="form-input form-select" id="searchStatus">
                              <option value="">جميع الحالات</option>
                              <option value="متاح">متاح</option>
                              <option value="مستعار">مستعار</option>
                              <option value="تالف">تالف</option>
                          </select>
                      </div>
                  </div>
                  <div style="text-align: center; margin: 2rem 0;">
                      <button class="btn btn-primary" onclick="performAdvancedSearch()">🔍 بحث متقدم</button>
                      <button class="btn btn-secondary" onclick="clearSearch()">مسح البحث</button>
                  </div>

                  <div class="table-container">
                      <table class="table" id="searchResults" style="display: none;">
                          <thead>
                              <tr>
                                  <th>BIB</th>
                                  <th>العنوان</th>
                                  <th>المؤلف</th>
                                  <th>المكتبة</th>
                                  <th>سنة النشر</th>
                                  <th>الحالة</th>
                                  <th>التصنيف الموضوعي</th>
                                  <th>الموقع</th>
                                  <th>الفرع</th>
                              </tr>
                          </thead>
                          <tbody id="searchResultsBody">
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </section>

      <!-- Reports Section -->
      <section id="reports" class="page-section">
          <div class="card">
              <div class="card-header">
                  <h2 class="card-title">التقارير والإحصائيات</h2>
              </div>
              <div class="card-body">
                  <!-- Date Range Selector -->
                  <div class="date-range-selector">
                      <h4>🗓️ تحديد فترة التقرير</h4>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">من تاريخ</label>
                              <input type="date" class="form-input" id="reportStartDate">
                          </div>
                          <div class="form-group">
                              <label class="form-label">إلى تاريخ</label>
                              <input type="date" class="form-input" id="reportEndDate">
                          </div>
                      </div>
                  </div>

                  <div class="form-grid">
                      <button class="btn btn-primary" onclick="generateDailyReport()">📅 التقرير اليومي</button>
                      <button class="btn btn-primary" onclick="generateWeeklyReport()">📆 التقرير الأسبوعي</button>
                      <button class="btn btn-primary" onclick="generateMonthlyReport()">🗓️ التقرير الشهري</button>
                      <button class="btn btn-primary" onclick="generateSourcesReport()">📚 تقرير المصادر</button>
                      <button class="btn btn-primary admin-only supervisor-only manager-only" onclick="generateMembersReport()">👥 تقرير الأعضاء</button>
                      <button class="btn btn-primary" onclick="generateBorrowingReport()">🔄 تقرير الإعارات</button>
                      <button class="btn btn-primary" onclick="generateLibraryTypeReport()">🏛️ تقرير حسب نوع المكتبة</button>
                      <button class="btn btn-primary" onclick="generateStatisticsReport()">📊 تقرير إحصائي شامل</button>
                      <button class="btn btn-primary" onclick="generateReadingReport()">📖 تقرير المصادر المقروءة</button>
                      <button class="btn btn-primary admin-only" onclick="generateDeletedSourcesReport()">🗑️ تقرير المصادر المحذوفة</button>
                  </div>

                  <div id="reportResults" class="card" style="margin-top: 2rem; display: none;">
                      <div class="card-header">
                          <h3 class="card-title" id="reportTitle">نتائج التقرير</h3>
                      </div>
                      <div class="card-body" id="reportContent">
                      </div>
                  </div>
              </div>
          </div>
      </section>

      <!-- Import Section -->
      <section id="import" class="page-section">
          <div class="card">
              <div class="card-header">
                  <h2 class="card-title">استيراد البيانات</h2>
              </div>
              <div class="card-body">
                  <div class="card">
                      <div class="card-header">
                          <h4>استيراد المصادر</h4>
                      </div>
                      <div class="card-body">
                          <div class="file-upload" onclick="document.getElementById('sourcesFileInput').click()">
                              <p>📁 اختر ملف الإكسل للمصادر</p>
                              <p style="font-size: 0.9rem; color: #666;">
                                  <strong>المتطلبات الأساسية:</strong><br>
                                  • رقم BIB (14 رقم بالضبط)<br>
                                  • العنوان<br><br>
                                  <strong>أسماء الأعمدة المقبولة:</strong><br>
                                  • العنوان / Title<br>
                                  • المؤلف / Author<br>
                                  • BIB / رقم BIB<br>
                                  • الناشر / Publisher<br>
                                  • تاريخ النشر / سنة النشر<br>
                                  • اللغة / Language<br>
                                  • تصنيف ديوي / Dewey Classification<br>
                                  • عدد النسخ<br>
                                  • المكتبة<br>
                                  • مصدر التوريد / Source<br>
                                  • حالة المصدر / Status<br>
                                  • تاريخ التوريد<br>
                                  • رقم الرف
                              </p>
                              <p style="font-size: 0.8rem; color: #888;">
                                  💡 النظام يتعرف تلقائياً على أسماء الأعمدة باللغة العربية والإنجليزية
                              </p>
                          </div>
                          <input type="file" id="sourcesFileInput" accept=".xlsx,.xls,.csv" onchange="showFileUploadWarning('sources', this)">
                          <div style="margin-top: 1rem; display: flex; gap: 10px; flex-wrap: wrap;">
                              <button class="btn btn-success" onclick="document.getElementById('sourcesFileInput').click()" style="flex: 1; min-width: 150px;">📚 استيراد المصادر</button>
                          </div>
                      </div>
                  </div>

                  <div id="importResults" style="margin-top: 2rem;"></div>
              </div>
          </div>
      </section>

      <!-- Settings Section -->
      <section id="settings" class="page-section admin-only supervisor-only settings-page-only">
          <div class="card settings-only-card">
              <div class="card-header">
                  <h2 class="card-title">إعدادات النظام</h2>
              </div>
              <div class="card-body">
                  <!-- System Configuration Card -->
                  <div class="card" style="margin-bottom: 2rem;">
                      <div class="card-header">
                          <h4>الإعدادات العامة</h4>
                      </div>
                      <div class="card-body">
                          <div class="form-grid">
                              <div class="form-group">
                                  <label class="form-label">اسم المكتبة</label>
                                  <input type="text" class="form-input" id="libraryName" value="المكتبة الرئيسية">
                                  <small style="color: #666; font-size: 0.9rem;">أدخل اسم المكتبة الذي سيظهر في التقارير والوثائق</small>
                              </div>
                              <div class="form-group">
                                  <label class="form-label">فترة الإعارة</label>
                                  <select class="form-input form-select" id="borrowingPeriod" readonly>
                                      <option value="end_of_day">حتى نهاية نفس اليوم</option>
                                  </select>
                                  <small style="color: #666; font-size: 0.9rem;">الإعارة تنتهي عند منتصف الليل من نفس اليوم</small>
                              </div>
                              <div class="form-group">
                                  <label class="form-label">الحد الأقصى للمصادر المستعارة</label>
                                  <input type="number" class="form-input" id="maxBorrowedSources" value="999" min="1" max="999" readonly>
                                  <small style="color: #666; font-size: 0.9rem;">لا يوجد حد أقصى حالياً</small>
                              </div>
                          </div>
                          
                          <div class="alert alert-info" style="margin-top: 1rem; background: #f8f9fa; border-color: #dee2e6; color: #495057;">
                              <strong>💡 ملاحظات مهمة:</strong><br>
                              • تأكد من حفظ الإعدادات بعد أي تغيير<br>
                              • سيتم تطبيق الإعدادات الجديدة على جميع الإعارات القادمة<br>
                              • لن تتأثر الإعارات النشطة بتغيير فترة الإعارة<br>
                              • يمكن للمدير والمشرف فقط تعديل هذه الإعدادات
                          </div>
                      </div>
                  </div>

                  <!-- Data Management Card -->
                  <div class="card" style="margin-bottom: 2rem;">
                      <div class="card-header">
                          <h4>إدارة البيانات</h4>
                      </div>
                      <div class="card-body">
                          <div class="form-grid">
                              <div class="form-group">
                                  <button class="btn btn-success" onclick="saveSettings()" style="width: 100%;">💾 حفظ الإعدادات</button>
                                  <small style="color: #666; font-size: 0.9rem;">احفظ جميع التغييرات على الإعدادات</small>
                              </div>
                              <div class="form-group">
                                  <button class="btn btn-warning" onclick="exportCompleteBackup()" style="width: 100%;">📤 نسخ احتياطي للبيانات</button>
                                  <small style="color: #666; font-size: 0.9rem;">تصدير نسخة احتياطية من جميع البيانات</small>
                              </div>
                              <div class="form-group admin-only">
                                  <button class="btn btn-danger" onclick="clearAllData()" style="width: 100%;">🗑️ مسح جميع البيانات</button>
                                  <small style="color: #666; font-size: 0.9rem;">⚠️ احذر: هذا الإجراء لا يمكن التراجع عنه</small>
                              </div>
                          </div>
                          
                          <div class="alert alert-warning" style="margin-top: 1rem; background: #f8f9fa; border-color: #dee2e6; color: #495057;">
                              <strong>⚠️ تحذير هام:</strong><br>
                              • عمل نسخة احتياطية من البيانات قبل أي تغيير كبير<br>
                              • التأكد من صحة الإعدادات قبل الحفظ<br>
                              • مسح البيانات سيحذف جميع المصادر والأعضاء والإعارات نهائياً
                          </div>
                      </div>
                  </div>

                  <!-- System Status Card -->
                  <div class="card">
                      <div class="card-header">
                          <h4>حالة النظام</h4>
                      </div>
                      <div class="card-body">
                          <div class="stats-grid">
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsSourceCount">0</div>
                                  <div class="stat-label">إجمالي المصادر النشطة</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsMemberCount">0</div>
                                  <div class="stat-label">إجمالي الأعضاء</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsBorrowingCount">0</div>
                                  <div class="stat-label">الإعارات النشطة</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number" id="settingsDeletedCount">0</div>
                                  <div class="stat-label">المصادر المحذوفة</div>
                              </div>
                          </div>
                          
                          <!-- Deleted Sources Summary -->
                          <div style="margin-top: 2rem;">
                              <h5>📊 ملخص المصادر المحذوفة حسب مصدر التوريد:</h5>
                              <div id="deletedSourcesSummary" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                  <p style="color: #666; margin: 0;">لا توجد مصادر محذوفة</p>
                              </div>
                          </div>
                          
                          <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                              <strong>📊 إحصائيات سريعة:</strong><br>
                              <p style="margin: 0.5rem 0; font-size: 0.9rem;">آخر تحديث: <span id="lastUpdateTime">غير محدد</span></p>
                              <p style="margin: 0.5rem 0; font-size: 0.9rem;">حجم البيانات المحفوظة: <span id="dataSize">حساب...</span></p>
                              <p style="margin: 0.5rem 0; font-size: 0.9rem;">حالة النظام: <span style="color: green;">✅ يعمل بشكل طبيعي</span></p>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </section>
  </main>

 <footer class="footer">
        <p>© رفـــوفـــ</p>
        <p>صُنع  بـــ🤍 في حائل  </p>
        <p>للدعم: <a href="mailto:aisha.a@ihr.com.sa">aisha.a@ihr.com.sa</a></p>
    </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
      // Global Variables - Branch-isolated data structures
      const DATA = {
          sources: [],
          members: [],
          borrowings: [],
          deletedSources: [],
          settings: { 
              libraryName: 'المكتبة الرئيسية', 
              borrowingPeriod: 'end_of_day', 
              maxBorrowedSources: 999 
          }
      };

      // User management with updated roles - Admin -> Manager, Added Manager role
      const USER_ACCOUNTS = {
          'ADMIN001': { password: 'Admin@123', role: 'admin', name: 'مدير النظام العام', branch: 'all' },
          'MANAGER001': { password: 'Manager@123', role: 'manager', name: 'مدير عام', branch: 'all' },
           '3945': { password: 'Deema@123', role: 'librarian', name: 'ديما  مبارك السلامة', branch: 'حائل' },
         '1111': { password: 'LIB@123', role: 'librarian', name: 'سارة عادل الصلحاني', branch: 'حائل' },
          '3234': { password: 'LIB@123', role: 'librarian', name: 'محمد محمود الحماد', branch: 'حائل' },
         '4002': { password: 'LIB@123', role: 'librarian', name: 'حمود سليمان المعجل', branch: 'حائل' },
'3944': { password: 'LIB@123', role: 'librarian', name: 'محمد سالم العنزي', branch: 'حائل' },
          '1': { password: 'LIB@123', role: 'librarian', name: 'نوير عبدالسلام الشلاش', branch: 'حائل' }

      };

      let currentUser = { role: '', membershipNumber: '', name: '', branch: '', authenticated: false };
      let currentReportData = null, currentReportType = '';
      let pendingDeleteAction = null;

      // Updated Dewey Decimal Classification System
      const DEWEY_CLASSIFICATIONS = {
          '000-099': 'المعارف العامة',
          '100-199': 'الفلسفة وعلم النفس', 
          '200-299': 'الديانات',
          '300-399': 'العلوم الاجتماعية',
          '400-499': 'اللغات',
          '500-599': 'العلوم البحتة',
          '600-699': 'العلوم التطبيقية',
          '700-799': 'الفنون',
          '800-899': 'الآداب',
          '900-999': 'التاريخ والجغرافيا والتراجم'
      };

      // Enhanced special notes criteria for sources
      const SPECIAL_NOTES_CRITERIA = [
          'BIB لا يطابق العنوان',
          'لا يوجد شريحة',
          'المحتوى مخالف', 
          'التصنيف خاطئ',
          'غير صالح للإعارة',
          'عدم مطابقة العنوان لملف التوريد',
          'إصدار قديم',
          'مكرر'
      ];

      // CRITICAL FIX: Updated source statuses that prevent borrowing
      const NON_BORROWABLE_STATUSES = [
          'BIB لا يطابق العنوان',
          'لا يوجد شريحة',
          'المحتوى مخالف',
          'التصنيف خاطئ',
          'غير صالح للإعارة',
          'إصدار قديم',
          'مكرر',
          'تالف'
      ];

      // Utility Functions - Updated with enhanced special notes detection
      const Utils = {
          formatDate: (dateString) => new Date(dateString).toLocaleDateString('en-GB'),
          
          showAlert: (message, type) => {
              const alertDiv = document.createElement('div');
              alertDiv.className = `alert alert-${type}`;
              alertDiv.innerHTML = message;
              Object.assign(alertDiv.style, {
                  position: 'fixed', top: '100px', right: '20px', zIndex: '9999',
                  minWidth: '300px', maxWidth: '500px'
              });
              document.body.appendChild(alertDiv);
              setTimeout(() => alertDiv.remove(), 4000);
          },

          validateBibNumber: (input) => {
              const value = input.value.replace(/\D/g, '');
              input.value = value;
              const errorDiv = input.parentNode.querySelector('.bib-error');
              const isValid = value.length === 14 || value.length === 0;
              input.classList.toggle('invalid', !isValid);
              if (errorDiv) errorDiv.classList.toggle('show', !isValid);
              return isValid;
          },

          getLibraryTypeFromBib: (bib) => {
              if (!bib) return { type: 'unknown', name: 'غير محدد', class: 'library-unknown' };
              const prefix = bib.substring(0, 2);
              const types = {
                  '01': { type: 'main', name: 'المكتبة الرئيسية', class: 'library-main' },
                  '02': { type: 'youth', name: 'مكتبة اليافعين', class: 'library-youth' },
                  '03': { type: 'child', name: 'مكتبة الطفل', class: 'library-child' }
              };
              return types[prefix] || { type: 'unknown', name: 'غير محدد', class: 'library-unknown' };
          },

          getDeweyCategory: (classification) => {
              if (!classification) return '';
              const number = parseInt(classification);
              for (const [range, category] of Object.entries(DEWEY_CLASSIFICATIONS)) {
                  const [start, end] = range.split('-').map(r => parseInt(r));
                  if (number >= start && number <= end) return category;
              }
              return '';
          },

          getStatusColor: (status) => {
              const colors = {
                  'متاح': 'success', 'مستعار': 'warning', 'تالف': 'danger',
                  'محذوف': 'danger',
                  'BIB لا يطابق العنوان': 'danger',
                  'لا يوجد شريحة': 'danger', 
                  'المحتوى مخالف': 'danger',
                  'التصنيف خاطئ': 'warning',
                  'غير صالح للإعارة': 'warning',
                  'إصدار قديم': 'secondary',
                  'مكرر': 'danger'
              };
              return colors[status] || 'secondary';
          },

          isWithinPeriod: (date, period) => {
              const now = new Date();
              const targetDate = new Date(date);
              
              switch(period) {
                  case 'daily':
                      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                      const checkDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
                      return checkDate.getTime() === today.getTime();
                  case 'weekly':
                      const weekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                      return targetDate >= weekAgo && targetDate <= now;
                  case 'monthly':
                      const monthAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                      return targetDate >= monthAgo && targetDate <= now;
                  default:
                      return true;
              }
          },

          // Enhanced: Check if source has special notes that need attention
          hasSpecialNotes: (source) => {
              if (!source) return false;
              
              // Check for all zeros BIB (no chip)
              if (source.bibNumber === '00000000000000') {
                  return true;
              }
              
              // Check for old publication (before 2014)
              if (source.publishYear && parseInt(source.publishYear) < 2014) {
                  return true;
              }
              
              // Check for duplicate BIB in same branch
              const duplicateBib = DATA.sources.filter(s => 
                  s.bibNumber === source.bibNumber && 
                  s.branch === source.branch && 
                  s.id !== source.id &&
                  !s.deleted
              ).length > 0;
              
              if (duplicateBib) {
                  return true;
              }
              
              // Check for explicit special notes criteria
              if (source.notes) {
                  const notes = source.notes.toLowerCase();
                  const hasSpecialCriteria = SPECIAL_NOTES_CRITERIA.some(criteria => 
                      notes.includes(criteria.toLowerCase())
                  );
                  
                  if (hasSpecialCriteria) {
                      return true;
                  }
              }
              
              // Check status for special conditions - CRITICAL UPDATE
              if (source.status && NON_BORROWABLE_STATUSES.includes(source.status)) {
                  return true;
              }
              
              return false;
          },

          // Enhanced: Get end of day date
          getEndOfDay: (date = new Date()) => {
              const endOfDay = new Date(date);
              endOfDay.setHours(23, 59, 59, 999);
              return endOfDay;
          },

          // NEW: Check if source is borrowable
          isBorrowable: (source) => {
              if (!source || source.deleted) return false;
              
              // Sources with special notes statuses are NOT borrowable
              if (NON_BORROWABLE_STATUSES.includes(source.status)) {
                  return false;
              }
              
              // Only available sources can be borrowed
              return source.status === 'متاح';
          }
      };


const ValidationUtils = {
    // Check for "لا توجد شريحة" or 14 zeros in BIB or title
    hasNoChipIndicator: (text) => {
        if (!text) return false;
        const cleanText = text.toString().toLowerCase().trim();
        
        // Check for "لا توجد شريحة" phrase
        if (cleanText.includes('لا توجد شريحة') || 
            cleanText.includes('لا يوجد شريحة') ||
            cleanText.includes('no chip') ||
            cleanText.includes('no slide')) {
            return true;
        }
        
        // Check for 14 zeros (all zeros BIB)
        if (cleanText === '00000000000000' || cleanText.includes('00000000000000')) {
            return true;
        }
        
        return false;
    },
    
    // Check for BIB duplication within same branch
    checkBibDuplication: (bibNumber, currentSourceId, branch) => {
        return DATA.sources.find(s => 
            s.bibNumber === bibNumber && 
            s.branch === branch && 
            !s.deleted &&
            s.id !== currentSourceId
        );
    },
    
    // Check for title duplication within same branch
    checkTitleDuplication: (title, currentSourceId, branch) => {
        const normalizedTitle = title.toLowerCase().trim();
        return DATA.sources.find(s => 
            s.title.toLowerCase().trim() === normalizedTitle && 
            s.branch === branch && 
            !s.deleted &&
            s.id !== currentSourceId
        );
    },
    
    // Enhanced source validation
    validateSourceData: (sourceData, currentSourceId = null) => {
        const errors = [];
        const warnings = [];
        const userBranch = ['admin', 'manager'].includes(currentUser.role) ? 
            (sourceData.branch || 'الرياض') : currentUser.branch;
        
        // BIB validation
        if (!sourceData.bibNumber || sourceData.bibNumber.length !== 14) {
            errors.push('رقم BIB يجب أن يكون 14 رقماً بالضبط');
        }
        
        // Title validation
        if (!sourceData.title || sourceData.title.trim() === '') {
            errors.push('العنوان مطلوب');
        }
        
        // Author validation
        if (!sourceData.author || sourceData.author.trim() === '') {
            errors.push('المؤلف مطلوب');
        }
        
        // Check for no chip indicators
        if (ValidationUtils.hasNoChipIndicator(sourceData.bibNumber)) {
            warnings.push('تم اكتشاف "لا توجد شريحة" أو أرقام صفرية في رقم BIB');
        }
        
        if (ValidationUtils.hasNoChipIndicator(sourceData.title)) {
            warnings.push('تم اكتشاف "لا توجد شريحة" في العنوان');
        }
        
        // Check for BIB duplication
        if (sourceData.bibNumber) {
            const duplicateBib = ValidationUtils.checkBibDuplication(
                sourceData.bibNumber, currentSourceId, userBranch
            );
            if (duplicateBib) {
                warnings.push(`رقم BIB مكرر في نفس الفرع - موجود في المصدر: "${duplicateBib.title}"`);
            }
        }
        
        // Check for title duplication
        if (sourceData.title) {
            const duplicateTitle = ValidationUtils.checkTitleDuplication(
                sourceData.title, currentSourceId, userBranch
            );
            if (duplicateTitle) {
                warnings.push(`العنوان مكرر في نفس الفرع - موجود مع رقم BIB: "${duplicateTitle.bibNumber}"`);
            }
        }
        
        return { errors, warnings, isValid: errors.length === 0 };
    }
};

      // Storage Management - same as before
      const Storage = {
          save: () => {
              try {
                  Object.entries(DATA).forEach(([key, value]) => {
                      localStorage.setItem(`librarySystem${key.charAt(0).toUpperCase() + key.slice(1)}`, JSON.stringify(value));
                  });
                  localStorage.setItem('librarySystemAuth', JSON.stringify({
                      ...currentUser, loginTime: new Date().getTime()
                  }));
              } catch (error) {
                  Utils.showAlert('خطأ في حفظ البيانات المحلية', 'warning');
              }
          },

          load: () => {
              try {
                  Object.keys(DATA).forEach(key => {
                      const saved = localStorage.getItem(`librarySystem${key.charAt(0).toUpperCase() + key.slice(1)}`);
                      if (saved) DATA[key] = JSON.parse(saved);
                  });

                  // Check authentication
                  const savedAuth = localStorage.getItem('librarySystemAuth');
                  if (savedAuth) {
                      const authData = JSON.parse(savedAuth);
                      const hoursSinceLogin = (new Date().getTime() - authData.loginTime) / (1000 * 60 * 60);
                      
                      if (hoursSinceLogin < 24 && authData.authenticated) {
                          currentUser = authData;
                          hideLoginModal();
                          applyUserPermissions();
                          initializeSystem();
                      }
                  }
              } catch (error) {
                  Utils.showAlert('خطأ في تحميل البيانات المحفوظة', 'warning');
              }
          }
      };

      // Authentication System - Updated for new roles
    function authenticateUser(event) {
    event.preventDefault();
    // Trim whitespace from both inputs for robust validation
    const membershipNumber = document.getElementById('membershipNumber').value.trim();
    const password = document.getElementById('password').value.trim();
    

          // Check predefined accounts first
          const account = USER_ACCOUNTS[membershipNumber];
          if (account && account.password === password) {
              currentUser = {
                  membershipNumber,
                  role: account.role,
                  name: account.name,
                  branch: account.branch,
                  authenticated: true
              };
              
              hideLoginModal();
              applyUserPermissions();
              Storage.save();
              initializeSystem();
              return;
          }

          // Check custom users
          const customUser = DATA.members.find(user => 
              user.membershipNumber === membershipNumber && 
              user.password === password
          );

          if (customUser) {
              // Auto-detect role from memberType
              let role = 'librarian';
              if (customUser.memberType === 'مدير النظام') role = 'admin';
              else if (customUser.memberType === 'مشرف فرع') role = 'supervisor';
              
              currentUser = {
                  membershipNumber,
                  role,
                  name: customUser.fullName,
                  branch: customUser.branch,
                  authenticated: true
              };
              
              hideLoginModal();
              applyUserPermissions();
              Storage.save();
              initializeSystem();
          } else {
              errorDiv.style.display = 'block';
              errorDiv.textContent = 'بيانات تسجيل الدخول غير صحيحة';
          }
      }

      function applyUserPermissions() {
          document.body.className = `${currentUser.role}-mode`;
          document.getElementById('currentUser').textContent = `مرحباً، ${currentUser.name}`;
          
          if (!['admin', 'manager'].includes(currentUser.role)) {
              document.getElementById('currentBranch').textContent = `الفرع: ${currentUser.branch}`;
          }
      }

      function hideLoginModal() {
          document.getElementById('loginModal').style.display = 'none';
      }

      function logout() {
          if (confirm('هل تريد تسجيل الخروج؟')) {
              currentUser = { role: '', membershipNumber: '', name: '', branch: '', authenticated: false };
              document.body.className = '';
              localStorage.removeItem('librarySystemAuth');
              location.reload();
          }
      }

      // Data Filtering - Updated for Manager role
      const DataFilter = {
          getFilteredSources: (filters = {}) => {
              let filtered = DATA.sources.filter(source => !source.deleted);
              
              // Branch filtering - Updated for Manager role
              if (['admin', 'manager'].includes(currentUser.role)) {
                  // Admin and Manager can see all or filter by specific branch
                  if (filters.branch && filters.branch !== 'all') {
                      filtered = filtered.filter(source => source.branch === filters.branch);
                  }
              } else {
                  // Non-admin users can only see their branch data
                  filtered = filtered.filter(source => source.branch === currentUser.branch);
              }

              // Other filters
              Object.entries(filters).forEach(([key, value]) => {
                  if (value && value !== 'all' && key !== 'branch') {
                      if (key === 'status' && value === 'special_notes') {
                          filtered = filtered.filter(source => Utils.hasSpecialNotes(source));
                      } else if (key === 'library') {
                          filtered = filtered.filter(source => {
                              const libType = Utils.getLibraryTypeFromBib(source.bibNumber);
                              return libType.type === value;
                          });
                      } else {
                          filtered = filtered.filter(source => source[key] === value);
                      }
                  }
              });

              return filtered;
          },

          getFilteredMembers: (filters = {}) => {
              let filtered = [...DATA.members];
              
              // Add predefined accounts to the filtered members list
              const predefinedMembers = Object.entries(USER_ACCOUNTS).map(([membershipNumber, account]) => ({
                  id: `predefined_${membershipNumber}`,
                  membershipNumber,
                  fullName: account.name,
                  memberType: account.role === 'admin' ? 'مدير النظام' : 
                            account.role === 'supervisor' ? 'مشرف فرع' : 
                            account.role === 'manager' ? 'مدير عام' : 'أمين مكتبة',
                  branch: account.branch === 'all' ? 'جميع الفروع' : account.branch,
                  joinDate: new Date().toISOString(),
                  isPredefined: true
              }));
              
              filtered = [...filtered, ...predefinedMembers];
              
              // Branch filtering - Updated for Manager role
              if (['admin', 'manager'].includes(currentUser.role)) {
                  if (filters.branch && filters.branch !== 'all') {
                      filtered = filtered.filter(member => 
                          member.branch === filters.branch || 
                          (member.branch === 'جميع الفروع' && filters.branch !== 'all')
                      );
                  }
              } else if (currentUser.role === 'supervisor') {
                  // Supervisors can only see members from their branch
                  filtered = filtered.filter(member => 
                      member.branch === currentUser.branch || 
                      member.branch === 'جميع الفروع'
                  );
              }

              return filtered;
          },

          getFilteredBorrowings: (filters = {}) => {
              let filtered = DATA.borrowings;
              
              // Branch filtering - Updated for Manager role
              if (['admin', 'manager'].includes(currentUser.role)) {
                  if (filters.branch && filters.branch !== 'all') {
                      filtered = filtered.filter(borrowing => borrowing.branch === filters.branch);
                  }
              } else {
                  // Non-admin/manager users can only see their branch borrowings
                  filtered = filtered.filter(borrowing => borrowing.branch === currentUser.branch);
              }

              return filtered;
          }
      };
function editSource(sourceId) {
          // Check if the provided ID is valid before doing anything else
          if (sourceId === null || sourceId === undefined) {
              Utils.showAlert('خطأ: معرف المصدر غير صالح. لا يمكن التعديل.', 'danger');
              return;
          }

          const source = DATA.sources.find(s => s.id === sourceId);
          if (!source) {
              Utils.showAlert('المصدر غير موجود!', 'danger');
              return;
          }

          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه تعديل المصادر.', 'danger');
              return;
          }

          if (!['admin', 'manager'].includes(currentUser.role) && source.branch !== currentUser.branch) {
              Utils.showAlert('لا يمكن تعديل مصدر من فرع آخر!', 'danger');
              return;
          }

          // Populate edit form
          document.getElementById('editSourceId').value = source.id;
          document.getElementById('editSourceBib').value = source.bibNumber || '';
          document.getElementById('editSourceTitle').value = source.title || '';
          document.getElementById('editSourceAuthor').value = source.author || '';
          document.getElementById('editSourcePublisher').value = source.publisher || '';
          document.getElementById('editSourceYear').value = source.publishYear || '';
          document.getElementById('editSourceLanguage').value = source.language || 'ara';
          document.getElementById('editSourceDewey').value = source.deweyClassification || '';
          document.getElementById('editSourceCopies').value = source.copiesCount || 1;
          document.getElementById('editSourceLibrary').value = source.library || '';
          document.getElementById('editSourceSupply').value = source.source || '';
          document.getElementById('editSourceStatus').value = source.status || 'متاح';
          document.getElementById('editSourceLocation').value = source.location || '';
          document.getElementById('editSourceSupplyDate').value = source.supplyDate || '';
          document.getElementById('editSourceShelf').value = source.shelfNumber || '';
          document.getElementById('editSourceNotes').value = source.notes || '';

          if (source.deweyClassification) {
              updateEditDeweyInfo({ value: source.deweyClassification });
          }
          document.getElementById('editSourceModal').classList.add('active');
      }
    function updateSource(event) {
          event.preventDefault();

          try {
              // --- 1. FIND THE SOURCE ---
              const sourceIdValue = document.getElementById('editSourceId').value;
              if (!sourceIdValue) {
                  Utils.showAlert('خطأ حرج: لم يتم العثور على معرف المصدر.', 'danger');
                  return;
              }
              const sourceId = parseFloat(sourceIdValue);
              const sourceIndex = DATA.sources.findIndex(s => s.id === sourceId);

              if (sourceIndex === -1) {
                  Utils.showAlert('لم يتم العثور على المصدر. قد تحتاج لتحديث الصفحة.', 'danger');
                  return;
              }

              // --- 2. VALIDATE THE FORM INPUTS ---
              const bibInput = document.getElementById('editSourceBib');
              const titleInput = document.getElementById('editSourceTitle');
              const authorInput = document.getElementById('editSourceAuthor');

              if (!bibInput.value.trim() || bibInput.value.trim().length !== 14 || !/^\d{14}$/.test(bibInput.value.trim())) {
                  Utils.showAlert('فشل الحفظ: رقم BIB يجب أن يكون 14 رقماً بالضبط.', 'danger');
                  bibInput.focus();
                  return;
              }
              if (!titleInput.value.trim()) {
                  Utils.showAlert('فشل الحفظ: حقل العنوان مطلوب.', 'danger');
                  titleInput.focus();
                  return;
              }
              if (!authorInput.value.trim()) {
                  Utils.showAlert('فشل الحفظ: حقل المؤلف مطلوب.', 'danger');
                  authorInput.focus();
                  return;
              }

              // --- 3. UPDATE THE DATA AND SAVE ---
              const updatedSource = {
                  ...DATA.sources[sourceIndex],
                  bibNumber: bibInput.value.trim(),
                  title: titleInput.value.trim(),
                  author: authorInput.value.trim(),
                  publisher: document.getElementById('editSourcePublisher').value.trim(),
                  publishYear: document.getElementById('editSourceYear').value,
                  language: document.getElementById('editSourceLanguage').value,
                  deweyClassification: document.getElementById('editSourceDewey').value.trim(),
                  copiesCount: Math.max(1, parseInt(document.getElementById('editSourceCopies').value) || 1),
                  library: document.getElementById('editSourceLibrary').value,
                  source: document.getElementById('editSourceSupply').value,
                  status: document.getElementById('editSourceStatus').value,
                  location: document.getElementById('editSourceLocation').value.trim(),
                  supplyDate: document.getElementById('editSourceSupplyDate').value,
                  shelfNumber: document.getElementById('editSourceShelf').value.trim(),
                  notes: document.getElementById('editSourceNotes').value.trim(),
                  lastModified: new Date().toISOString(),
                  modifiedBy: currentUser.name
              };
              
              DATA.sources[sourceIndex] = updatedSource;
              Storage.save();

              // --- 4. REFRESH THE USER INTERFACE ---
              closeEditSourceModal(); // Close the pop-up window
              loadSourcesTable();     // Redraw the main sources table
              updateDashboard();      // Update the stats on the dashboard
              Utils.showAlert('تم تحديث المصدر بنجاح!', 'success'); // Show success message

          } catch (error) {
              // This will catch any unexpected errors during the process
              console.error("An unexpected error occurred in updateSource:", error);
              Utils.showAlert("حدث خطأ غير متوقع أثناء الحفظ. يرجى مراجعة وحدة التحكم.", 'danger');
          }
      }
      function editMember(memberId) {
          const member = DATA.members.find(m => m.id === memberId);
          if (!member) {
              Utils.showAlert('العضو غير موجود!', 'danger');
              return;
          }

          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه تعديل الأعضاء.', 'danger');
              return;
          }

          // Branch permission check for supervisors
          if (currentUser.role === 'supervisor' && member.branch !== currentUser.branch) {
              Utils.showAlert('لا يمكن تعديل عضو من فرع آخر!', 'danger');
              return;
          }

          // Populate edit form
          document.getElementById('editMemberId').value = member.id;
          document.getElementById('editMembershipNumber').value = member.membershipNumber || '';
          document.getElementById('editMemberPassword').value = member.password || '';
          document.getElementById('editMemberName').value = member.fullName || '';
          document.getElementById('editMemberType').value = member.memberType || '';
          document.getElementById('editMemberBranch').value = member.branch || '';

          // Show modal
          document.getElementById('editMemberModal').classList.add('active');
      }

      function updateMember(event) {
          event.preventDefault();
          
          const memberId = parseInt(document.getElementById('editMemberId').value);
          const member = DATA.members.find(m => m.id === memberId);
          
          if (!member) {
              Utils.showAlert('العضو غير موجود!', 'danger');
              return;
          }

          const password = document.getElementById('editMemberPassword').value;
          const fullName = document.getElementById('editMemberName').value.trim();
          const memberType = document.getElementById('editMemberType').value;
          const branch = document.getElementById('editMemberBranch').value;

          // Validate required fields
          if (!password || !fullName || !memberType || !branch) {
              Utils.showAlert('جميع الحقول المطلوبة يجب ملؤها!', 'danger');
              return;
          }

          // Branch restriction for supervisors
          if (currentUser.role === 'supervisor' && branch !== currentUser.branch) {
              Utils.showAlert('المشرف يمكنه فقط تعديل أعضاء فرعه فقط!', 'danger');
              return;
          }

          // Validate password strength
          if (password.length < 4) {
              Utils.showAlert('كلمة المرور يجب أن تكون 4 أحرف على الأقل!', 'danger');
              return;
          }

          // Update member properties
          member.password = password;
          member.fullName = fullName;
          member.memberType = memberType;
          member.branch = branch;
          member.lastModified = new Date().toISOString();
          member.modifiedBy = currentUser.name;

          Storage.save();
          closeEditMemberModal();
          loadMembersTable();
          updateDashboard();
          
          Utils.showAlert('تم تحديث العضو بنجاح!', 'success');
      }

      function closeEditMemberModal() {
          document.getElementById('editMemberModal').classList.remove('active');
          document.getElementById('editMemberForm').reset();
      }

function closeEditSourceModal() {
          document.getElementById('editSourceModal').classList.remove('active');
          document.getElementById('editSourceForm').reset();
      }

      // Enhanced Delete Functions with Confirmation Modal
      function deleteSource(sourceId) {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه الحذف.', 'danger');
              return;
          }

          const source = DATA.sources.find(s => s.id === sourceId);
          if (!source) {
              Utils.showAlert('المصدر غير موجود!', 'danger');
              return;
          }

          // Branch permission check
          if (!['admin', 'manager'].includes(currentUser.role) && source.branch !== currentUser.branch) {
              Utils.showAlert('لا يمكن حذف مصدر من فرع آخر!', 'danger');
              return;
          }

          if (source.deleted) {
              // Restore source
              if (confirm('هل تريد استعادة هذا المصدر؟')) {
                  source.deleted = false;
                  source.status = 'متاح';
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  Utils.showAlert('تم استعادة المصدر بنجاح!', 'success');
              }
          } else {
              // Check for active borrowing
              const activeBorrowing = DATA.borrowings.find(b => 
                  b.sourceId === sourceId && !b.returned
              );
              
              if (activeBorrowing) {
                  Utils.showAlert('لا يمكن حذف مصدر مستعار حالياً!', 'warning');
                  return;
              }

              // Show delete confirmation modal with reason
              showDeleteConfirmationModal('source', sourceId, `هل أنت متأكد من حذف المصدر: "${source.title}"؟`);
          }
      }

      function deleteMember(memberId) {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه حذف الأعضاء.', 'danger');
              return;
          }

          const member = DATA.members.find(m => m.id === memberId);
          if (!member) {
              Utils.showAlert('العضو غير موجود!', 'danger');
              return;
          }

          // Branch permission check for supervisors
          if (currentUser.role === 'supervisor' && member.branch !== currentUser.branch) {
              Utils.showAlert('لا يمكن حذف عضو من فرع آخر!', 'danger');
              return;
          }

          // Check for active borrowings
          const activeBorrowings = DATA.borrowings.filter(b => 
              b.membershipNumber === member.membershipNumber && !b.returned
          );
          
          if (activeBorrowings.length > 0) {
              Utils.showAlert('لا يمكن حذف عضو له إعارات نشطة!', 'warning');
              return;
          }

          // Show delete confirmation modal
          showDeleteConfirmationModal('member', memberId, `هل أنت متأكد من حذف العضو: "${member.fullName}"؟`);
      }

      function showDeleteConfirmationModal(type, id, message) {
          document.getElementById('deleteConfirmationText').textContent = message;
          
          // Show reason selector only for sources
          const reasonGroup = document.getElementById('deleteReasonGroup');
          if (type === 'source') {
              reasonGroup.style.display = 'block';
              document.getElementById('deleteReason').required = true;
          } else {
              reasonGroup.style.display = 'none';
              document.getElementById('deleteReason').required = false;
          }

          pendingDeleteAction = { type, id };
          document.getElementById('deleteConfirmationModal').classList.add('active');
      }

      function closeDeleteConfirmationModal() {
          document.getElementById('deleteConfirmationModal').classList.remove('active');
          document.getElementById('deleteReason').value = '';
          pendingDeleteAction = null;
      }

      function confirmDelete() {
          if (!pendingDeleteAction) return;

          const { type, id } = pendingDeleteAction;
          let reason = '';

          if (type === 'source') {
              reason = document.getElementById('deleteReason').value;
              if (!reason) {
                  Utils.showAlert('يرجى اختيار سبب الحذف!', 'warning');
                  return;
              }

              const source = DATA.sources.find(s => s.id === id);
              if (source) {
                  source.deleted = true;
                  source.status = 'محذوف';
                  source.deletedDate = new Date().toISOString();
                  source.deletedBy = currentUser.name;
                  source.deleteReason = reason;
                  
                  // Add to deleted sources summary
                  const deletedRecord = {
                      id: Date.now(),
                      source: source.source,
                      copiesCount: source.copiesCount || 1,
                      deletedDate: new Date().toISOString(),
                      deletedBy: currentUser.name,
                      branch: source.branch,
                      reason: reason
                  };
                  DATA.deletedSources.push(deletedRecord);
                  
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  Utils.showAlert('تم حذف المصدر بنجاح!', 'success');
              }
          } else if (type === 'member') {
              const memberIndex = DATA.members.findIndex(m => m.id === id);
              if (memberIndex !== -1) {
                  DATA.members.splice(memberIndex, 1);
                  Storage.save();
                  loadMembersTable();
                  updateDashboard();
                  Utils.showAlert('تم حذف العضو بنجاح!', 'success');
              }
          }

          closeDeleteConfirmationModal();
      }

      // Dashboard Functions - Updated for special notes count
      function updateDashboard() {
          const period = document.getElementById('activityPeriod').value;
          const libraryType = document.getElementById('libraryTypeFilter').value;
          const branchFilter = ['admin', 'manager'].includes(currentUser.role) ? 
              document.getElementById('dashboardBranchFilter')?.value : null;
          
          const filteredSources = DataFilter.getFilteredSources({ 
              branch: branchFilter,
              library: libraryType !== 'all' ? libraryType : null 
          });
          const filteredBorrowings = DataFilter.getFilteredBorrowings({ branch: branchFilter })
              .filter(b => period === 'all' || Utils.isWithinPeriod(b.borrowDate, period));
          
          // Update stats
          document.getElementById('totalSources').textContent = filteredSources.length;
          document.getElementById('totalMembers').textContent = DataFilter.getFilteredMembers({ branch: branchFilter }).length;
          
          const activeBorrowings = filteredBorrowings.filter(b => !b.returned);
          document.getElementById('borrowedSources').textContent = activeBorrowings.length;
          
          // Library type stats
          ['main', 'youth', 'child'].forEach(type => {
              const sources = filteredSources.filter(s => 
                  Utils.getLibraryTypeFromBib(s.bibNumber).type === type && s.status === 'متاح'
              );
              const elementId = type === 'main' ? 'mainLibrarySources' : 
                                type === 'youth' ? 'youthLibrarySources' : 'childLibrarySources';
              document.getElementById(elementId).textContent = sources.length;
          });
          
          // Updated: Sources with special notes
          const sourcesWithSpecialNotes = filteredSources.filter(s => Utils.hasSpecialNotes(s));
          document.getElementById('sourcesWithSpecialNotes').textContent = sourcesWithSpecialNotes.length;
          
          // Update other components
          loadRecentBorrowings();
          updateUserPersonalStats();
          if (!['librarian'].includes(currentUser.role)) {
              updateEmployeePerformance();
          }
      }

      function updateUserPersonalStats() {
          const userBorrowings = DATA.borrowings.filter(b => b.employeeName === currentUser.name);
          
          ['daily', 'weekly', 'monthly'].forEach(period => {
              const count = userBorrowings.filter(b => Utils.isWithinPeriod(b.borrowDate, period)).length;
              const elementId = period === 'daily' ? 'userTodayBorrowings' : 
                                period === 'weekly' ? 'userWeekBorrowings' : 'userMonthBorrowings';
              document.getElementById(elementId).textContent = count;
          });
          
          document.getElementById('userTotalBorrowings').textContent = userBorrowings.length;
      }

      function updateEmployeePerformance() {
          const tbody = document.getElementById('employeePerformance');
          tbody.innerHTML = '';
          
          // Get borrowings filtered by branch
          const filteredBorrowings = DataFilter.getFilteredBorrowings({});
          const employees = [...new Set(filteredBorrowings.map(b => b.employeeName).filter(name => name))];
          
          if (employees.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7">لا توجد بيانات</td></tr>';
              return;
          }
          
          employees.forEach(employeeName => {
              const employeeBorrowings = filteredBorrowings.filter(b => b.employeeName === employeeName);
              const employeeBranch = employeeBorrowings[0]?.branch || 'غير محدد';
              
              const [today, week, month] = ['daily', 'weekly', 'monthly'].map(period => 
                  employeeBorrowings.filter(b => Utils.isWithinPeriod(b.borrowDate, period)).length
              );
              const returns = employeeBorrowings.filter(b => b.returned).length;
              
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${employeeName}</td>
                  <td>${employeeBranch}</td>
                  <td>${today}</td>
                  <td>${week}</td>
                  <td>${month}</td>
                  <td>${employeeBorrowings.length}</td>
                  <td>${returns}</td>
              `;
              tbody.appendChild(row);
          });
      }

      function loadRecentBorrowings() {
          const tbody = document.getElementById('recentBorrowings');
          const recent = DataFilter.getFilteredBorrowings({})
              .filter(b => !b.returned)
              .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
              .slice(0, 5);
          
          if (recent.length === 0) {
              tbody.innerHTML = '<tr><td colspan="8">لا توجد إعارات حديثة</td></tr>';
              return;
          }
          
          tbody.innerHTML = recent.map(borrowing => {
              const member = DATA.members.find(m => m.membershipNumber === borrowing.membershipNumber) ||
                            USER_ACCOUNTS[borrowing.membershipNumber];
              const source = DATA.sources.find(s => s.id === borrowing.sourceId);
              const libraryType = source ? Utils.getLibraryTypeFromBib(source.bibNumber) : { name: 'غير محدد', class: 'library-unknown' };
              const dueDate = new Date(borrowing.dueDate);
              const isOverdue = dueDate < new Date();
              
              return `
                  <tr>
                      <td>${member ? (member.fullName || member.name) : 'غير محدد'}</td>
                      <td>${source ? source.title : 'غير محدد'}</td>
                      <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                      <td>${Utils.formatDate(borrowing.borrowDate)}</td>
                      <td>${Utils.formatDate(borrowing.dueDate)}</td>
                      <td><span class="badge ${isOverdue ? 'badge-danger' : 'badge-success'}">${isOverdue ? 'متأخر' : 'نشط'}</span></td>
                      <td>${borrowing.employeeName || 'غير محدد'}</td>
                      <td>${borrowing.branch || 'غير محدد'}</td>
                  </tr>
              `;
          }).join('');
      }

      // Sources Management - Updated with enhanced special notes detection
      function showAddSourceForm() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه إضافة المصادر.', 'danger');
              return;
          }
          document.getElementById('addSourceForm').style.display = 'block';
      }

      function hideAddSourceForm() {
          document.getElementById('addSourceForm').style.display = 'none';
          document.getElementById('sourceForm').reset();
      }

      function addSource(event) {
          event.preventDefault();
          
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه إضافة المصادر.', 'danger');
              return;
          }
          
          const formData = new FormData(event.target);
          const bibNumber = formData.get('bibNumber');
          
          if (!Utils.validateBibNumber({ value: bibNumber, parentNode: { querySelector: () => ({ classList: { add: () => {}, remove: () => {} }, style: { display: '' } }) } })) {
              Utils.showAlert('رقم BIB يجب أن يكون 14 رقماً بالضبط', 'danger');
              return;
          }
          
          // Check for duplicates WITHIN THE SAME BRANCH ONLY
          const userBranch = currentUser.branch === 'all' ? 'الرياض' : currentUser.branch;
          const existingSource = DATA.sources.find(source => 
              source.bibNumber === bibNumber && 
              source.branch === userBranch && 
              !source.deleted
          );
          
          let sourceStatus = formData.get('status') || 'متاح';
          let notes = formData.get('notes') || '';
          
          if (existingSource) {
              notes = `مكرر في نفس الفرع - رقم BIB موجود مسبقاً. ${notes}`.trim();
              Utils.showAlert('تم العثور على رقم BIB مكرر في نفس الفرع! تم إضافة ملاحظة.', 'warning');
          }
          
          const source = {
              id: Date.now() + Math.random(),
              bibNumber,
              title: formData.get('title'),
              author: formData.get('author'),
              publisher: formData.get('publisher'),
              publishYear: formData.get('publishYear'),
              language: formData.get('language'),
              deweyClassification: formData.get('deweyClassification'),
              copiesCount: parseInt(formData.get('copiesCount')) || 1,
              library: formData.get('library'),
              source: formData.get('source'),
              status: sourceStatus,
              location: formData.get('location'),
              supplyDate: formData.get('supplyDate'),
              shelfNumber: formData.get('shelfNumber'),
              notes,
              branch: userBranch,
              addedDate: new Date().toISOString(),
              deleted: false
          };
          
          DATA.sources.push(source);
          Storage.save();
          
          loadSourcesTable();
          hideAddSourceForm();
          updateDashboard();
          
          Utils.showAlert('تم إضافة المصدر بنجاح!', 'success');
      }

      // CRITICAL FIX: Updated loadSourcesTable to show proper status and make non-borrowable sources visually distinct
      function loadSourcesTable() {
          const tbody = document.getElementById('sourcesTable');
          tbody.innerHTML = '';
          
          const branchFilter = ['admin', 'manager'].includes(currentUser.role) ? 
              document.getElementById('sourcesBranchFilter')?.value : null;
          const statusFilter = document.getElementById('sourceStatusFilter')?.value;
          const libraryFilter = document.getElementById('sourceLibraryFilter')?.value;
          const sourceFilter = document.getElementById('sourceSupplyFilter')?.value;
          
          let displaySources = DataFilter.getFilteredSources({
              branch: branchFilter,
              status: statusFilter,
              library: libraryFilter,
              source: sourceFilter
          });

          // Handle special filters
          if (statusFilter === 'special_notes') {
              displaySources = displaySources.filter(source => Utils.hasSpecialNotes(source));
          } else if (statusFilter === 'محذوف') {
              // Show deleted sources from current branch
              if (['admin', 'manager'].includes(currentUser.role)) {
                  displaySources = DATA.sources.filter(source => 
                      source.deleted && 
                      (branchFilter === 'all' || !branchFilter || source.branch === branchFilter)
                  );
              } else {
                  displaySources = DATA.sources.filter(source => 
                      source.deleted && source.branch === currentUser.branch
                  );
              }
          }
          
          if (displaySources.length === 0) {
              const colspan = currentUser.role === 'librarian' ? '16' : '17';
              tbody.innerHTML = `<tr><td colspan="${colspan}">لا توجد مصادر تطابق الفلتر المحدد</td></tr>`;
              return;
          }
          
          tbody.innerHTML = displaySources.map((source, index) => {
              const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
              const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
              const actionsHtml = currentUser.role !== 'librarian' ? 
                  `<td>
                      <button class="btn btn-sm btn-warning" onclick="editSource(${source.id})">✏️</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteSource(${source.id})">${source.deleted ? '🔄' : '🗑️'}</button>
                  </td>` : '';
              
              // CRITICAL FIX: Enhanced special notes highlighting and non-borrowable indication
              const hasSpecialNotes = Utils.hasSpecialNotes(source);
              const isNonBorrowable = NON_BORROWABLE_STATUSES.includes(source.status);
              const rowClass = hasSpecialNotes || isNonBorrowable ? 
                  'class="not-borrowable"' : '';
              
              // CRITICAL FIX: Show actual status instead of just "Available" for sources with notes
              const displayStatus = source.deleted ? 'محذوف' : source.status;
              
              return `
                  <tr ${rowClass}>
                      <td>${index + 1}</td>
                      <td>${source.bibNumber || '-'}</td>
                      <td>${source.title}${hasSpecialNotes || isNonBorrowable ? ' <span class=""></span>' : ''}</td>
                      <td>${source.author}</td>
                      <td>${source.publisher || '-'}</td>
                      <td>${source.publishYear || '-'}</td>
                      <td>${source.language || '-'}</td>
                      <td>${source.deweyClassification || '-'}</td>
                      <td><span class="badge badge-secondary">${thematicClassification || '-'}</span></td>
                      <td>${source.copiesCount || 1}</td>
                      <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                      <td>${source.source || '-'}</td>
                      <td>${source.supplyDate ? Utils.formatDate(source.supplyDate) : '-'}</td>
                      <td>${source.shelfNumber || '-'}</td>
                      <td>${source.branch || '-'}</td>
                      <td><span class="badge badge-${Utils.getStatusColor(displayStatus)}">${displayStatus}</span></td>
                      ${actionsHtml}
                  </tr>
              `;
          }).join('');
      }

      function showDeleteBySourceModal() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه حذف المصادر.', 'danger');
              return;
          }
          document.getElementById('deleteBySourceModal').style.display = 'block';
      }

      function hideDeleteBySourceModal() {
          document.getElementById('deleteBySourceModal').style.display = 'none';
          document.getElementById('deleteSourceSelect').value = '';
          document.getElementById('deleteBulkReason').value = '';
      }

      function deleteBySource() {
          const sourceType = document.getElementById('deleteSourceSelect').value;
          const reason = document.getElementById('deleteBulkReason').value;
          
          if (!sourceType) {
              Utils.showAlert('يرجى اختيار مصدر التوريد', 'warning');
              return;
          }

          if (!reason) {
              Utils.showAlert('يرجى اختيار سبب الحذف', 'warning');
              return;
          }

          // Get sources to delete from current branch only
          const sourcesToDelete = DATA.sources.filter(source => 
              source.source === sourceType && 
              !source.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || source.branch === currentUser.branch)
          );

          if (sourcesToDelete.length === 0) {
              Utils.showAlert('لا توجد مصادر من هذا النوع في فرعك', 'info');
              return;
          }

          if (confirm(`هل أنت متأكد من حذف جميع المصادر من "${sourceType}" بسبب "${reason}"؟ (${sourcesToDelete.length} مصدر)`)) {
              let deletedCount = 0;
              let cannotDeleteCount = 0;

              sourcesToDelete.forEach(source => {
                  const activeBorrowing = DATA.borrowings.find(b => 
                      b.sourceId === source.id && !b.returned
                  );
                  
                  if (activeBorrowing) {
                      cannotDeleteCount++;
                  } else {
                      source.deleted = true;
                      source.status = 'محذوف';
                      source.deletedDate = new Date().toISOString();
                      source.deletedBy = currentUser.name;
                      source.deleteReason = reason;
                      deletedCount++;

                      // Add to deleted sources summary
                      const deletedRecord = {
                          id: Date.now() + Math.random(),
                          source: source.source,
                          copiesCount: source.copiesCount || 1,
                          deletedDate: new Date().toISOString(),
                          deletedBy: currentUser.name,
                          branch: source.branch,
                          reason: `حذف مجمع لمصدر التوريد: ${sourceType} - ${reason}`
                      };
                      DATA.deletedSources.push(deletedRecord);
                  }
              });

              Storage.save();
              hideDeleteBySourceModal();
              loadSourcesTable();
              updateDashboard();

              let message = `تم حذف ${deletedCount} مصدر بنجاح!`;
              if (cannotDeleteCount > 0) {
                  message += `\n${cannotDeleteCount} مصدر لم يتم حذفه لأنه مستعار حالياً.`;
              }
              
              Utils.showAlert(message, 'success');
          }
      }

      function deleteAllSources() {
          if (currentUser.role !== 'admin') {
              Utils.showAlert('غير مسموح! المدير فقط يمكنه حذف جميع المصادر.', 'danger');
              return;
          }

          if (confirm('هل أنت متأكد من حذف جميع المصادر؟ لا يمكن التراجع عن هذا الإجراء!')) {
              if (confirm('تأكيد نهائي: سيتم حذف جميع المصادر نهائياً!')) {
                  DATA.sources = [];
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  Utils.showAlert('تم حذف جميع المصادر بنجاح!', 'success');
              }
          }
      }

      function filterSources() {
          loadSourcesTable();
      }

      function resetSourceFilters() {
          ['sourceStatusFilter', 'sourceLibraryFilter', 'sourceSupplyFilter'].forEach(id => {
              const element = document.getElementById(id);
              if (element) element.value = 'all';
          });
          if (['admin', 'manager'].includes(currentUser.role)) {
              const branchFilter = document.getElementById('sourcesBranchFilter');
              if (branchFilter) branchFilter.value = 'all';
          }
          loadSourcesTable();
      }

   function searchSources() {
    const searchQuery = document.getElementById('sourceSearch').value.toLowerCase();
    const filteredSources = DATA.sources.filter(source => {
        return source.title.toLowerCase().includes(searchQuery) ||
               source.author.toLowerCase().includes(searchQuery);
    });
    displayFilteredSources(filteredSources);
}

      function displayFilteredSources(sources) {
          const tbody = document.getElementById('sourcesTable');
          tbody.innerHTML = sources.length === 0 ? 
              `<tr><td colspan="${currentUser.role === 'librarian' ? '16' : '17'}">لا توجد نتائج للبحث</td></tr>` :
              sources.map((source, index) => {
                  const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
                  const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
                  const actionsHtml = currentUser.role !== 'librarian' ? 
                      `<td>
                          <button class="btn btn-sm btn-warning" onclick="editSource(${source.id})">✏️</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteSource(${source.id})">🗑️</button>
                      </td>` : '';
                  
                  // Enhanced special notes highlighting and non-borrowable indication
                  const hasSpecialNotes = Utils.hasSpecialNotes(source);
                  const isNonBorrowable = NON_BORROWABLE_STATUSES.includes(source.status);
                  const rowClass = hasSpecialNotes || isNonBorrowable ? 
                      'class="not-borrowable"' : '';
                  
                  return `
                      <tr ${rowClass}>
                          <td>${index + 1}</td>
                          <td>${source.bibNumber || '-'}</td>
                          <td>${source.title}${hasSpecialNotes || isNonBorrowable ? ' <span class="notes-highlight"></span>' : ''}</td>
                          <td>${source.author}</td>
                          <td>${source.publisher || '-'}</td>
                          <td>${source.publishYear || '-'}</td>
                          <td>${source.language || '-'}</td>
                          <td>${source.deweyClassification || '-'}</td>
                          <td><span class="badge badge-secondary">${thematicClassification || '-'}</span></td>
                          <td>${source.copiesCount || 1}</td>
                          <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                          <td>${source.source || '-'}</td>
                          <td>${source.supplyDate ? Utils.formatDate(source.supplyDate) : '-'}</td>
                          <td>${source.shelfNumber || '-'}</td>
                          <td>${source.branch || '-'}</td>
                          <td><span class="badge badge-${Utils.getStatusColor(source.status)}">${source.status}</span></td>
                          ${actionsHtml}
                      </tr>
                  `;
              }).join('');
      }

      // Members Management - CRITICAL FIX: Updated for column removal and actions restoration
      function showAddMemberForm() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه إضافة الأعضاء.', 'danger');
              return;
          }
          
          document.getElementById('membershipNumberInput').value = '';
          document.getElementById('addMemberForm').style.display = 'block';
      }

      function hideAddMemberForm() {
          document.getElementById('addMemberForm').style.display = 'none';
          document.getElementById('memberForm').reset();
      }

      function addMember(event) {
          event.preventDefault();
          
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه إضافة الأعضاء.', 'danger');
              return;
          }
          
          const formData = new FormData(event.target);
          const membershipNumber = formData.get('membershipNumber').trim();
          const password = formData.get('userPassword');
          const fullName = formData.get('fullName').trim();
          const memberType = formData.get('memberType');
          const branch = formData.get('branch');
          
          // Validate required fields
          if (!membershipNumber || !password || !fullName || !memberType || !branch) {
              Utils.showAlert('جميع الحقول المطلوبة يجب ملؤها!', 'danger');
              return;
          }

          // Branch restriction for supervisors
          if (currentUser.role === 'supervisor' && branch !== currentUser.branch) {
             Utils.showAlert('المشرف يمكنه فقط إضافة أعضاء لفرعه فقط!', 'danger');
              return;
          }
          
          // Check for existing membership number
          const existingMember = DATA.members.find(member => member.membershipNumber === membershipNumber);
          if (existingMember) {
              Utils.showAlert('رقم العضوية موجود مسبقاً! اختر رقم عضوية آخر.', 'danger');
              return;
          }
          
          // Check for existing predefined account
          if (USER_ACCOUNTS[membershipNumber]) {
              Utils.showAlert('رقم العضوية محجوز للنظام! اختر رقم عضوية آخر.', 'danger');
              return;
          }
          
          // Validate password strength
          if (password.length < 4) {
              Utils.showAlert('كلمة المرور يجب أن تكون 4 أحرف على الأقل!', 'danger');
              return;
          }
          
          const member = {
              id: Date.now(),
              membershipNumber,
              password,
              fullName,
              memberType,
              branch,
              joinDate: new Date().toISOString(),
              borrowedSources: 0
          };
          
          DATA.members.push(member);
          Storage.save();
          
          loadMembersTable();
          hideAddMemberForm();
          updateDashboard();
          
          Utils.showAlert(`تم إضافة العضو بنجاح!\nرقم العضوية: ${membershipNumber}`, 'success');
      }

      // CRITICAL FIX: Updated loadMembersTable - removed columns and added actions
      function loadMembersTable() {
    const tbody = document.getElementById('membersTable');
    tbody.innerHTML = '';
    
    const branchFilter = ['admin', 'manager'].includes(currentUser.role) ? 
        document.getElementById('membersBranchFilter')?.value : null;
    const filteredMembers = DataFilter.getFilteredMembers({ branch: branchFilter });
    
    if (filteredMembers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">لا يوجد أعضاء مسجلين بعد</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredMembers.map(member => {
        // Show actions for all members (except predefined for non-admin)
        const showActions = ['admin', 'supervisor'].includes(currentUser.role) && 
                           (!member.isPredefined || currentUser.role === 'admin');
        
        const actionsHtml = showActions ? 
            `<td>
                <button class="btn btn-sm btn-warning" onclick="editMember(${member.id})">✏️</button>
                <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id})">🗑️</button>
            </td>` : 
            '<td>-</td>';
        
        const memberTypeDisplay = member.isPredefined ? 
            `${member.memberType} <span class=""></span>` : 
            member.memberType;
        
        return `
            <tr ${member.isPredefined ? 'style="background-color: #f0f9ff;"' : ''}>
                <td>${member.membershipNumber}</td>
                <td>${member.fullName}</td>
                <td>${memberTypeDisplay}</td>
                <td>${member.branch}</td>
                ${actionsHtml}
            </tr>
        `;
    }).join('');
}

      function filterMembers() {
          loadMembersTable();
      }

      // CRITICAL FIX: Updated searchMembers - removed ID number from search
      function searchMembers() {
          const query = document.getElementById('memberSearch').value.toLowerCase();
          const filtered = DataFilter.getFilteredMembers({}).filter(member => 
              member.fullName.toLowerCase().includes(query) ||
              member.membershipNumber.toLowerCase().includes(query)
          );
          
          const tbody = document.getElementById('membersTable');
          tbody.innerHTML = filtered.length === 0 ? 
              '<tr><td colspan="5">لا توجد نتائج للبحث</td></tr>' :
              filtered.map(member => {
                  const actionsHtml = ['admin', 'supervisor'].includes(currentUser.role) && !member.isPredefined ? 
                      `<td>
                          <button class="btn btn-sm btn-warning" onclick="editMember(${member.id})">✏️</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id})">🗑️</button>
                      </td>` : 
                      '<td>-</td>';
                  
                  const memberTypeDisplay = member.isPredefined ? 
                      `${member.memberType} <span class=""></span>` : 
                      member.memberType;
                  
                  return `
                      <tr ${member.isPredefined ? 'style="background-color: #f0f9ff;"' : ''}>
                          <td>${member.membershipNumber}</td>
                          <td>${member.fullName}</td>
                          <td>${memberTypeDisplay}</td>
                          <td>${member.branch}</td>
                          ${actionsHtml}
                      </tr>
                  `;
              }).join('');
      }

      // CRITICAL FIX: Updated Circulation System to prevent borrowing non-borrowable sources
      function loadMemberInfo() {
          const input = document.getElementById('memberBarcode').value;
          const memberInfo = document.getElementById('memberInfo');
          
          if (!input) {
              memberInfo.innerHTML = '';
              return;
          }
          
          // Check predefined accounts first
          const predefinedAccount = USER_ACCOUNTS[input];
          if (predefinedAccount) {
              const borrowedCount = DATA.borrowings.filter(b => 
                  b.membershipNumber === input && 
                  !b.returned &&
                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
              ).length;
              
              memberInfo.innerHTML = `
                  <div class="alert alert-success">
                      <strong>${predefinedAccount.name}</strong><br>
                      رقم العضوية: ${input}<br>
                      نوع العضوية: ${predefinedAccount.role === 'admin' ? 'مدير النظام' : predefinedAccount.role === 'supervisor' ? 'مشرف فرع' : predefinedAccount.role === 'manager' ? 'مدير عام' : 'أمين مكتبة'}<br>
                      الفرع: ${predefinedAccount.branch}<br>
                      المصادر المستعارة: ${borrowedCount}
                  </div>
              `;
              checkCirculationButtons();
              return;
          }
          
          // Check custom members
          const member = DATA.members.find(m => 
              m.membershipNumber === input || 
              m.id.toString() === input
          );
          
          if (member) {
              const borrowedCount = DATA.borrowings.filter(b => 
                  b.membershipNumber === member.membershipNumber && 
                  !b.returned &&
                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
              ).length;
              
              memberInfo.innerHTML = `
                  <div class="alert alert-success">
                      <strong>${member.fullName}</strong><br>
                      رقم العضوية: ${member.membershipNumber}<br>
                      نوع العضوية: ${member.memberType}<br>
                      الفرع: ${member.branch}<br>
                      المصادر المستعارة: ${borrowedCount}
                  </div>
              `;
              checkCirculationButtons();
          } else {
              memberInfo.innerHTML = '<div class="alert alert-danger">العضو غير موجود!</div>';
          }
      }

      function loadSourceInfo() {
          const input = document.getElementById('sourceBarcode').value;
          const sourceInfo = document.getElementById('sourceInfo');
          
          if (!input) {
              sourceInfo.innerHTML = '';
              return;
          }
          
          // Find source - restrict to current branch for non-admin/manager users
          const source = DATA.sources.find(s => 
              (s.bibNumber === input || s.id.toString() === input) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (source) {
              const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
              const availableCopies = source.copiesCount - DATA.borrowings.filter(b => 
                  b.sourceId === source.id && !b.returned
              ).length;
              
              // CRITICAL FIX: Check if source is borrowable
              const isBorrowable = Utils.isBorrowable(source);
              const borrowableText = isBorrowable ? 'قابل للإعارة' : 'غير قابل للإعارة';
              const alertType = isBorrowable && availableCopies > 0 ? 'success' : 'warning';
              
              sourceInfo.innerHTML = `
                  <div class="alert alert-${alertType}">
                      <strong>${source.title}</strong><br>
                      المؤلف: ${source.author}<br>
                      رقم BIB: ${source.bibNumber}<br>
                      المكتبة: <span class="library-type ${libraryType.class}">${libraryType.name}</span><br>
                      النسخ المتاحة: ${availableCopies} من ${source.copiesCount}<br>
                      الفرع: ${source.branch}<br>
                      الحالة: ${source.status}<br>
                      <strong style="color: ${isBorrowable ? 'green' : 'red'};">${borrowableText}</strong>
                      ${!isBorrowable ? '<br><small>هذا المصدر لا يمكن إعارته بسبب حالته الخاصة</small>' : ''}
                  </div>
              `;
              checkCirculationButtons();
          } else {
              sourceInfo.innerHTML = '<div class="alert alert-danger">المصدر غير موجود أو محذوف أو غير متاح في فرعك!</div>';
          }
      }

      function checkCirculationButtons() {
          const memberInput = document.getElementById('memberBarcode').value;
          const sourceInput = document.getElementById('sourceBarcode').value;
          const borrowBtn = document.getElementById('borrowBtn');
          const returnBtn = document.getElementById('returnBtn');
          
          // Find member
          const predefinedAccount = USER_ACCOUNTS[memberInput];
          const member = predefinedAccount || DATA.members.find(m => 
              m.membershipNumber === memberInput || 
              m.id.toString() === memberInput
          );
          
          // Find source - restrict to current branch
          const source = DATA.sources.find(s => 
              (s.bibNumber === sourceInput || s.id.toString() === sourceInput) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (member && source) {
              const availableCopies = source.copiesCount - DATA.borrowings.filter(b => 
                  b.sourceId === source.id && !b.returned
              ).length;
              
              const memberBorrowedThis = DATA.borrowings.find(b => 
                  b.membershipNumber === (member.membershipNumber || memberInput) && 
                  b.sourceId === source.id && 
                  !b.returned
              );
              
              // CRITICAL FIX: Check if source is borrowable
              const isBorrowable = Utils.isBorrowable(source);
              
              if (memberBorrowedThis) {
                  borrowBtn.disabled = true;
                  returnBtn.disabled = false;
              } else if (availableCopies > 0 && isBorrowable) {
                  borrowBtn.disabled = false;
                  returnBtn.disabled = true;
              } else {
                  borrowBtn.disabled = true;
                  returnBtn.disabled = true;
              }
          } else {
              borrowBtn.disabled = true;
              returnBtn.disabled = true;
          }
      }

      function borrowSource() {
          const memberInput = document.getElementById('memberBarcode').value;
          const sourceInput = document.getElementById('sourceBarcode').value;
          
          // Find member
          const predefinedAccount = USER_ACCOUNTS[memberInput];
          const member = predefinedAccount || DATA.members.find(m => 
              m.membershipNumber === memberInput || 
              m.id.toString() === memberInput
          );
          
          // Find source - restrict to current branch
          const source = DATA.sources.find(s => 
              (s.bibNumber === sourceInput || s.id.toString() === sourceInput) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (!member || !source) {
              Utils.showAlert('بيانات غير صحيحة أو المصدر غير متاح في فرعك!', 'danger');
              return;
          }
          
          // Additional branch permission check
          if (!['admin', 'manager'].includes(currentUser.role) && source.branch !== currentUser.branch) {
              Utils.showAlert('لا يمكن إعارة مصدر من فرع آخر!', 'warning');
              return;
          }
          
          // CRITICAL FIX: Check if source is borrowable
          if (!Utils.isBorrowable(source)) {
              Utils.showAlert('هذا المصدر غير قابل للإعارة بسبب حالته الخاصة!', 'warning');
              return;
          }
          
          // Check available copies
          const currentBorrowings = DATA.borrowings.filter(b => 
              b.sourceId === source.id && !b.returned
          ).length;
          
          if (currentBorrowings >= source.copiesCount) {
              Utils.showAlert('جميع نسخ هذا المصدر مستعارة!', 'warning');
              return;
          }
          
          // CRITICAL FIX: For sources with two copies, only one can be borrowed at a time (for special sources)
          if (Utils.hasSpecialNotes(source) && source.copiesCount > 1 && currentBorrowings >= 1) {
              Utils.showAlert('هذا المصدر له ملاحظات خاصة - يُسمح بإعارة نسخة واحدة فقط في المرة الواحدة!', 'warning');
              return;
          }
          
          // Check if member already borrowed this source
          const membershipNumber = member.membershipNumber || memberInput;
          const existingBorrowing = DATA.borrowings.find(b => 
              b.membershipNumber === membershipNumber && 
              b.sourceId === source.id && 
              !b.returned
          );
          
          if (existingBorrowing) {
              Utils.showAlert('العضو استعار هذا المصدر مسبقاً!', 'warning');
              return;
          }
          
          const borrowDate = new Date();
          const dueDate = Utils.getEndOfDay(borrowDate);
          
          const borrowing = {
              id: Date.now(),
              membershipNumber,
              sourceId: source.id,
              borrowDate: borrowDate.toISOString(),
              dueDate: dueDate.toISOString(),
              returned: false,
              employeeName: currentUser.name,
              branch: ['admin', 'manager'].includes(currentUser.role) ? source.branch : currentUser.branch
          };
          
          DATA.borrowings.push(borrowing);
          
          // Update source status if all copies are borrowed
          if (currentBorrowings + 1 >= source.copiesCount) {
              source.status = 'مستعار';
          }
          
          Storage.save();
          
          const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
          
          document.getElementById('circulationResult').innerHTML = `
              <div class="alert alert-success">
                  <h4>تمت الإعارة بنجاح!</h4>
                  <p><strong>العضو:</strong> ${member.fullName || member.name}</p>
                  <p><strong>المصدر:</strong> ${source.title}</p>
                  <p><strong>المكتبة:</strong> <span class="library-type ${libraryType.class}">${libraryType.name}</span></p>
                  <p><strong>تاريخ الإعارة:</strong> ${Utils.formatDate(borrowDate.toISOString())}</p>
                  <p><strong>تاريخ الإرجاع المطلوب:</strong> ${Utils.formatDate(dueDate.toISOString())} - 11:59 مساءً</p>
                  <p><strong>مدة الإعارة:</strong> حتى نهاية نفس اليوم</p>
                  <p><strong>الموظف المسؤول:</strong> ${currentUser.name}</p>
                  <p><strong>الفرع:</strong> ${borrowing.branch}</p>
              </div>
          `;
          
          clearCirculation();
          loadActiveBorrowings();
          updateDashboard();
      }

      function returnSource() {
          const memberInput = document.getElementById('memberBarcode').value;
          const sourceInput = document.getElementById('sourceBarcode').value;
          
          // Find member
          const predefinedAccount = USER_ACCOUNTS[memberInput];
          const member = predefinedAccount || DATA.members.find(m => 
              m.membershipNumber === memberInput || 
              m.id.toString() === memberInput
          );
          
          // Find source - restrict to current branch
          const source = DATA.sources.find(s => 
              (s.bibNumber === sourceInput || s.id.toString() === sourceInput) &&
              !s.deleted &&
              (['admin', 'manager'].includes(currentUser.role) || s.branch === currentUser.branch)
          );
          
          if (!member || !source) {
              Utils.showAlert('بيانات غير صحيحة أو المصدر غير متاح في فرعك!', 'danger');
              return;
          }
          
          const membershipNumber = member.membershipNumber || memberInput;
          const borrowing = DATA.borrowings.find(b => 
              b.membershipNumber === membershipNumber && 
              b.sourceId === source.id && 
              !b.returned
          );
          
          if (!borrowing) {
              Utils.showAlert('لا توجد إعارة نشطة لهذا المصدر مع هذا العضو!', 'warning');
              return;
          }
          
          borrowing.returned = true;
          borrowing.returnDate = new Date().toISOString();
          borrowing.returnEmployeeName = currentUser.name;
          
          // Check if we should make source available again
          const remainingBorrowings = DATA.borrowings.filter(b => 
              b.sourceId === source.id && !b.returned
          ).length;
          
          if (remainingBorrowings === 0 && Utils.isBorrowable(source)) {
              source.status = 'متاح';
          }
          
          Storage.save();
          
          const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
          const dueDate = new Date(borrowing.dueDate);
          const returnDate = new Date(borrowing.returnDate);
          const isLate = returnDate > dueDate;
          
          document.getElementById('circulationResult').innerHTML = `
              <div class="alert alert-success">
                  <h4>تم الإرجاع بنجاح!</h4>
                  <p><strong>العضو:</strong> ${member.fullName || member.name}</p>
                  <p><strong>المصدر:</strong> ${source.title}</p>
                  <p><strong>المكتبة:</strong> <span class="library-type ${libraryType.class}">${libraryType.name}</span></p>
                  <p><strong>تاريخ الإرجاع:</strong> ${Utils.formatDate(borrowing.returnDate)} - ${returnDate.toLocaleTimeString('ar')}</p>
                  <p><strong>حالة الإرجاع:</strong> <span class="badge ${isLate ? 'badge-warning' : 'badge-success'}">${isLate ? 'متأخر' : 'في الوقت المحدد'}</span></p>
                  <p><strong>موظف الإرجاع:</strong> ${currentUser.name}</p>
              </div>
          `;
          
          clearCirculation();
          loadActiveBorrowings();
          updateDashboard();
      }

      function clearCirculation() {
          document.getElementById('sourceBarcode').value = '';
          document.getElementById('memberInfo').innerHTML = '';
          document.getElementById('sourceInfo').innerHTML = '';
          document.getElementById('borrowBtn').disabled = true;
          document.getElementById('returnBtn').disabled = true;
          
          // Keep member info if membership ID is set
          const memberBarcodeInput = document.getElementById('memberBarcode');
          if (memberBarcodeInput.value) {
              setTimeout(() => {
                  loadMemberInfo();
              }, 100);
          }
      }

      function loadActiveBorrowings() {
          const tbody = document.getElementById('activeBorrowings');
          const active = DataFilter.getFilteredBorrowings({}).filter(b => !b.returned);
          
          if (active.length === 0) {
              tbody.innerHTML = '<tr><td colspan="9">لا توجد إعارات نشطة</td></tr>';
              return;
          }
          
          tbody.innerHTML = active.map(borrowing => {
              const member = DATA.members.find(m => m.membershipNumber === borrowing.membershipNumber) ||
                            USER_ACCOUNTS[borrowing.membershipNumber];
              const source = DATA.sources.find(s => s.id === borrowing.sourceId);
              const dueDate = new Date(borrowing.dueDate);
              const now = new Date();
              const hoursLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60));
              const libraryType = source ? Utils.getLibraryTypeFromBib(source.bibNumber) : { name: 'غير محدد', class: 'library-unknown' };
              
              return `
                  <tr>
                      <td>${member ? (member.fullName || member.name) : 'غير محدد'}</td>
                      <td>${source ? source.title : 'غير محدد'}</td>
                      <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                      <td>${Utils.formatDate(borrowing.borrowDate)}</td>
                      <td>${Utils.formatDate(borrowing.dueDate)}</td>
                      <td><span class="badge badge-${hoursLeft < 0 ? 'danger' : hoursLeft <= 6 ? 'warning' : 'success'}">
                          ${hoursLeft < 0 ? `متأخر ${Math.abs(hoursLeft)} ساعة` : `${hoursLeft} ساعة`}
                      </span></td>
                      <td>${borrowing.employeeName || 'غير محدد'}</td>
                      <td>${borrowing.branch || 'غير محدد'}</td>
                      <td>
                          <button class="btn btn-sm btn-warning" onclick="renewBorrowing(${borrowing.id})">تجديد</button>
                          <button class="btn btn-sm btn-success" onclick="quickReturn(${borrowing.id})">إرجاع</button>
                      </td>
                  </tr>
              `;
          }).join('');
      }

      // Advanced Search - Updated for Dewey classification
      function performAdvancedSearch() {
          const searchCriteria = {
              title: document.getElementById('searchTitle').value.toLowerCase(),
              author: document.getElementById('searchAuthor').value.toLowerCase(),
              bib: document.getElementById('searchBib').value.toLowerCase(),
              dewey: document.getElementById('searchDewey').value.toLowerCase(),
              yearFrom: document.getElementById('searchYearFrom').value,
              yearTo: document.getElementById('searchYearTo').value,
              library: document.getElementById('searchLibrary').value,
              status: document.getElementById('searchStatus').value
          };
          
          const results = DataFilter.getFilteredSources({}).filter(source => {
              let matches = true;
              
              if (searchCriteria.title && !source.title.toLowerCase().includes(searchCriteria.title)) matches = false;
              if (searchCriteria.author && !source.author.toLowerCase().includes(searchCriteria.author)) matches = false;
              if (searchCriteria.bib && !source.bibNumber.toLowerCase().includes(searchCriteria.bib)) matches = false;
if (searchCriteria.dewey && !source.deweyClassification.toLowerCase().includes(searchCriteria.dewey)) matches = false;
              if (searchCriteria.yearFrom && source.publishYear < searchCriteria.yearFrom) matches = false;
              if (searchCriteria.yearTo && source.publishYear > searchCriteria.yearTo) matches = false;
              if (searchCriteria.library && source.library !== searchCriteria.library) matches = false;
              if (searchCriteria.status && source.status !== searchCriteria.status) matches = false;
              
              return matches;
          });
          
          displaySearchResults(results);
      }

      function displaySearchResults(results) {
          const table = document.getElementById('searchResults');
          const tbody = document.getElementById('searchResultsBody');
          
          tbody.innerHTML = results.length === 0 ? 
              '<tr><td colspan="9">لا توجد نتائج للبحث</td></tr>' :
              results.map(source => {
                  const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
                  const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
                  
                  return `
                      <tr>
                          <td>${source.bibNumber || '-'}</td>
                          <td>${source.title}</td>
                          <td>${source.author}</td>
                          <td><span class="library-type ${libraryType.class}">${libraryType.name}</span></td>
                          <td>${source.publishYear || '-'}</td>
                          <td><span class="badge badge-${Utils.getStatusColor(source.status)}">${source.status}</span></td>
                          <td><span class="badge badge-secondary">${thematicClassification || '-'}</span></td>
                          <td>${source.location || '-'}</td>
                          <td>${source.branch || '-'}</td>
                      </tr>
                  `;
              }).join('');
          
          table.style.display = 'table';
      }

      function clearSearch() {
          ['searchTitle', 'searchAuthor', 'searchBib', 'searchDewey', 'searchYearFrom', 'searchYearTo', 'searchLibrary', 'searchStatus']
              .forEach(id => document.getElementById(id).value = '');
          document.getElementById('searchResults').style.display = 'none';
      }

      function generateReadingReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        Utils.showAlert('يرجى تحديد فترة التقرير', 'warning');
        return;
    }

    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);

    // Get borrowings that were RETURNED within the date range to count them as "read"
    const returnedBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
        if (!b.returned || !b.returnDate) return false;
        const returnDate = new Date(b.returnDate);
        return returnDate >= start && returnDate <= end;
    });

    if (returnedBorrowings.length === 0) {
        showReport('تقرير المصادر المقروءة', '<div class="alert alert-info">لا توجد مصادر تم إرجاعها (مقروءة) في الفترة المحددة.</div>');
        currentReportData = [];
        currentReportType = 'تقرير_المصادر_المقروءة';
        return;
    }
    
    const readingStats = {};
    returnedBorrowings.forEach(borrowing => {
        const source = DATA.sources.find(s => s.id === borrowing.sourceId);
        if (!source) return;
        
        const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
        const ageGroup = libraryType.type === 'child' ? 'أطفال' : 
                         libraryType.type === 'youth' ? 'يافعين' : 'عام';

        if (!readingStats[source.id]) {
            readingStats[source.id] = {
                title: source.title,
                author: source.author,
                bibNumber: source.bibNumber,
                branch: source.branch,
                library: libraryType.name,
                ageGroup: ageGroup, // Add age group here
                readCount: 0,
            };
        }
        readingStats[source.id].readCount++;
    });

    const sortedStats = Object.values(readingStats).sort((a, b) => b.readCount - a.readCount);
    const mostReadSource = sortedStats[0];

    let content = `
        <h4>📖 تقرير المصادر المقروءة</h4>
        <div class="alert alert-info">
            <strong>الفترة:</strong> من ${Utils.formatDate(startDate)} إلى ${Utils.formatDate(endDate)}<br>
            <strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}<br>
            <strong>إجمالي عمليات القراءة (الإرجاع):</strong> ${returnedBorrowings.length} عملية<br>
            <strong>إجمالي المصادر المقروءة:</strong> ${sortedStats.length} مصدر<br>
            ${mostReadSource ? `<strong>أكثر المصادر قراءة:</strong> "${mostReadSource.title}" (${mostReadSource.readCount} مرة)` : ''}
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>الترتيب</th>
                        <th>عنوان المصدر</th>
                        <th>المؤلف</th>
                        <th>عدد مرات القراءة</th>
                        <th>الفئة العمرية</th>
                        <th>الفرع</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedStats.map((stat, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${stat.title}</td>
                            <td>${stat.author}</td>
                            <td><span class="badge badge-primary">${stat.readCount}</span></td>
                            <td>${stat.ageGroup}</td>
                            <td>${stat.branch}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>

        <h5 style="margin-top: 2rem;">📈 تحليل إضافي للقراءة:</h5>
        <div class="stats-grid" style="margin-top: 1rem;">
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.readCount >= 3).length}</div>
                <div class="stat-label">مصادر قُرئت 3 مرات أو أكثر</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.ageGroup === 'أطفال').reduce((acc, s) => acc + s.readCount, 0)}</div>
                <div class="stat-label">إجمالي قراءات الأطفال</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.ageGroup === 'يافعين').reduce((acc, s) => acc + s.readCount, 0)}</div>
                <div class="stat-label">إجمالي قراءات اليافعين</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${sortedStats.filter(s => s.ageGroup === 'عام').reduce((acc, s) => acc + s.readCount, 0)}</div>
                <div class="stat-label">إجمالي القراءات العامة</div>
            </div>
        </div>
    `;

    showReport('تقرير المصادر المقروءة', content);

    currentReportData = sortedStats.map((stat, index) => ({
        'الترتيب': index + 1,
        'عنوان المصدر': stat.title,
        'المؤلف': stat.author,
        'عدد مرات القراءة': stat.readCount,
        'الفئة العمرية': stat.ageGroup,
        'الفرع': stat.branch
    }));
    currentReportType = 'تقرير_المصادر_المقروءة';
}

      // Updated Report Functions
      function generateDailyReport() {
          const today = new Date();
          const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
          
          const todayBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
              const borrowDate = new Date(b.borrowDate);
              return borrowDate >= startOfDay && borrowDate <= endOfDay;
          });
          
          const todayReturns = DataFilter.getFilteredBorrowings({}).filter(b => {
              if (!b.returnDate) return false;
              const returnDate = new Date(b.returnDate);
              return returnDate >= startOfDay && returnDate <= endOfDay;
          });
          
          const content = `
              <h4>التقرير اليومي - ${Utils.formatDate(today.toISOString())}</h4>
              <p><strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}</p>
              <p><strong>إجمالي الإعارات اليوم:</strong> ${todayBorrowings.length}</p>
              <p><strong>إجمالي الإرجاعات اليوم:</strong> ${todayReturns.length}</p>
              
              <h5>تفاصيل الإعارات اليوم:</h5>
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>العضو</th>
                              <th>المصدر</th>
                              <th>وقت الإعارة</th>
                              <th>الموظف المسؤول</th>
                              <th>الفرع</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${todayBorrowings.length === 0 ? 
                              '<tr><td colspan="5">لا توجد إعارات اليوم</td></tr>' :
                              todayBorrowings.map(b => {
                                  const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) ||
                                                USER_ACCOUNTS[b.membershipNumber];
                                  const source = DATA.sources.find(s => s.id === b.sourceId);
                                  return `
                                      <tr>
                                          <td>${member ? (member.fullName || member.name) : 'غير محدد'}</td>
                                          <td>${source ? source.title : 'غير محدد'}</td>
                                          <td>${new Date(b.borrowDate).toLocaleTimeString('ar')}</td>
                                          <td>${b.employeeName || 'غير محدد'}</td>
                                          <td>${b.branch || 'غير محدد'}</td>
                                      </tr>
                                  `;
                              }).join('')
                          }
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('التقرير اليومي', content);
          
          // Store for export
          currentReportData = todayBorrowings.map(b => {
              const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) ||
                            USER_ACCOUNTS[b.membershipNumber];
              const source = DATA.sources.find(s => s.id === b.sourceId);
              return {
                  'العضو': member ? (member.fullName || member.name) : 'غير محدد',
                  'المصدر': source ? source.title : 'غير محدد',
                  'وقت الإعارة': new Date(b.borrowDate).toLocaleString('ar'),
                  'الموظف المسؤول': b.employeeName || 'غير محدد',
                  'الفرع': b.branch || 'غير محدد'
              };
          });
          currentReportType = 'التقرير_اليومي';
      }

      function generateWeeklyReport() {
          const today = new Date();
          const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
          
          const weekBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
              const borrowDate = new Date(b.borrowDate);
              return borrowDate >= weekAgo && borrowDate <= today;
          });
          
          const weekReturns = DataFilter.getFilteredBorrowings({}).filter(b => {
              if (!b.returnDate) return false;
              const returnDate = new Date(b.returnDate);
              return returnDate >= weekAgo && returnDate <= today;
          });
          
          const content = `
              <h4>التقرير الأسبوعي</h4>
              <p><strong>الفترة:</strong> من ${Utils.formatDate(weekAgo.toISOString())} إلى ${Utils.formatDate(today.toISOString())}</p>
              <p><strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}</p>
              <p><strong>إجمالي الإعارات:</strong> ${weekBorrowings.length}</p>
              <p><strong>إجمالي الإرجاعات:</strong> ${weekReturns.length}</p>
              
              <h5>أكثر المصادر إعارة:</h5>
              ${getMostBorrowedSources(weekBorrowings)}
          `;
          
          showReport('التقرير الأسبوعي', content);
      }

      function generateMonthlyReport() {
          const today = new Date();
          const monthAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
          
          const monthBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
              const borrowDate = new Date(b.borrowDate);
              return borrowDate >= monthAgo && borrowDate <= today;
          });
          
          const monthReturns = DataFilter.getFilteredBorrowings({}).filter(b => {
              if (!b.returnDate) return false;
              const returnDate = new Date(b.returnDate);
              return returnDate >= monthAgo && returnDate <= today;
          });
          
          const content = `
              <h4>التقرير الشهري</h4>
              <p><strong>الفترة:</strong> من ${Utils.formatDate(monthAgo.toISOString())} إلى ${Utils.formatDate(today.toISOString())}</p>
              <p><strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}</p>
              <p><strong>إجمالي الإعارات:</strong> ${monthBorrowings.length}</p>
              <p><strong>إجمالي الإرجاعات:</strong> ${monthReturns.length}</p>
              
              <h5>الإحصائيات الشهرية:</h5>
              ${getMonthlyStatistics(monthBorrowings)}
          `;
          
          showReport('التقرير الشهري', content);
      }

      function generateMembersReport() {
          if (!['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! هذا التقرير متاح للمشرف فقط.', 'danger');
              return;
          }
          
          const members = DataFilter.getFilteredMembers({});
          const content = `
              <h4>تقرير الأعضاء</h4>
              <p><strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}</p>
              <p><strong>إجمالي الأعضاء:</strong> ${members.length}</p>
              
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>رقم العضوية</th>
                              <th>الاسم</th>
                              <th>نوع العضوية</th>
                              <th>الفرع</th>
                              <th>تاريخ التسجيل</th>
                              <th>المصادر المستعارة</th>
                         <th style="border-right: 1px solid rgba(255,255,255,0.1);">الفرع</th>
    </tr>
                      </thead>
                      <tbody>
                          ${members.map(member => {
                              const borrowedCount = DATA.borrowings.filter(b => 
                                  b.membershipNumber === member.membershipNumber && 
                                  !b.returned &&
                                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
                              ).length;
                              
                              return `
                                  <tr>
                                      <td>${member.membershipNumber}</td>
                                      <td>${member.fullName}</td>
                                      <td>${member.memberType}</td>
                                      <td>${member.branch}</td>
                                      <td>${Utils.formatDate(member.joinDate)}</td>
                                      <td>${borrowedCount}</td>
                                  </tr>
                              `;
                          }).join('')}
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('تقرير الأعضاء', content);
      }

function generateBorrowingReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        Utils.showAlert('يرجى تحديد فترة التقرير أولاً', 'warning');
        return;
    }

    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999); // Ensure the end date includes the entire day

    const periodBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => {
        const borrowDate = new Date(b.borrowDate);
        return borrowDate >= start && borrowDate <= end;
    });

    const activeBorrowings = periodBorrowings.filter(b => !b.returned);
    const completedBorrowings = periodBorrowings.filter(b => b.returned);

    let content = `
        <h4>تقرير الإعارات المفصل</h4>
        <div class="alert alert-info">
            <strong>الفترة:</strong> من ${Utils.formatDate(startDate)} إلى ${Utils.formatDate(endDate)}<br>
            <strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}<br>
            <strong>إجمالي الإعارات في الفترة:</strong> ${periodBorrowings.length}<br>
            <strong>الإعارات النشطة:</strong> ${activeBorrowings.length}<br>
            <strong>الإعارات المكتملة:</strong> ${completedBorrowings.length}
        </div>

        <h5>الإعارات النشطة (${activeBorrowings.length})</h5>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>العضو</th>
                        <th>المصدر</th>
                        <th>تاريخ الإعارة</th>
                        <th>تاريخ الإرجاع المطلوب</th>
                        <th>الحالة</th>
                        <th>الفرع</th>
                    </tr>
                </thead>
                <tbody>
                    ${activeBorrowings.length === 0 ? '<tr><td colspan="6">لا توجد إعارات نشطة في هذه الفترة</td></tr>' :
                    activeBorrowings.map(b => {
                        const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) || USER_ACCOUNTS[b.membershipNumber];
                        const source = DATA.sources.find(s => s.id === b.sourceId);
                        const isOverdue = new Date(b.dueDate) < new Date();
                        return `
                            <tr>
                                <td>${member ? (member.fullName || member.name) : 'غير محدد'}</td>
                                <td>${source ? source.title : 'مصدر محذوف'}</td>
                                <td>${Utils.formatDate(b.borrowDate)}</td>
                                <td>${Utils.formatDate(b.dueDate)}</td>
                                <td><span class="badge ${isOverdue ? 'badge-danger' : 'badge-success'}">${isOverdue ? 'متأخر' : 'نشط'}</span></td>
                                <td>${b.branch || '-'}</td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>

        <h5 style="margin-top: 2rem;">الإعارات المكتملة (${completedBorrowings.length})</h5>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>العضو</th>
                        <th>المصدر</th>
                        <th>تاريخ الإعارة</th>
                        <th>تاريخ الإرجاع</th>
                        <th>الحالة</th>
                        <th>الفرع</th>
                    </tr>
                </thead>
                <tbody>
                    ${completedBorrowings.length === 0 ? '<tr><td colspan="6">لا توجد إعارات مكتملة في هذه الفترة</td></tr>' :
                    completedBorrowings.map(b => {
                        const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) || USER_ACCOUNTS[b.membershipNumber];
                        const source = DATA.sources.find(s => s.id === b.sourceId);
                        const isLate = new Date(b.returnDate) > new Date(b.dueDate);
                        return `
                            <tr>
                                <td>${member ? (member.fullName || member.name) : 'غير محدد'}</td>
                                <td>${source ? source.title : 'مصدر محذوف'}</td>
                                <td>${Utils.formatDate(b.borrowDate)}</td>
                                <td>${Utils.formatDate(b.returnDate)}</td>
                                <td><span class="badge ${isLate ? 'badge-warning' : 'badge-success'}">${isLate ? 'متأخر' : 'في الوقت'}</span></td>
                                <td>${b.branch || '-'}</td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;

    showReport('تقرير الإعارات المفصل', content);

    // Prepare data for export
    currentReportData = periodBorrowings.map(b => {
        const member = DATA.members.find(m => m.membershipNumber === b.membershipNumber) || USER_ACCOUNTS[b.membershipNumber];
        const source = DATA.sources.find(s => s.id === b.sourceId);
        return {
            'العضو': member ? (member.fullName || member.name) : 'غير محدد',
            'المصدر': source ? source.title : 'مصدر محذوف',
            'تاريخ الإعارة': Utils.formatDate(b.borrowDate),
            'الحالة': b.returned ? 'مكتمل' : 'نشط',
            'تاريخ الإرجاع': b.returnDate ? Utils.formatDate(b.returnDate) : '-',
            'الفرع': b.branch
        };
    });
    currentReportType = 'تقرير_الإعارات';
}

      function generateLibraryTypeReport() {
          const sources = DataFilter.getFilteredSources({});
          const mainSources = sources.filter(s => Utils.getLibraryTypeFromBib(s.bibNumber).type === 'main');
          const youthSources = sources.filter(s => Utils.getLibraryTypeFromBib(s.bibNumber).type === 'youth');
          const childSources = sources.filter(s => Utils.getLibraryTypeFromBib(s.bibNumber).type === 'child');
          
          const content = `
              <h4>تقرير حسب نوع المكتبة</h4>
              <p><strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}</p>
              
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${mainSources.length}</div>
                      <div class="stat-label">المكتبة الرئيسية</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${youthSources.length}</div>
                      <div class="stat-label">مكتبة اليافعين</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${childSources.length}</div>
                      <div class="stat-label">مكتبة الطفل</div>
                  </div>
              </div>
              
              <h5>تفاصيل كل مكتبة:</h5>
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>نوع المكتبة</th>
                              <th>إجمالي المصادر</th>
                              <th>المصادر المتاحة</th>
                              <th>المصادر المستعارة</th>
                              <th>المصادر التالفة</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${[
                              ['المكتبة الرئيسية', mainSources],
                              ['مكتبة اليافعين', youthSources],
                              ['مكتبة الطفل', childSources]
                          ].map(([name, sources]) => `
                              <tr>
                                  <td>${name}</td>
                                  <td>${sources.length}</td>
                                  <td>${sources.filter(s => s.status === 'متاح').length}</td>
                                  <td>${sources.filter(s => s.status === 'مستعار').length}</td>
                                  <td>${sources.filter(s => s.status === 'تالف').length}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('تقرير حسب نوع المكتبة', content);
      }

      // CRITICAL FIX: Enhanced generateStatisticsReport with complete status and Dewey categories
      function generateStatisticsReport() {
          const sources = DataFilter.getFilteredSources({});
          const members = DataFilter.getFilteredMembers({});
          const borrowings = DataFilter.getFilteredBorrowings({});
          
          let content = `
              <h4>تقرير إحصائي شامل</h4>
              <p><strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}</p>
              <p><strong>تاريخ التقرير:</strong> ${Utils.formatDate(new Date().toISOString())}</p>
              
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${sources.length}</div>
                      <div class="stat-label">إجمالي المصادر</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${members.length}</div>
                      <div class="stat-label">إجمالي الأعضاء</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${borrowings.length}</div>
                      <div class="stat-label">إجمالي الإعارات</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${borrowings.filter(b => !b.returned).length}</div>
                      <div class="stat-label">الإعارات النشطة</div>
                  </div>
              </div>
              
              <h5>توزيع المصادر حسب الحالة (محدث):</h5>
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>الحالة</th>
                              <th>العدد</th>
                              <th>النسبة المئوية</th>
                          </tr>
                      </thead>
                      <tbody>
          `;
          
          // CRITICAL FIX: Include all status categories
          const allStatuses = [
              'متاح', 'مستعار', 'تالف',
              'BIB لا يطابق العنوان', 'لا يوجد شريحة', 'المحتوى مخالف',
              'التصنيف خاطئ', 'غير صالح للإعارة', 'إصدار قديم', 'مكرر'
          ];
          
          allStatuses.forEach(status => {
              const count = sources.filter(s => s.status === status).length;
              if (count > 0) {
                  const percentage = sources.length ? ((count / sources.length) * 100).toFixed(1) : 0;
                  content += `
                      <tr>
                          <td>${status}</td>
                          <td>${count}</td>
                          <td>${percentage}%</td>
                      </tr>
                  `;
              }
          });
          
          content += `
                      </tbody>
                  </table>
              </div>
              
              ${getDeweyClassificationReport(sources)}
          `;
          
          showReport('تقرير إحصائي شامل', content);
      }

      function generateDeletedSourcesReport() {
          if (currentUser.role !== 'admin') {
              Utils.showAlert('غير مسموح! هذا التقرير متاح للمدير فقط.', 'danger');
              return;
          }
          
          const deletedSources = DATA.sources.filter(s => s.deleted);
          
          let content = `
              <h4>تقرير المصادر المحذوفة</h4>
              <p><strong>إجمالي المصادر المحذوفة:</strong> ${deletedSources.length}</p>
              
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>العنوان</th>
                              <th>المؤلف</th>
                              <th>رقم BIB</th>
                              <th>مصدر التوريد</th>
                              <th>الفرع</th>
                              <th>تاريخ الحذف</th>
                              <th>المحذوف بواسطة</th>
                              <th>سبب الحذف</th>
                          </tr>
                      </thead>
                      <tbody>
          `;
          
          if (deletedSources.length === 0) {
              content += '<tr><td colspan="8">لا توجد مصادر محذوفة</td></tr>';
          } else {
              content += deletedSources.map(source => `
                  <tr>
                      <td>${source.title}</td>
                      <td>${source.author}</td>
                      <td>${source.bibNumber}</td>
                      <td>${source.source || '-'}</td>
                      <td>${source.branch || '-'}</td>
                      <td>${source.deletedDate ? Utils.formatDate(source.deletedDate) : '-'}</td>
                      <td>${source.deletedBy || '-'}</td>
                      <td>${source.deleteReason || 'حذف يدوي'}</td>
                  </tr>
              `).join('');
          }
          
          content += `
                      </tbody>
                  </table>
              </div>
          `;
          
          showReport('تقرير المصادر المحذوفة', content);
          
          // Prepare data for export
          currentReportData = deletedSources.map(source => ({
              'العنوان': source.title,
              'المؤلف': source.author,
              'رقم BIB': source.bibNumber,
              'مصدر التوريد': source.source || '-',
              'الفرع': source.branch || '-',
              'تاريخ الحذف': source.deletedDate ? Utils.formatDate(source.deletedDate) : '-',
              'المحذوف بواسطة': source.deletedBy || '-',
              'سبب الحذف': source.deleteReason || 'حذف يدوي'
          }));
          currentReportType = 'تقرير_المصادر_المحذوفة';
      }

      function generateSourcesReport() {
          const sources = DataFilter.getFilteredSources({});
          const content = `
              <h4>تقرير المصادر الشامل</h4>
              <p><strong>الفرع:</strong> ${['admin', 'manager'].includes(currentUser.role) ? 'جميع الفروع' : currentUser.branch}</p>
              <p><strong>إجمالي المصادر:</strong> ${sources.length}</p>
              <p><strong>المصادر المتاحة:</strong> ${sources.filter(s => s.status === 'متاح').length}</p>
              <p><strong>المصادر المستعارة:</strong> ${sources.filter(s => s.status === 'مستعار').length}</p>
              <p><strong>المصادر التالفة:</strong> ${sources.filter(s => s.status === 'تالف').length}</p>
              <p><strong>المصادر التي تحتوي على ملاحظات:</strong> ${sources.filter(s => Utils.hasSpecialNotes(s)).length}</p>
              
              <h5>توزيع المصادر حسب تصنيف ديوي:</h5>
              ${getDeweyClassificationReport(sources)}
              
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr><th>اللغة</th><th>عدد المصادر</th></tr>
                      </thead>
                      <tbody>
                          ${getLanguageReport(sources)}
                      </tbody>
                  </table>
              </div>
          `;
          showReport('تقرير المصادر', content);
      }

      // Helper functions for reports
      function getMostBorrowedSources(borrowings) {
          const sourceCounts = {};
          borrowings.forEach(b => {
              const source = DATA.sources.find(s => s.id === b.sourceId);
              if (source) {
                  sourceCounts[source.title] = (sourceCounts[source.title] || 0) + 1;
              }
          });
          
          const sorted = Object.entries(sourceCounts)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 5);
          
          if (sorted.length === 0) {
              return '<p>لا توجد إعارات في هذه الفترة</p>';
          }
          
          return `
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>المصدر</th>
                              <th>عدد الإعارات</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${sorted.map(([title, count]) => `
                              <tr>
                                  <td>${title}</td>
                                  <td>${count}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              </div>
          `;
      }

      function getMonthlyStatistics(borrowings) {
          const totalBorrowings = borrowings.length;
          const uniqueMembers = [...new Set(borrowings.map(b => b.membershipNumber))].length;
          const uniqueSources = [...new Set(borrowings.map(b => b.sourceId))].length;
          
          return `
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${totalBorrowings}</div>
                      <div class="stat-label">إجمالي الإعارات</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${uniqueMembers}</div>
                      <div class="stat-label">الأعضاء النشطون</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${uniqueSources}</div>
                      <div class="stat-label">المصادر المستعارة</div>
                  </div>
              </div>
          `;
      }

      // CRITICAL FIX: Enhanced getDeweyClassificationReport with all categories
      function getDeweyClassificationReport(sources) {
          const classifications = {};
          
          // Initialize all Dewey categories
          Object.values(DEWEY_CLASSIFICATIONS).forEach(category => {
              classifications[category] = 0;
          });
          classifications['غير محدد'] = 0;
          
          sources.forEach(source => {
              if (source.deweyClassification) {
                  const category = Utils.getDeweyCategory(source.deweyClassification) || 'غير محدد';
                  classifications[category]++;
              } else {
                  classifications['غير محدد']++;
              }
          });
          
          return `
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr><th>تصنيف ديوي</th><th>عدد المصادر</th><th>النسبة المئوية</th></tr>
                      </thead>
                      <tbody>
                          ${Object.entries(classifications)
                              .map(([category, count]) => {
                                  const percentage = sources.length ? ((count / sources.length) * 100).toFixed(1) : 0;
                                  return `<tr><td>${category}</td><td>${count}</td><td>${percentage}%</td></tr>`;
                              })
                              .join('')}
                      </tbody>
                  </table>
              </div>
          `;
      }

      function getLanguageReport(sources) {
          const languages = {};
          sources.forEach(source => {
              const lang = source.language || 'غير محدد';
              languages[lang] = (languages[lang] || 0) + 1;
          });
          
          return Object.entries(languages)
              .map(([lang, count]) => `<tr><td>${lang}</td><td>${count}</td></tr>`)
              .join('');
      }

      function showReport(title, content) {
          currentReportType = title;
          document.getElementById('reportTitle').textContent = title;
          document.getElementById('reportContent').innerHTML = content;
          document.getElementById('reportResults').style.display = 'block';
      }

      // Updated Dewey Info Function
      function updateDeweyInfo(input) {
          const classification = input.value;
          const infoDiv = document.getElementById('deweyInfo');
          const thematicDiv = document.getElementById('thematicClassification');
          
          if (!classification) {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
              return;
          }

          const number = parseInt(classification);
          let categoryInfo = '';
          let thematicClassification = '';

          for (const [range, category] of Object.entries(DEWEY_CLASSIFICATIONS)) {
              const [start, end] = range.split('-').map(r => parseInt(r));
              if (number >= start && number <= end) {
                  categoryInfo = `${range}: ${category}`;
                  thematicClassification = `التصنيف الموضوعي: ${category}`;
                  break;
              }
          }

          if (categoryInfo) {
              infoDiv.textContent = categoryInfo;
              infoDiv.style.display = 'block';
              thematicDiv.textContent = thematicClassification;
              thematicDiv.style.display = 'block';
          } else {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
          }
      }

      // Enhanced Edit Dewey Info Function
      function updateEditDeweyInfo(input) {
          const classification = input.value;
          const infoDiv = document.getElementById('editDeweyInfo');
          const thematicDiv = document.getElementById('editThematicClassification');
          
          if (!classification) {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
              return;
          }

          const number = parseInt(classification);
          let categoryInfo = '';
          let thematicClassification = '';

          for (const [range, category] of Object.entries(DEWEY_CLASSIFICATIONS)) {
              const [start, end] = range.split('-').map(r => parseInt(r));
              if (number >= start && number <= end) {
                  categoryInfo = `${range}: ${category}`;
                  thematicClassification = `التصنيف الموضوعي: ${category}`;
                  break;
              }
          }

          if (categoryInfo) {
              infoDiv.textContent = categoryInfo;
              infoDiv.style.display = 'block';
              thematicDiv.textContent = thematicClassification;
              thematicDiv.style.display = 'block';
          } else {
              infoDiv.style.display = 'none';
              thematicDiv.style.display = 'none';
          }
      }

      // Import System - Updated for Dewey classification
      function showFileUploadWarning(type, input) {
          if (input.files.length > 0) {
              const confirmed = confirm(
                  '⚠️ تأكيد هام: هل تم حفظ ملف الإكسل قبل رفعه؟\n\n' +
                  'يجب حفظ الملف وإغلاقه تماماً من برنامج الإكسل قبل الرفع.\n\n' +
                  'هل تريد المتابعة؟'
              );
              
              if (confirmed) {
                  if (type === 'sources') {
                      importSources(input);
                  }
              } else {
                  input.value = '';
              }
          }
      }

      function importSources(input) {
          const file = input.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = function(e) {
              try {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, {type: 'array'});
                  const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                  const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                      header: 1,
                      defval: '',
                      raw: false
                  });
                  
                  if (jsonData.length < 2) {
                      throw new Error('الملف لا يحتوي على بيانات كافية');
                  }
                  
                  const headers = jsonData[0];
                  const sources = [];
                  
                  for (let i = 1; i < jsonData.length; i++) {
                      const row = jsonData[i];
                      if (!row || row.length === 0) continue;
                      
                      const source = {};
                      headers.forEach((header, index) => {
                          if (header && row[index] !== undefined) {
                              source[header.toString().trim()] = row[index] ? row[index].toString().trim() : '';
                          }
                      });
                      
                      if (source[headers[0]] || source[headers[1]] || source['العنوان'] || source['Title'] || source['BIB']) {
                          sources.push({data: source, rowNumber: i + 1});
                      }
                  }
                  
                  // Validation
                  let errors = [];
                  let validSources = [];
                  
                  sources.forEach((sourceEntry) => {
                      const sourceRow = sourceEntry.data;
                      const rowNumber = sourceEntry.rowNumber;
                      
                      try {
                          const bibNumber = findValue(sourceRow, ['BIB', 'bib', 'رقم BIB', 'رقم_BIB', 'Bib Number']);
                          const title = findValue(sourceRow, ['العنوان', 'Title', 'عنوان', 'المصدر', 'Source Title']);
                          
                          if (!bibNumber) {
                              return; // Skip row
                          }
                          
                          if (bibNumber.length !== 14) {
                              errors.push(`الصف ${rowNumber}: رقم BIB "${bibNumber}" يجب أن يكون 14 رقماً بالضبط`);
                              return;
                          }
                          
                          if (!title || title.trim() === '') {
                              errors.push(`الصف ${rowNumber}: العنوان مطلوب`);
                              return;
                          }
                          
                          validSources.push({
                              data: sourceRow,
                              rowNumber: rowNumber,
                              bibNumber: bibNumber,
                              title: title
                          });
                          
                      } catch (error) {
                          errors.push(`خطأ في الصف ${rowNumber}: ${error.message}`);
                      }
                  });
                  
                  if (errors.length > 0) {
                      const resultMessage = `
                          <div class="alert alert-danger">
                              <strong>❌ تم رفض الملف! يجب إصلاح الأخطاء التالية أولاً:</strong><br>
                              <div style="max-height: 250px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dc3545;">
                                  ${errors.join('<br>')}
                              </div>
                              <br><strong>⚠️ لم يتم استيراد أي مصدر. يرجى إصلاح جميع الأخطاء وإعادة رفع الملف.</strong>
                          </div>
                      `;
                      
                      document.getElementById('importResults').innerHTML = resultMessage;
                      input.value = '';
                      return;
                  }
                  
                  // Import valid sources
                  let imported = 0;
                  const userBranch = currentUser.branch === 'all' ? 'الرياض' : currentUser.branch;
                  
                  validSources.forEach((validSource) => {
                      const sourceRow = validSource.data;
                      
                      const notes = findValue(sourceRow, ['ملاحظات', 'Notes', 'ملاحظة']) || '';
                      
                      const source = {
                          id: Date.now() + Math.random(),
                          bibNumber: validSource.bibNumber,
                          title: validSource.title,
                          author: findValue(sourceRow, ['المؤلف', 'Author', 'مؤلف', 'الكاتب', 'Writer']) || '',
                          publisher: findValue(sourceRow, ['الناشر', 'Publisher', 'ناشر', 'دار النشر']) || '',
                          publishYear: findValue(sourceRow, ['تاريخ النشر', 'سنة النشر', 'Publish Year', 'Year', 'السنة']) || '',
                          language: findValue(sourceRow, ['اللغة', 'Language', 'لغة']) || 'ara',
                          deweyClassification: findValue(sourceRow, ['تصنيف ديوي', 'Dewey Classification', 'التصنيف', 'Classification']) || '',
                          copiesCount: parseInt(findValue(sourceRow, ['عدد النسخ', 'Copies Count', 'النسخ', 'Copies']) || '1'),
                          library: findValue(sourceRow, ['المكتبة', 'Library', 'مكتبة']) || getLibraryFromBib(validSource.bibNumber),
                          source: findValue(sourceRow, ['مصدر التوريد', 'Source', 'المصدر']) || 'مكتبة الرشد 1',
                          status: findValue(sourceRow, ['حالة المصدر', 'Status', 'الحالة']) || 'متاح',
                          location: findValue(sourceRow, ['الموقع', 'Location', 'موقع']) || '',
                          supplyDate: findValue(sourceRow, ['تاريخ التوريد', 'Supply Date', 'التوريد']) || '',
                          shelfNumber: findValue(sourceRow, ['رقم الرف', 'Shelf Number', 'الرف']) || '',
                          notes,
                          branch: userBranch,
                          addedDate: new Date().toISOString(),
                          deleted: false
                      };
                      
                      DATA.sources.push(source);
                      imported++;
                  });
                  
                  Storage.save();
                  loadSourcesTable();
                  updateDashboard();
                  
                  const resultMessage = `
                      <div class="alert alert-success">
                          <strong>🎉 تم الاستيراد بنجاح!</strong><br>
                          تم استيراد ${imported} مصدر بنجاح إلى فرع ${userBranch}
                      </div>
                  `;
                  
                  document.getElementById('importResults').innerHTML = resultMessage;
                  input.value = '';
                      
              } catch (error) {
                  document.getElementById('importResults').innerHTML = 
                      `<div class="alert alert-danger">
                          <strong>خطأ في استيراد الملف:</strong><br>
                          ${error.message}
                      </div>`;
              }
          };
          
          reader.readAsArrayBuffer(file);
      }

      function findValue(obj, possibleKeys) {
          for (let key of possibleKeys) {
              if (obj[key] !== undefined && obj[key] !== '') {
                  return obj[key];
              }
          }
          for (let objKey in obj) {
              for (let searchKey of possibleKeys) {
                  if (objKey.toLowerCase().includes(searchKey.toLowerCase()) || 
                      searchKey.toLowerCase().includes(objKey.toLowerCase())) {
                      if (obj[objKey] !== undefined && obj[objKey] !== '') {
                          return obj[objKey];
                      }
                  }
              }
          }
          return '';
      }

      function getLibraryFromBib(bib) {
          if (!bib) return 'المكتبة الرئيسية';
          const prefix = bib.toString().substring(0, 2);
          const types = {
              '01': 'المكتبة الرئيسية',
              '02': 'مكتبة اليافعين', 
              '03': 'مكتبة الطفل'
          };
          return types[prefix] || 'المكتبة الرئيسية';
      }

      // Settings and System Management - Updated for new borrowing period
      function loadSettings() {
          if (document.getElementById('settings').classList.contains('active')) {
              document.getElementById('libraryName').value = DATA.settings.libraryName;
              document.getElementById('borrowingPeriod').value = DATA.settings.borrowingPeriod;
              document.getElementById('maxBorrowedSources').value = DATA.settings.maxBorrowedSources;
              updateSettingsStats();
          }
      }

      function saveSettings() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه تغيير الإعدادات.', 'danger');
              return;
          }

          DATA.settings = {
              libraryName: document.getElementById('libraryName').value,
              borrowingPeriod: document.getElementById('borrowingPeriod').value,
              maxBorrowedSources: parseInt(document.getElementById('maxBorrowedSources').value)
          };
          
          Storage.save();
          Utils.showAlert('تم حفظ الإعدادات بنجاح!', 'success');
      }

      function updateSettingsStats() {
          if (document.getElementById('settings').classList.contains('active')) {
              const filteredSources = DataFilter.getFilteredSources({});
              const filteredMembers = DataFilter.getFilteredMembers({});
              const filteredBorrowings = DataFilter.getFilteredBorrowings({});
              
              document.getElementById('settingsSourceCount').textContent = filteredSources.length;
              document.getElementById('settingsMemberCount').textContent = filteredMembers.length;
              document.getElementById('settingsBorrowingCount').textContent = filteredBorrowings.filter(b => !b.returned).length;
              
              // Deleted sources for current branch
              let deletedSources;
              if (['admin', 'manager'].includes(currentUser.role)) {
                  deletedSources = DATA.sources.filter(s => s.deleted);
              } else {
                  deletedSources = DATA.sources.filter(s => s.deleted && s.branch === currentUser.branch);
              }
              document.getElementById('settingsDeletedCount').textContent = deletedSources.length;
              
              document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('en-GB');
              
              // Calculate data size
              const dataSize = JSON.stringify(DATA).length;
              document.getElementById('dataSize').textContent = `${(dataSize / 1024).toFixed(2)} كيلوبايت`;
              
              updateDeletedSourcesSummary();
          }
      }

      function updateDeletedSourcesSummary() {
          const summaryDiv = document.getElementById('deletedSourcesSummary');
          
          // Show deleted sources for current branch only (except admin/manager)
          let deletedSources;
          if (['admin', 'manager'].includes(currentUser.role)) {
              deletedSources = DATA.sources.filter(s => s.deleted);
          } else {
              deletedSources = DATA.sources.filter(s => s.deleted && s.branch === currentUser.branch);
          }
          
          if (deletedSources.length === 0) {
              summaryDiv.innerHTML = '<p style="color: #666; margin: 0;">لا توجد مصادر محذوفة</p>';
              return;
          }
          
          // Group by source
          const sourceGroups = {};
          let totalDeleted = 0;
          
          deletedSources.forEach(source => {
              const sourceType = source.source || 'غير محدد';
              if (!sourceGroups[sourceType]) {
                  sourceGroups[sourceType] = 0;
              }
              sourceGroups[sourceType] += source.copiesCount || 1;
              totalDeleted += source.copiesCount || 1;
          });
          
          let summaryHtml = `<div style="margin-bottom: 1rem;"><strong>إجمالي المصادر المحذوفة: ${totalDeleted} مصدر</strong></div>`;
          summaryHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">';
          
          Object.entries(sourceGroups).forEach(([source, count]) => {
              summaryHtml += `
                  <div style="background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid #dee2e6;">
                      <strong>${source}:</strong> ${count} مصدر
                  </div>
              `;
          });
          
          summaryHtml += '</div>';
          summaryDiv.innerHTML = summaryHtml;
      }

      function clearAllData() {
          if (currentUser.role !== 'admin') {
              Utils.showAlert('غير مسموح! المدير فقط يمكنه مسح جميع البيانات.', 'danger');
              return;
          }

          if (confirm('هل أنت متأكد من مسح جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء!')) {
              Object.keys(DATA).forEach(key => {
                  if (key === 'settings') {
                      DATA[key] = { 
                          libraryName: 'المكتبة الرئيسية', 
                          borrowingPeriod: 'end_of_day', 
                          maxBorrowedSources: 999 
                      };
                  } else {
                      DATA[key] = [];
                  }
              });
              
              Storage.save();
              updateDashboard();
              loadSourcesTable();
              if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
                  loadMembersTable();
              }
              loadActiveBorrowings();
              loadSettings();
              
              Utils.showAlert('تم مسح جميع البيانات!', 'success');
          }
      }

      // Export Functions - Updated
      function exportCurrentPageData() {
          const activeSection = document.querySelector('.page-section.active');
          if (!activeSection) {
              Utils.showAlert('لا يمكن تحديد الصفحة النشطة', 'warning');
              return;
          }
          
          const sectionId = activeSection.id;
          let sheetsData = {};
          let filterSuffix = '';
          
          switch(sectionId) {
              case 'dashboard':
                  const period = document.getElementById('activityPeriod').value || 'all';
                  const libraryType = document.getElementById('libraryTypeFilter').value || 'all';
                  filterSuffix = `لوحة_التحكم_${period}_${libraryType}`;
                  sheetsData['إحصائيات_عامة'] = createDashboardStatsSheet();
                  sheetsData['الإعارات_الحديثة'] = createRecentBorrowingsSheet();
                  break;
                  
              case 'sources':
                  filterSuffix = 'المصادر';
                  const filteredSources = DataFilter.getFilteredSources({});
                  sheetsData['المصادر'] = createSourcesSheet(filteredSources);
                  break;
                  
              case 'members':
                  if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
                      filterSuffix = 'الأعضاء';
                      sheetsData['الأعضاء'] = createMembersSheet();
                  }
                  break;
                  
              case 'circulation':
                  filterSuffix = 'الإعارات_النشطة';
                  const activeBorrowings = DataFilter.getFilteredBorrowings({}).filter(b => !b.returned);
                  sheetsData['الإعارات_النشطة'] = createBorrowingsSheet(activeBorrowings);
                  break;
                  
              case 'reports':
                  if (currentReportData && currentReportType) {
                      filterSuffix = currentReportType;
                      sheetsData[currentReportType] = currentReportData;
                  }
                  break;
                  
              default:
                  Utils.showAlert('هذه الصفحة لا تدعم التصدير', 'warning');
                  return;
          }
          
          if (Object.keys(sheetsData).length === 0) {
              Utils.showAlert('لا توجد بيانات للتصدير من هذه الصفحة', 'warning');
              return;
          }
          
          const wb = XLSX.utils.book_new();
          
          Object.entries(sheetsData).forEach(([sheetName, data]) => {
              if (data && data.length > 0) {
                  const ws = XLSX.utils.json_to_sheet(data);
                  XLSX.utils.book_append_sheet(wb, ws, sheetName);
              }
          });
          
          const currentDate = new Date().toISOString().split('T')[0];
          const branchSuffix = ['admin', 'manager'].includes(currentUser.role) ? 'جميع_الفروع' : currentUser.branch;
          const filename = `تصدير_${filterSuffix}_${branchSuffix}_${currentDate}.xlsx`;
          XLSX.writeFile(wb, filename);
          
          Utils.showAlert('تم تصدير البيانات بنجاح!', 'success');
      }

      function exportCompleteBackup() {
          if (!['admin', 'supervisor'].includes(currentUser.role)) {
              Utils.showAlert('غير مسموح! المشرف فقط يمكنه تصدير النسخة الاحتياطية.', 'danger');
              return;
          }
          
          const wb = XLSX.utils.book_new();
          
          // Export filtered data based on user role
          const filteredSources = DataFilter.getFilteredSources({});
          const filteredMembers = DataFilter.getFilteredMembers({});
          const filteredBorrowings = DataFilter.getFilteredBorrowings({});
          
          if (filteredSources.length > 0) {
              const sourcesSheet = createSourcesSheet(filteredSources);
              const sourcesWs = XLSX.utils.json_to_sheet(sourcesSheet);
              XLSX.utils.book_append_sheet(wb, sourcesWs, 'المصادر');
          }
          
          if (filteredMembers.length > 0) {
              const membersSheet = createMembersSheet();
              const membersWs = XLSX.utils.json_to_sheet(membersSheet);
              XLSX.utils.book_append_sheet(wb, membersWs, 'الأعضاء');
          }
          
          if (filteredBorrowings.length > 0) {
              const borrowingsSheet = createBorrowingsSheet(filteredBorrowings);
              const borrowingsWs = XLSX.utils.json_to_sheet(borrowingsSheet);
              XLSX.utils.book_append_sheet(wb, borrowingsWs, 'الإعارات');
          }
          
          const currentDate = new Date().toISOString().split('T')[0];
          const branchSuffix = ['admin', 'manager'].includes(currentUser.role) ? 'جميع_الفروع' : currentUser.branch;
          const filename = `نسخة_احتياطية_${branchSuffix}_${currentDate}.xlsx`;
          XLSX.writeFile(wb, filename);
          
          Utils.showAlert('تم تصدير النسخة الاحتياطية بنجاح!', 'success');
      }

      // Helper functions for creating export sheets
      function createSourcesSheet(sources) {
          return sources.map((source, index) => {
              const libraryType = Utils.getLibraryTypeFromBib(source.bibNumber);
const thematicClassification = Utils.getDeweyCategory(source.deweyClassification);
              return {
                  'الرقم': index + 1,
                  'رقم BIB': source.bibNumber,
                  'العنوان': source.title,
                  'المؤلف': source.author,
                  'الناشر': source.publisher || '',
                  'تاريخ النشر': source.publishYear || '',
                  'اللغة': source.language || '',
                  'تصنيف ديوي': source.deweyClassification || '',
                  'التصنيف الموضوعي': thematicClassification || '',
                  'عدد النسخ': source.copiesCount || 1,
                  'المكتبة': libraryType.name,
                  'مصدر التوريد': source.source || '',
                  'تاريخ التوريد': source.supplyDate ? Utils.formatDate(source.supplyDate) : '',
                  'رقم الرف': source.shelfNumber || '',
                  'الفرع': source.branch || '',
                  'حالة المصدر': source.deleted ? 'محذوف' : source.status,
                  'الموقع': source.location || '',
                  'ملاحظات': source.notes || '',
                  'تاريخ الإضافة': Utils.formatDate(source.addedDate)
              };
          });
      }

      function createMembersSheet() {
          return DataFilter.getFilteredMembers({}).map(member => {
              const borrowedCount = DATA.borrowings.filter(b => 
                  b.membershipNumber === member.membershipNumber && 
                  !b.returned &&
                  (['admin', 'manager'].includes(currentUser.role) || b.branch === currentUser.branch)
              ).length;
              
              return {
                  'رقم العضوية': member.membershipNumber,
                  'الاسم الكامل': member.fullName,
                  'نوع العضوية': member.memberType,
                  'الفرع': member.branch,
                  'تاريخ التسجيل': Utils.formatDate(member.joinDate),
                  'المصادر المستعارة حالياً': borrowedCount
              };
          });
      }

      function createBorrowingsSheet(borrowings) {
          return borrowings.map(borrowing => {
              const member = DATA.members.find(m => m.membershipNumber === borrowing.membershipNumber) ||
                            USER_ACCOUNTS[borrowing.membershipNumber];
              const source = DATA.sources.find(s => s.id === borrowing.sourceId);
              const libraryType = source ? Utils.getLibraryTypeFromBib(source.bibNumber) : { name: 'غير محدد' };
              
              return {
                  'العضو': member ? (member.fullName || member.name) : 'غير محدد',
                  'رقم العضوية': borrowing.membershipNumber,
                  'المصدر': source ? source.title : 'غير محدد',
                  'رقم BIB': source ? source.bibNumber : 'غير محدد',
                  'نوع المكتبة': libraryType.name,
                  'تاريخ الإعارة': Utils.formatDate(borrowing.borrowDate),
                  'تاريخ الإرجاع المطلوب': Utils.formatDate(borrowing.dueDate),
                  'تم الإرجاع': borrowing.returned ? 'نعم' : 'لا',
                  'تاريخ الإرجاع الفعلي': borrowing.returnDate ? Utils.formatDate(borrowing.returnDate) : '-',
                  'الموظف المسؤول': borrowing.employeeName || 'غير محدد',
                  'موظف الإرجاع': borrowing.returnEmployeeName || '-',
                  'الفرع': borrowing.branch || 'غير محدد'
              };
          });
      }

      function createDashboardStatsSheet() {
          return [{
              'الإحصائية': 'إجمالي المصادر',
              'القيمة': DataFilter.getFilteredSources({}).length
          }, {
              'الإحصائية': 'إجمالي الأعضاء',
              'القيمة': DataFilter.getFilteredMembers({}).length
          }, {
              'الإحصائية': 'الإعارات النشطة',
              'القيمة': DataFilter.getFilteredBorrowings({}).filter(b => !b.returned).length
          }];
      }

      function createRecentBorrowingsSheet() {
          const recent = DataFilter.getFilteredBorrowings({})
              .filter(b => !b.returned)
              .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
              .slice(0, 10);
          
          return createBorrowingsSheet(recent);
      }

      // Navigation and UI Management
      function showSection(sectionId) {
          document.querySelectorAll('.page-section').forEach(section => {
              section.classList.remove('active');
          });
          
          document.querySelectorAll('.menu-item').forEach(item => {
              item.classList.remove('active');
          });
          
          document.getElementById(sectionId).classList.add('active');
          event.target.classList.add('active');
          
          // Close mobile menu
          document.getElementById('sidebar').classList.remove('mobile-open');
          
          // Section-specific initialization
          switch(sectionId) {
              case 'dashboard':
                  updateDashboard();
                  break;
              case 'sources':
                  loadSourcesTable();
                  break;
              case 'members':
                  if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
                      loadMembersTable();
                  }
                  break;
              case 'circulation':
                  loadActiveBorrowings();
                  break;
              case 'settings':
                  if (['admin', 'supervisor'].includes(currentUser.role)) {
                      loadSettings();
                      updateSettingsStats();
                  }
                  break;
          }
      }

      function toggleMobileMenu() {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.toggle('mobile-open');
      }

      function updateLibraryType() {
          const bibInput = document.querySelector('input[name="bibNumber"]');
          const librarySelect = document.getElementById('librarySelect');
          
          if (bibInput && librarySelect && bibInput.value) {
              const libraryType = Utils.getLibraryTypeFromBib(bibInput.value);
              if (libraryType.type !== 'unknown') {
                  librarySelect.value = libraryType.name;
              }
          }
      }

      // Additional Functions
      function renewBorrowing(borrowingId) {
          const borrowing = DATA.borrowings.find(b => b.id === borrowingId);
          if (!borrowing) {
              Utils.showAlert('الإعارة غير موجودة!', 'danger');
              return;
          }
          
          if (confirm('هل تريد تجديد فترة الإعارة حتى نهاية اليوم التالي؟')) {
              // Extend until end of next day
              const newDueDate = Utils.getEndOfDay(new Date(new Date().getTime() + 24 * 60 * 60 * 1000));
              
              borrowing.dueDate = newDueDate.toISOString();
              borrowing.renewed = true;
              borrowing.renewDate = new Date().toISOString();
              borrowing.renewEmployeeName = currentUser.name;
              
              Storage.save();
              loadActiveBorrowings();
              updateDashboard();
              
              Utils.showAlert('تم تجديد الإعارة حتى نهاية اليوم التالي بنجاح!', 'success');
          }
      }

      function quickReturn(borrowingId) {
          const borrowing = DATA.borrowings.find(b => b.id === borrowingId);
          if (!borrowing) {
              Utils.showAlert('الإعارة غير موجودة!', 'danger');
              return;
          }
          
          const source = DATA.sources.find(s => s.id === borrowing.sourceId);
          if (!source) {
              Utils.showAlert('المصدر غير موجود!', 'danger');
              return;
          }
          
          if (confirm('هل تريد إرجاع هذا المصدر؟')) {
              borrowing.returned = true;
              borrowing.returnDate = new Date().toISOString();
              borrowing.returnEmployeeName = currentUser.name;
              
              // Update source status if needed
              const remainingBorrowings = DATA.borrowings.filter(b => 
                  b.sourceId === source.id && !b.returned
              ).length;
              
              if (remainingBorrowings === 0 && Utils.isBorrowable(source)) {
                  source.status = 'متاح';
              }
              
              Storage.save();
              Utils.showAlert('تم إرجاع المصدر بنجاح!', 'success');
              
              loadActiveBorrowings();
              updateDashboard();
          }
      }

      // Initialize System
      function initializeSystem() {
          updateDashboard();
          loadSourcesTable();
          if (['admin', 'supervisor', 'manager'].includes(currentUser.role)) {
              loadMembersTable();
              loadSettings();
          }
          loadActiveBorrowings();
          
          // Set member barcode to current user and make it readonly
          const memberBarcodeInput = document.getElementById('memberBarcode');
          if (memberBarcodeInput && currentUser.membershipNumber) {
              memberBarcodeInput.value = currentUser.membershipNumber;
              memberBarcodeInput.setAttribute('readonly', true);
              setTimeout(() => {
                  loadMemberInfo();
              }, 500);
          }
      }

      // Global event listeners and initialization
      document.addEventListener('DOMContentLoaded', function() {
          // Set default dates for reports
          const today = new Date();
          const lastWeek = new Date();
          lastWeek.setDate(today.getDate() - 7);
          
          const reportStartDate = document.getElementById('reportStartDate');
          const reportEndDate = document.getElementById('reportEndDate');
          
          if (reportStartDate) reportStartDate.value = lastWeek.toISOString().split('T')[0];
          if (reportEndDate) reportEndDate.value = today.toISOString().split('T')[0];

          // Auto-focus and selection for barcode inputs
          document.getElementById('sourceBarcode')?.addEventListener('focus', function() {
              this.select();
          });

          // Auto-detect library type based on BIB number
          const bibInput = document.querySelector('input[name="bibNumber"]');
          if (bibInput) {
              bibInput.addEventListener('input', updateLibraryType);
          }

          // Load data and check authentication
          Storage.load();
          if (!currentUser.authenticated) {
              document.getElementById('loginModal').style.display = 'flex';
          } else {
              initializeSystem();
          }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
          if (window.innerWidth <= 768) {
              const sidebar = document.getElementById('sidebar');
              if (e.target.closest('.sidebar') === null && e.target.closest('.mobile-menu-btn') === null) {
                  sidebar.classList.remove('mobile-open');
              }
          }
          
          if (e.ctrlKey && e.key === 'e') {
              e.preventDefault();
              exportCurrentPageData();
          }
          
          if (e.ctrlKey && e.key === 'f' && document.getElementById('sources').classList.contains('active')) {
              e.preventDefault();
              document.getElementById('sourceSearch').focus();
          }
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', function(e) {
          if (window.innerWidth <= 768) {
              const sidebar = document.getElementById('sidebar');
              const mobileMenuBtn = e.target.closest('.mobile-menu-btn');
              const sidebarContent = e.target.closest('.sidebar');
              
              if (!mobileMenuBtn && !sidebarContent && sidebar.classList.contains('mobile-open')) {
                  sidebar.classList.remove('mobile-open');
              }
          }
      });

      // Close modals when clicking outside
      document.addEventListener('click', function(e) {
          // Close edit modals when clicking outside
          if (e.target.classList.contains('edit-modal')) {
              e.target.classList.remove('active');
          }
          
          // Close delete confirmation modal when clicking outside
          if (e.target.classList.contains('delete-confirmation-modal')) {
              closeDeleteConfirmationModal();
          }
      });

      // Global validation functions
      function validateBibNumber(input) {
          return Utils.validateBibNumber(input);
      }
  </script>
</body>
</html> 
